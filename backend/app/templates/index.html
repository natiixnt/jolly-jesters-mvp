<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MVP: import i analiza produktów | Jolly Jesters</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1224;
      --panel: #0f172a;
      --panel-2: #0b1327;
      --accent: #22d3ee;
      --accent-2: #10b981;
      --text: #e5e7eb;
      --muted: #93a4c1;
      --border: #1f2937;
      --danger: #f87171;
      --success: #34d399;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Space Grotesk', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 20% 20%, rgba(34, 211, 238, 0.12), transparent 32%),
        radial-gradient(circle at 80% 0%, rgba(16, 185, 129, 0.12), transparent 28%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 16px 48px;
    }
    .shell {
      position: relative;
      max-width: 1200px;
      margin: 0 auto;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 80px rgba(0,0,0,0.35);
    }
    .top {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    h1 { margin: 0; font-size: 30px; letter-spacing: -0.02em; }
    p.lead { color: var(--muted); margin: 6px 0 0; }
    .ghost-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 14px;
      border-radius: 10px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s, transform 0.2s;
    }
    .ghost-btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-1px); }
    .action-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: linear-gradient(120deg, var(--accent-2), var(--accent));
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .action-btn:hover { transform: translateY(-1px); box-shadow: 0 12px 30px rgba(34,211,238,0.25); }
    .action-btn.secondary {
      background: #0b152b;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      box-shadow: none;
    }
    .action-btn.secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
    }
    .button-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .layout {
      margin-top: 20px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      align-items: start;
    }
    .layout.sidebar-collapsed {
      grid-template-columns: 1fr;
    }
    @media (max-width: 960px) {
      .layout,
      .layout.sidebar-collapsed { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 18px;
    }
    form { display: grid; gap: 16px; }
    label { font-weight: 700; font-size: 13px; letter-spacing: 0.01em; color: var(--muted); text-transform: uppercase; }
    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 800;
      font-size: 16px;
      padding: 2px 6px;
      line-height: 1;
      position: relative;
      top: -1px;
      border-radius: 999px;
      cursor: pointer;
      transition: background-color 0.15s ease, color 0.15s ease;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.12); color: var(--text); }
    select, input[type="file"], .modes, .checkboxes, input[type="number"], input[type="text"] {
      width: 100%;
      background: #0b152b;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      color: var(--text);
    }
    input[type="datetime-local"] {
      width: 100%;
      background: #0b152b;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--text);
    }
    select {
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position:
        calc(100% - 28px) center,
        calc(100% - 20px) center;
      background-size: 6px 6px,
                      6px 6px;
      background-repeat: no-repeat;
      padding-right: 48px;
    }
    input[type="file"], input[type="number"], input[type="text"] { appearance: auto; background-image: none; padding-right: 14px; }
    .helper { color: var(--muted); font-size: 13px; margin-top: 4px; }
    .modes { display: flex; gap: 10px; padding: 0; border: none; background: transparent; }
    .mode {
      flex: 1;
      border: 1px solid var(--border);
      background: #0b152b;
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.2s;
    }
    .mode input { accent-color: var(--accent); }
    .mode:hover { border-color: var(--accent); transform: translateY(-1px); }
    .checkboxes { display: grid; gap: 10px; padding: 12px; }
    .checkboxes label { text-transform: none; color: var(--text); font-size: 15px; letter-spacing: 0; }
    .primary-btn {
      background: linear-gradient(120deg, var(--accent-2), var(--accent));
      color: #fff;
      border: none;
      padding: 14px 18px;
      border-radius: 12px;
      font-weight: 800;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s;
      box-shadow: 0 14px 40px rgba(16, 185, 129, 0.35);
    }
    .primary-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .primary-btn:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 16px 40px rgba(34, 211, 238, 0.3); }
    .status-panel {
      margin-top: 18px;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      background: #0b1327;
      display: none;
    }
    .status-row { display: flex; gap: 8px; margin-top: 6px; color: var(--muted); font-size: 14px; align-items: center; }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(34, 211, 238, 0.12);
      border: 1px solid rgba(34, 211, 238, 0.4);
      padding: 8px 12px;
      border-radius: 999px;
      color: var(--text);
      font-weight: 700;
      letter-spacing: 0.01em;
    }
    .muted { color: var(--muted); }
    a.download {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      color: var(--accent-2);
      text-decoration: none;
      font-weight: 700;
    }
    .error { color: var(--danger); margin-top: 8px; font-weight: 700; }
    .success { color: var(--success); margin-top: 6px; }
    .progress {
      width: 100%;
      background: #0b0f1f;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      height: 12px;
      margin-top: 8px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(120deg, var(--accent-2), var(--accent));
      width: 0%;
      transition: width 0.4s ease;
    }
    .section-title { margin: 0 0 8px; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
    .sidebar {
      transition: max-width 0.2s ease, width 0.2s ease, opacity 0.2s;
    }
    .sidebar.collapsed {
      display: none;
    }
    .sidebar-toggle {
      cursor: pointer;
      border: 1px solid var(--border);
      background: #0b152b;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .sidebar-restore {
      position: absolute;
      right: 0;
      top: 110px;
      background: #0b152b;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 10px;
      border-radius: 12px 0 0 12px;
      cursor: pointer;
      display: none;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 12px;
      letter-spacing: 0.05em;
    }
    .history-card {
      margin-top: 16px;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .history-list {
      margin-top: 10px;
      display: grid;
      gap: 10px;
    }
    .history-entry {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #0b152b;
      overflow: hidden;
    }
    .history-row {
      padding: 12px;
      display: grid;
      grid-template-columns: 1.6fr 1.1fr 1fr 1fr 1fr;
      gap: 10px;
      align-items: center;
      cursor: pointer;
    }
    .history-row:hover { background: rgba(255,255,255,0.02); }
    .history-row .history-actions { display: flex; gap: 8px; align-items: center; justify-content: flex-end; flex-wrap: wrap; }
    @media (max-width: 900px) {
      .history-row { grid-template-columns: 1fr 1fr; }
    }
    .history-row small { color: var(--muted); display: block; }
    .history-detail {
      display: none;
      padding: 0 12px 12px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 14px;
    }
    .history-detail strong { color: var(--text); }
    .history-error-line { color: var(--danger); margin-top: 6px; }
    .history-error-chip {
      background: rgba(239,68,68,0.15);
      color: var(--danger);
      padding: 4px 8px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 12px;
    }
    .badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      color: #fff;
      display: inline-block;
    }
    .badge.pending { background: #f59e0b; }
    .badge.running { background: #22d3ee; }
    .badge.completed { background: #10b981; }
    .badge.failed { background: #ef4444; }
    .ghost-btn--small { padding: 8px 10px; font-size: 13px; }
    .results-table {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .results-table table { width: 100%; border-collapse: collapse; }
    .results-table th, .results-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
    .results-table tbody tr:hover { background: rgba(255,255,255,0.02); cursor: pointer; }
    .results-detail { background: #0b152b; color: var(--muted); }
    .results-pagination {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .results-meta { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 6px; }
    .status-chip {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-block;
    }
    .status-chip.ok { background: rgba(16,185,129,0.2); color: #a7f3d0; }
    .status-chip.error { background: rgba(239,68,68,0.15); color: var(--danger); }
    .status-chip.not_found { background: rgba(245,158,11,0.15); color: #fbbf24; }
    .source-chip {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(34,211,238,0.12);
      color: var(--text);
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .detail-grid { display: grid; gap: 8px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
    .results-empty { color: var(--muted); margin-top: 12px; }
    .currency-row { display: flex; gap: 8px; align-items: center; margin-top: 6px; }
    .currency-row input { flex: 1; }
    .currency-row input.currency-code { max-width: 90px; }
    .currency-row input.currency-rate { max-width: 160px; }
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55);
      padding: 20px;
      z-index: 1100;
    }
    .results-modal .modal-content {
      max-width: 1100px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
    }
    .modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 480px;
      width: 100%;
      padding: 20px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      justify-content: flex-end;
    }
    .close-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    .faq-modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55);
      padding: 20px;
      z-index: 1000;
    }
    .faq-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 720px;
      width: 100%;
      padding: 20px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .faq-content h2 { margin-top: 0; }
    .faq-item { margin-top: 12px; }
    .faq-item strong { display: block; margin-bottom: 4px; }
  </style>
</head>
<body>
  <div class="shell">
    <button class="sidebar-restore" id="sidebar-restore">Panel</button>
    <div class="top">
      <div>
        <h1>MVP: import i analiza produktów</h1>
        <p class="lead">MVP analizy opłacalności Allegro. Wgraj plik, wybierz kategorię i strategię scrapera.</p>
      </div>
        <button class="ghost-btn" id="faq-btn">FAQ / pomoc</button>
    </div>

    <div class="layout" id="layout">
      <div class="card main-card" id="main-card">
        <form id="upload-form">
          <div>
            <label for="category-select" style="display:flex; align-items:center; gap:8px;">
              <span>Kategoria</span>
              <button type="button" class="icon-btn" id="main-add-category" title="Dodaj nową kategorię">+</button>
            </label>
            <select id="category-select" name="category_id" required></select>
            <div class="helper" id="category-info"></div>
          </div>
          <div>
            <label for="file-input">Plik (CSV/XLSX)</label>
            <input id="file-input" type="file" name="file" accept=".xlsx,.xls,.csv" required />
            <div class="helper">Obsługiwane formaty: .xlsx, .xls, .csv</div>
          </div>
          <div>
            <label>Tryb analizy</label>
            <div class="modes">
              <label class="mode">
                <input type="radio" name="mode" value="mixed" checked />
                <div>
                  <div><strong>MIXED</strong></div>
                  <div class="muted">OFFLINE + odświeżenie, gdy dane są stare</div>
                </div>
              </label>
              <label class="mode">
                <input type="radio" name="mode" value="offline" />
                <div>
                  <div><strong>OFFLINE</strong></div>
                  <div class="muted">Bez scrapingu, tylko dane z bazy</div>
                </div>
              </label>
              <label class="mode">
                <input type="radio" name="mode" value="online" />
                <div>
                  <div><strong>ONLINE</strong></div>
                  <div class="muted">Pomijaj cache, zawsze scrapuj na nowo</div>
                </div>
              </label>
            </div>
          </div>
          <div>
            <label>Strategie scrapera</label>
            <div class="checkboxes" id="strategy-boxes">
              <label><input type="checkbox" name="use_api" value="true" checked /> Użyj Allegro API</label>
              <label><input type="checkbox" name="use_cloud_http" value="true" checked /> Użyj cloud HTTP (proxy)</label>
              <label><input type="checkbox" name="use_local_scraper" value="true" checked /> Użyj lokalnego Selenium</label>
            </div>
            <div class="error" id="strategy-error"></div>
          </div>
          <div>
            <button type="submit" id="submit-btn" class="primary-btn">Start analizy</button>
          </div>
          <div class="error" id="error"></div>
        </form>

        <div class="status-panel" id="status-panel">
          <div class="pill">Run ID: <span id="run-id"></span></div>
          <div class="status-row"><strong>Status:</strong> <span id="run-status"></span></div>
          <div class="status-row"><strong>Postęp:</strong> <span id="run-progress"></span></div>
          <div class="progress"><div class="progress-bar" id="progress-bar"></div></div>
          <div class="status-row"><strong>Błąd:</strong> <span id="run-error" class="error"></span></div>
          <div id="report-links" style="display:none; margin-top:8px; gap:12px; align-items:center; flex-wrap:wrap;" class="button-row">
            <button class="action-btn" id="preview-link" type="button">Podgląd wyników</button>
            <a class="action-btn secondary" id="download-link" href="#">⬇ Pobierz raport</a>
          </div>
        </div>
      </div>

      <div class="card sidebar" id="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; position: relative;">
          <span style="font-weight:700;">Panel</span>
          <button class="sidebar-toggle" id="sidebar-toggle" title="Zwiń panel">«</button>
        </div>
        <div class="sidebar-content" style="display:grid; gap:18px;">
          <div>
            <h3 class="section-title">Ustawienia</h3>
            <div style="display:grid; gap:12px;">
              <div>
                <label for="local-windows">Liczba jednocześnie otwieranych okien lokalnego scrapera</label>
                <input type="number" id="local-windows" min="1" max="10" />
                <div class="helper" id="settings-info"></div>
                <button class="ghost-btn" id="save-windows-btn" style="margin-top:8px;">Zapisz ustawienia scrapera</button>
                <div class="success" id="settings-windows-success"></div>
              </div>
              <div>
                <label for="cache-ttl">TTL cache (dni)</label>
                <input type="number" id="cache-ttl" min="1" max="365" />
                <div class="helper">Po ilu dniach dane z Allegro uznajemy za przestarzałe</div>
                <button class="ghost-btn" id="save-ttl-btn" style="margin-top:8px;">Zapisz TTL cache</button>
                <div class="success" id="settings-ttl-success"></div>
              </div>
              <div>
                <label>Kursy walut (do PLN)</label>
                <div id="currency-list"></div>
                <div class="button-row" style="margin-top:8px;">
                  <button class="ghost-btn ghost-btn--small" type="button" id="add-currency-btn">Dodaj walutę</button>
                  <button class="action-btn" type="button" id="save-currencies-btn">Zapisz kursy</button>
                </div>
                <div class="helper" id="currency-helper"></div>
                <div class="success" id="currency-success"></div>
                <div class="error" id="currency-error"></div>
              </div>
              <div class="error" id="settings-error"></div>
            </div>
          </div>

          <div>
            <h3 class="section-title">Kategorie <button id="add-category-btn" class="ghost-btn">+</button></h3>
            <div class="helper" id="categories-list"></div>
            <div class="success" id="category-success"></div>
            <div class="error" id="category-error"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card history-card">
      <div class="history-header" id="history-toggle">
        <h3 class="section-title" style="margin:0;">Historia analiz</h3>
        <span id="history-caret" style="cursor:pointer;">▼</span>
      </div>
      <div class="history-list" id="history-list"></div>
      <div class="helper" id="history-empty" style="display:none;">Brak wcześniejszych analiz.</div>
      <div class="helper" id="history-error" style="display:none;">Nie udało się pobrać historii.</div>
    </div>

    <div class="card history-card">
      <div class="history-header">
        <h3 class="section-title" style="margin:0;">Baza Allegro (ostatnie dane rynkowe)</h3>
      </div>
      <div style="display:grid; gap:10px; margin-top:8px;">
        <div style="display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
          <div>
            <label for="market-category">Kategoria</label>
            <select id="market-category">
              <option value="">Dowolna</option>
            </select>
          </div>
          <div>
            <label for="market-ean">EAN</label>
            <input id="market-ean" type="text" placeholder="fragment EAN" />
          </div>
          <div>
            <label for="market-source">Źródło danych</label>
            <select id="market-source">
              <option value="">Dowolne</option>
              <option value="api">API</option>
              <option value="cloud_http">cloud_http</option>
              <option value="local">local</option>
              <option value="scraping">scraping</option>
            </select>
          </div>
          <div>
            <label for="market-date">Od kiedy</label>
            <input id="market-date" type="datetime-local" />
          </div>
        </div>
        <div class="button-row">
          <button class="action-btn" id="market-search">Szukaj</button>
          <button class="ghost-btn ghost-btn--small" id="market-reset">Reset</button>
        </div>
        <div id="market-error" class="error"></div>
        <div class="results-table" id="market-table"></div>
        <div class="results-pagination">
          <button class="ghost-btn ghost-btn--small" id="market-prev" type="button">◀ Wstecz</button>
          <span class="muted" id="market-page-info"></span>
          <button class="ghost-btn ghost-btn--small" id="market-next" type="button">Dalej ▶</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal results-modal" id="results-modal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
        <div>
          <h3 style="margin:0;">Podgląd wyników analizy</h3>
          <div class="results-meta" id="results-meta"></div>
        </div>
        <div class="modal-actions" style="margin-top:0;">
          <button class="close-btn" id="results-close">Zamknij</button>
        </div>
      </div>
      <div class="error" id="results-error"></div>
      <div class="results-empty" id="results-empty" style="display:none;"></div>
      <div class="results-table" id="results-table"></div>
      <div class="results-pagination">
        <button class="ghost-btn ghost-btn--small" id="results-prev" type="button">◀ Wstecz</button>
        <span class="muted" id="results-page-info"></span>
        <button class="ghost-btn ghost-btn--small" id="results-next" type="button">Dalej ▶</button>
      </div>
    </div>
  </div>

  <div class="modal" id="category-modal">
    <div class="modal-content">
      <h3 style="margin-top:0;">Dodaj nową kategorię</h3>
      <form id="category-modal-form">
        <div>
          <label for="modal-cat-name">Nazwa kategorii</label>
          <input type="text" id="modal-cat-name" name="name" required />
        </div>
        <div>
          <label for="modal-cat-multiplier">Mnożnik opłacalności</label>
          <input type="number" id="modal-cat-multiplier" name="profitability_multiplier" step="0.01" min="0" value="1.5" required />
        </div>
        <div>
          <label for="modal-cat-commission">Prowizja Allegro (%)</label>
          <input type="number" id="modal-cat-commission" name="commission_rate" step="0.01" min="0" value="0" />
        </div>
        <div class="error" id="category-modal-error"></div>
        <div class="modal-actions">
          <button type="button" class="close-btn" id="category-cancel">Anuluj</button>
          <button type="submit" class="primary-btn">Dodaj kategorię</button>
        </div>
      </form>
    </div>
  </div>

  <div class="modal" id="category-detail-modal">
    <div class="modal-content">
      <h3 style="margin-top:0;">Szczegóły kategorii</h3>
      <form id="category-detail-form">
        <div>
          <label for="detail-cat-name">Nazwa kategorii</label>
          <input type="text" id="detail-cat-name" name="name" required />
        </div>
        <div>
          <label for="detail-cat-multiplier">Mnożnik opłacalności</label>
          <input type="number" id="detail-cat-multiplier" name="profitability_multiplier" step="0.01" min="0" required />
        </div>
        <div>
          <label for="detail-cat-commission">Prowizja Allegro (%)</label>
          <input type="number" id="detail-cat-commission" name="commission_rate" step="0.01" min="0" />
        </div>
        <div class="error" id="category-detail-error"></div>
        <div class="success" id="category-detail-success"></div>
        <div class="modal-actions">
          <button type="button" class="close-btn" id="category-detail-cancel">Anuluj</button>
          <button type="submit" class="action-btn">Zapisz</button>
        </div>
      </form>
    </div>
  </div>

  <div class="faq-modal" id="faq-modal">
    <div class="faq-content">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
        <h2>FAQ - jak korzystać z systemu</h2>
        <button class="close-btn" id="faq-close">Zamknij</button>
      </div>
      <div class="faq-item">
        <strong>Różnice między trybami MIXED, OFFLINE, ONLINE</strong>
        <div>MIXED – używa cache, ale odświeża gdy dane są starsze niż TTL. OFFLINE – korzysta wyłącznie z danych z bazy. ONLINE – ignoruje cache i zawsze scrapuje na nowo.</div>
      </div>
      <div class="faq-item">
        <strong>Strategie scrapera (API / cloud HTTP / lokalne Selenium)</strong>
        <div>Zaznacz co najmniej jedną. API – szybkie jeśli masz token. Cloud HTTP – scraping przez proxy. Lokalny Selenium – fallback z przeglądarką.</div>
      </div>
      <div class="faq-item">
        <strong>Jak dodać nową kategorię</strong>
        <div>Użyj przycisku „+” w sekcji Kategorie i wypełnij formularz.</div>
      </div>
      <div class="faq-item">
        <strong>Jakie pliki są obsługiwane</strong>
        <div>CSV, XLS, XLSX. Wymagane kolumny: EAN, Name, PurchasePrice.</div>
      </div>
      <div class="faq-item">
        <strong>Co zrobić, gdy analiza kończy się błędem</strong>
        <div>Sprawdź komunikat w sekcji statusu. Upewnij się, że co najmniej jedna strategia scrapera jest włączona i że kategoria jest aktywna.</div>
      </div>
      <div class="faq-item">
        <strong>Co oznaczają pola kategorii: nazwa, mnożnik opłacalności i prowizja Allegro?</strong>
        <div>
          <div><em>Nazwa kategorii</em> – dowolna nazwa, która pozwala Ci rozpoznać grupę produktów, np. „Perfumy”, „Chemia gospodarcza”, „Zabawki”.</div>
          <div><em>Mnożnik opłacalności</em> – minimalny docelowy zwrot z inwestycji (marża względem ceny zakupu). Przykład: jeżeli ustawisz mnożnik 1,5, to system oznaczy produkt jako „opłacalny” tylko wtedy, gdy po odjęciu prowizji Allegro zarobek będzie co najmniej 50% ceny zakupu.</div>
          <div><em>Prowizja Allegro (%)</em> – szacowany procent prowizji Allegro w danej kategorii. System odejmuje tę prowizję od ceny sprzedaży i dopiero z tej „netto” ceny liczy marżę.</div>
          <div>Dzięki temu opłacalność jest liczona dla każdej kategorii inaczej – np. jeśli w jednej kategorii prowizja jest wyższa, próg opłacalności jest automatycznie bardziej wymagający. Każda analiza jest powiązana z jedną kategorią, a każda kategoria ma własne parametry, więc możesz osobno ustawić logikę dla „Perfum” vs „Chemii” itp.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const categorySelect = document.getElementById('category-select');
    const categoryInfo = document.getElementById('category-info');
    const categoriesList = document.getElementById('categories-list');
    const form = document.getElementById('upload-form');
    const errorBox = document.getElementById('error');
    const strategyError = document.getElementById('strategy-error');
    const submitBtn = document.getElementById('submit-btn');
    const panel = document.getElementById('status-panel');
    const runIdEl = document.getElementById('run-id');
    const runStatusEl = document.getElementById('run-status');
    const runProgressEl = document.getElementById('run-progress');
    const runErrorEl = document.getElementById('run-error');
    const progressBar = document.getElementById('progress-bar');
    const downloadLink = document.getElementById('download-link');
    const reportLinks = document.getElementById('report-links');
    const localWindowsInput = document.getElementById('local-windows');
    const cacheTtlInput = document.getElementById('cache-ttl');
    const settingsInfo = document.getElementById('settings-info');
    const settingsError = document.getElementById('settings-error');
    const settingsWindowsSuccess = document.getElementById('settings-windows-success');
    const settingsTtlSuccess = document.getElementById('settings-ttl-success');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const categoryModal = document.getElementById('category-modal');
    const categoryModalForm = document.getElementById('category-modal-form');
    const categoryModalError = document.getElementById('category-modal-error');
    const categorySuccess = document.getElementById('category-success');
    const categoryError = document.getElementById('category-error');
    const categoryCancel = document.getElementById('category-cancel');
    const categoryDetailModal = document.getElementById('category-detail-modal');
    const categoryDetailForm = document.getElementById('category-detail-form');
    const categoryDetailError = document.getElementById('category-detail-error');
    const categoryDetailSuccess = document.getElementById('category-detail-success');
    const categoryDetailCancel = document.getElementById('category-detail-cancel');
    const currencyList = document.getElementById('currency-list');
    const addCurrencyBtn = document.getElementById('add-currency-btn');
    const saveCurrenciesBtn = document.getElementById('save-currencies-btn');
    const currencyHelper = document.getElementById('currency-helper');
    const currencyError = document.getElementById('currency-error');
    const currencySuccess = document.getElementById('currency-success');
    const faqModal = document.getElementById('faq-modal');
    const faqBtn = document.getElementById('faq-btn');
    const faqClose = document.getElementById('faq-close');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarRestore = document.getElementById('sidebar-restore');
    const layout = document.getElementById('layout');
    const historyList = document.getElementById('history-list');
    const historyEmpty = document.getElementById('history-empty');
    const historyError = document.getElementById('history-error');
    const historyToggle = document.getElementById('history-toggle');
    const historyCaret = document.getElementById('history-caret');
    const previewBtn = document.getElementById('preview-link');
    const resultsModal = document.getElementById('results-modal');
    const resultsClose = document.getElementById('results-close');
    const resultsTable = document.getElementById('results-table');
    const resultsMeta = document.getElementById('results-meta');
    const resultsError = document.getElementById('results-error');
    const resultsEmpty = document.getElementById('results-empty');
    const resultsPageInfo = document.getElementById('results-page-info');
    const resultsPrev = document.getElementById('results-prev');
    const resultsNext = document.getElementById('results-next');
    const marketCategory = document.getElementById('market-category');
    const marketEan = document.getElementById('market-ean');
    const marketSource = document.getElementById('market-source');
    const marketDate = document.getElementById('market-date');
    const marketTable = document.getElementById('market-table');
    const marketError = document.getElementById('market-error');
    const marketPageInfo = document.getElementById('market-page-info');
    const marketPrev = document.getElementById('market-prev');
    const marketNext = document.getElementById('market-next');
    const marketSearch = document.getElementById('market-search');
    const marketReset = document.getElementById('market-reset');
    let historyExpanded = true;
    let pollTimer = null;
    let previewState = { runId: null, offset: 0, limit: 50, total: 0 };
    let categoriesCache = [];
    let categoryDetailId = null;
    let marketState = { offset: 0, limit: 50, total: 0 };

    function setMessage(msg, target) {
      target.textContent = msg || '';
    }

    function briefSuccess(target) {
      target.textContent = 'Zapisano';
      setTimeout(() => { target.textContent = ''; }, 2000);
    }

    function formatDateTime(value) {
      if (!value) return '-';
      try {
        return new Date(value).toLocaleString();
      } catch (err) {
        return String(value);
      }
    }

    function formatMoney(value) {
      if (value === null || value === undefined) return '—';
      const num = Number(value);
      if (Number.isNaN(num)) return '—';
      return `${num.toFixed(2)} zł`;
    }

    function formatPercent(value) {
      if (value === null || value === undefined) return '—';
      const num = Number(value);
      if (Number.isNaN(num)) return '—';
      return `${num.toFixed(1)}%`;
    }

    function renderCurrencyRows(rates) {
      currencyList.innerHTML = '';
      rates.forEach((r, idx) => {
        const row = document.createElement('div');
        row.className = 'currency-row';
        row.innerHTML = `
          <button type="button" class="ghost-btn ghost-btn--small" data-default="${idx}" title="Ustaw jako domyślną">
            ${r.is_default ? '★' : '☆'}
          </button>
          <input class="currency-code" data-idx="${idx}" value="${r.currency}" />
          <input class="currency-rate" data-idx="${idx}" type="number" step="0.0001" min="0" value="${r.rate_to_pln}" />
          <button type="button" class="ghost-btn ghost-btn--small" data-remove="${idx}">Usuń</button>
        `;
        currencyList.appendChild(row);
      });
    }

    function readCurrencyPayload() {
      const codes = Array.from(currencyList.querySelectorAll('input.currency-code')).map(el => el.value.trim().toUpperCase());
      const rates = Array.from(currencyList.querySelectorAll('input.currency-rate')).map(el => parseFloat(el.value));
      const defaults = Array.from(currencyList.querySelectorAll('[data-default]')).map((btn) => btn.textContent === '★');
      const payload = [];
      codes.forEach((code, idx) => {
        if (!code) return;
        payload.push({ currency: code, rate_to_pln: rates[idx], is_default: defaults[idx] || false });
      });
      return payload;
    }

    async function loadCurrencyRates() {
      currencyError.textContent = '';
      currencySuccess.textContent = '';
      try {
        const res = await fetch('/api/v1/settings/currencies');
        const data = await res.json();
        if (!res.ok) throw new Error(data.detail || 'Nie udało się pobrać kursów.');
        renderCurrencyRows(data.rates || []);
        currencyHelper.textContent = 'PLN musi mieć kurs 1.0. Dodaj inne waluty, aby były przeliczane na PLN.';
      } catch (err) {
        currencyError.textContent = err.message || 'Błąd pobierania kursów.';
      }
    }

    async function saveCurrencyRates() {
      currencyError.textContent = '';
      currencySuccess.textContent = '';
      const payload = { rates: readCurrencyPayload() };
      try {
        const res = await fetch('/api/v1/settings/currencies', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        let data = {};
        const contentType = res.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          data = await res.json().catch(() => ({}));
        }
        if (!res.ok) {
          const detail = (data && data.detail) || 'Nie udało się zapisać kursów.';
          throw new Error(detail);
        }
        renderCurrencyRows(data.rates || []);
        currencySuccess.textContent = 'Zapisano kursy walut.';
        setTimeout(() => { currencySuccess.textContent = ''; }, 2000);
      } catch (err) {
        currencyError.textContent = err.message || 'Błąd zapisu kursów.';
      }
    }

    function renderStrategies(run) {
      const strategies = [];
      if (run.use_api) strategies.push('API');
      if (run.use_cloud_http) strategies.push('HTTP');
      if (run.use_local_scraper) strategies.push('Selenium');
      return strategies.length ? strategies.join(' · ') : 'Brak danych';
    }

    function renderMarketTable(data) {
      if (!data.items || !data.items.length) {
        marketTable.innerHTML = '<div class="helper">Brak danych do wyświetlenia.</div>';
      } else {
        const rows = data.items.map((item) => `
          <tr>
            <td>${item.ean || '—'}</td>
            <td>${item.name || '—'}</td>
            <td>${item.category_name || '—'}</td>
            <td>${formatMoney(item.purchase_price_pln)}</td>
            <td>${formatMoney(item.allegro_price_pln)}</td>
            <td>${item.sold_count ?? '—'}</td>
            <td>${item.source || '—'}</td>
            <td>${formatDateTime(item.last_checked_at)}</td>
            <td>${item.last_run_id ?? '—'}</td>
          </tr>
        `).join('');
        marketTable.innerHTML = `
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>EAN</th>
                  <th>Nazwa</th>
                  <th>Kategoria</th>
                  <th>Cena zakupu (PLN)</th>
                  <th>Cena Allegro</th>
                  <th>Sprzedanych</th>
                  <th>Źródło</th>
                  <th>Ostatnio sprawdzono</th>
                  <th>Ostatni run</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
      }

      const start = data.total ? Math.min(data.total, marketState.offset + 1) : 0;
      const end = data.total ? Math.min(data.total, marketState.offset + marketState.limit) : (data.items?.length || 0);
      marketPageInfo.textContent = data.total ? `${start}-${end} z ${data.total}` : `${end} wierszy`;
      marketPrev.disabled = marketState.offset <= 0;
      marketNext.disabled = marketState.offset + marketState.limit >= (data.total || 0);
    }

    function scrapeStatusLabel(status) {
      if (status === 'error') return 'błąd';
      if (status === 'not_found') return 'brak';
      return 'ok';
    }

    function renderResultsTable(data) {
      resultsError.textContent = data.error_message || '';
      const metaParts = [`Run #${data.run_id}`, `Status: ${data.status}`];
      if (typeof data.total === 'number') metaParts.push(`Wiersze: ${data.total}`);
      resultsMeta.textContent = metaParts.join(' · ');

      if (!data.items || !data.items.length) {
        resultsTable.innerHTML = '';
        resultsEmpty.style.display = 'block';
        if (data.status === 'failed') {
          resultsEmpty.textContent = data.error_message || 'Analiza przerwana, brak danych do wyświetlenia.';
        } else {
          resultsEmpty.textContent = data.error_message || 'Brak danych do wyświetlenia.';
        }
      } else {
        resultsEmpty.style.display = 'none';
        const rows = data.items.map((item, idx) => {
          const profitableLabel = item.is_profitable === true ? 'tak' : item.is_profitable === false ? 'nie' : '—';
          const scrapeStatus = item.scrape_status || 'ok';
          const statusLabel = scrapeStatusLabel(scrapeStatus);
          return `
            <tr data-row="${idx}">
              <td>${item.ean || '—'}</td>
              <td>${item.name || '—'}</td>
              <td>${item.original_currency || 'PLN'}</td>
              <td>${formatMoney(item.purchase_price_pln)}</td>
              <td>${formatMoney(item.allegro_price_pln)}</td>
              <td>${formatMoney(item.margin_pln)}</td>
              <td>${formatPercent(item.margin_percent)}</td>
              <td>${profitableLabel}</td>
              <td>${item.source ? `<span class="source-chip">${item.source}</span>` : '—'}</td>
              <td>${formatDateTime(item.last_checked_at)}</td>
              <td><span class="status-chip ${scrapeStatus}">${statusLabel}</span></td>
            </tr>
            <tr class="results-detail" data-detail="${idx}" style="display:none;">
              <td colspan="11">
                <div class="detail-grid">
                  <div><strong>Źródło:</strong> ${item.source || '—'}</div>
                  <div><strong>Status scrapingu:</strong> ${statusLabel}</div>
                  <div><strong>Ostatnio sprawdzono:</strong> ${formatDateTime(item.last_checked_at)}</div>
                  <div><strong>Błąd scrapingu:</strong> ${item.scrape_error_message || '—'}</div>
                  <div><strong>Oryginalna waluta:</strong> ${item.original_currency || 'PLN'}</div>
                  <div><strong>Oryginalna cena:</strong> ${item.original_purchase_price !== null && item.original_purchase_price !== undefined ? item.original_purchase_price + ' ' + (item.original_currency || '') : '—'}</div>
                  <div><strong>Liczba sprzedanych:</strong> ${item.sold_count ?? '—'}</div>
                </div>
              </td>
            </tr>
          `;
        }).join('');
        resultsTable.innerHTML = `
          <div style="overflow:auto; max-height:60vh;">
            <table>
              <thead>
                <tr>
                  <th>EAN</th>
                  <th>Nazwa</th>
                  <th>Waluta</th>
                  <th>Cena zakupu</th>
                  <th>Cena Allegro</th>
                  <th>Marża</th>
                  <th>Marża %</th>
                  <th>Opłacalny</th>
                  <th>Źródło</th>
                  <th>Ostatnio sprawdzono</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
        resultsTable.querySelectorAll('tr[data-row]').forEach((row) => {
          row.addEventListener('click', () => {
            const idx = row.getAttribute('data-row');
            const detail = resultsTable.querySelector(`tr[data-detail="${idx}"]`);
            if (detail) {
              const isVisible = detail.style.display === 'table-row';
              detail.style.display = isVisible ? 'none' : 'table-row';
            }
          });
        });
      }

      const start = previewState.total ? Math.min(previewState.total, previewState.offset + 1) : 0;
      const end = previewState.total ? Math.min(previewState.total, previewState.offset + previewState.limit) : (data.items?.length || 0);
      resultsPageInfo.textContent = previewState.total ? `${start}-${end} z ${previewState.total}` : `${end} wierszy`;
      resultsPrev.disabled = previewState.offset <= 0;
      resultsNext.disabled = previewState.offset + previewState.limit >= (previewState.total || 0);
    }

    async function loadResults(runId, offset = 0) {
      if (!runId) return;
      resultsError.textContent = '';
      resultsEmpty.style.display = 'none';
      resultsTable.innerHTML = '<div class="helper">Ładowanie wyników...</div>';
      try {
        const res = await fetch(`/api/v1/analysis/${runId}/results?offset=${offset}&limit=${previewState.limit}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          resultsError.textContent = data.detail || 'Nie udało się pobrać wyników.';
          resultsTable.innerHTML = '';
          resultsPageInfo.textContent = '';
          resultsPrev.disabled = true;
          resultsNext.disabled = true;
          return;
        }
        previewState.runId = runId;
        previewState.offset = offset;
        previewState.total = data.total || 0;
        renderResultsTable(data);
      } catch (err) {
        resultsError.textContent = err.message || 'Błąd podczas pobierania wyników.';
        resultsTable.innerHTML = '';
      }
    }

    function openResultsModal(runId) {
      if (!runId) return;
      resultsModal.style.display = 'flex';
      loadResults(runId, 0);
    }

    function closeResultsModal() {
      resultsModal.style.display = 'none';
    }

    function populateMarketCategories() {
      const current = marketCategory.value;
      marketCategory.innerHTML = '<option value=\"\">Dowolna</option>';
      categoriesCache.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.name;
        if (cat.id === current) opt.selected = true;
        marketCategory.appendChild(opt);
      });
    }

    async function loadMarketData(offset = 0) {
      marketError.textContent = '';
      marketTable.innerHTML = '<div class="helper">Ładowanie...</div>';
      const params = new URLSearchParams();
      if (marketCategory.value) params.append('category_id', marketCategory.value);
      if (marketEan.value) params.append('ean', marketEan.value);
      if (marketSource.value) params.append('source', marketSource.value);
      if (marketDate.value) params.append('updated_since', marketDate.value);
      params.append('offset', String(offset));
      params.append('limit', String(marketState.limit));
      try {
        const res = await fetch(`/api/v1/market-data?${params.toString()}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || 'Nie udało się pobrać danych.');
        marketState.offset = offset;
        marketState.total = data.total || 0;
        renderMarketTable(data);
      } catch (err) {
        marketError.textContent = err.message || 'Błąd pobierania danych.';
        marketTable.innerHTML = '';
      }
    }

    function renderCategoriesList() {
      if (!categoriesCache.length) {
        categoriesList.textContent = '';
        return;
      }
      categoriesList.innerHTML = '';
      categoriesCache.forEach(cat => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ghost-btn ghost-btn--small';
        btn.textContent = cat.name;
        btn.style.marginRight = '8px';
        btn.addEventListener('click', () => openCategoryDetail(cat.id));
        categoriesList.appendChild(btn);
      });
    }

    async function loadCategories() {
      try {
        const res = await fetch('/api/v1/categories/');
        if (!res.ok) throw new Error('Nie udało się pobrać kategorii.');
        const data = await res.json();
        categoriesCache = data;
        if (!data.length) {
          categorySelect.innerHTML = '';
          categorySelect.disabled = true;
          submitBtn.disabled = true;
          categoryInfo.textContent = 'Brak aktywnych kategorii. Dodaj kategorię w sekcji „Kategorie” poniżej.';
          categoriesList.textContent = '';
          return;
        }
        categorySelect.innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        categorySelect.disabled = false;
        submitBtn.disabled = false;
        categoryInfo.textContent = '';
        renderCategoriesList();
        populateMarketCategories();
      } catch (err) {
        categoryInfo.textContent = err.message;
        submitBtn.disabled = true;
      }
    }

    function validateStrategies() {
      const boxes = Array.from(document.querySelectorAll('#strategy-boxes input[type="checkbox"]'));
      const checked = boxes.filter(b => b.checked);
      if (!checked.length) {
        setMessage('Włącz przynajmniej jedną strategię.', strategyError);
        return false;
      }
      setMessage('', strategyError);
      return true;
    }

    function setStatus(data) {
      runStatusEl.textContent = data.status;
      const processed = data.processed_products ?? 0;
      const total = data.total_products ?? 0;
      runProgressEl.textContent = `${processed}/${total}`;
      const pct = total > 0 ? Math.min(100, Math.round((processed / total) * 100)) : (data.status === 'completed' ? 100 : 0);
      progressBar.style.width = `${pct}%`;
      runErrorEl.textContent = data.error_message || '';
      const showDownload = data.status === 'completed';
      const showPreview = Boolean(data.id) && (data.status === 'completed' || data.status === 'failed' || processed > 0);
      if (showDownload) {
        const href = `/api/v1/analysis/${data.id}/download`;
        downloadLink.href = href;
      }
      downloadLink.style.display = showDownload ? 'inline-flex' : 'none';
      if (previewBtn) {
        previewBtn.dataset.runId = data.id || '';
        previewBtn.style.display = showPreview ? 'inline-flex' : 'none';
      }
      reportLinks.style.display = showDownload || showPreview ? 'flex' : 'none';
    }

    function stopPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
    }

    async function pollStatus(runId) {
      stopPolling();
      const fetchStatus = async () => {
        try {
          const res = await fetch(`/api/v1/analysis/${runId}`);
          if (!res.ok) throw new Error('Nie udało się pobrać statusu.');
          const data = await res.json();
          setStatus(data);

            if (data.status === 'completed' || data.status === 'failed') {
              if (data.status === 'failed') {
                runErrorEl.textContent = data.error_message || 'Analiza nie powiodła się.';
              }
              stopPolling();
              await loadHistory();
            }
          } catch (err) {
            setMessage(err.message, errorBox);
          }
        };
        await fetchStatus();
      pollTimer = setInterval(fetchStatus, 3000);
    }

    async function loadSettings() {
      try {
        const res = await fetch('/api/v1/settings/');
        if (!res.ok) throw new Error('Nie udało się pobrać ustawień.');
        const data = await res.json();
        cacheTtlInput.value = data.cache_ttl_days ?? 30;
        localWindowsInput.value = data.local_scraper_windows ?? 1;
        setMessage('', settingsInfo);
      } catch (err) {
        cacheTtlInput.value = cacheTtlInput.value || 30;
        localWindowsInput.value = localWindowsInput.value || 1;
        setMessage('Nie udało się pobrać ustawień. Używane są wartości domyślne.', settingsInfo);
      }
    }

    async function saveSettings(field) {
      setMessage('', settingsError);
      const payload = {
        cache_ttl_days: Number(cacheTtlInput.value) || 30,
        local_scraper_windows: Number(localWindowsInput.value) || 1,
      };
      try {
        const res = await fetch('/api/v1/settings/', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setMessage(data.detail || 'Nie udało się zapisać ustawień.', settingsError);
          return;
        }
        cacheTtlInput.value = data.cache_ttl_days;
        localWindowsInput.value = data.local_scraper_windows;
        if (field === 'windows') briefSuccess(settingsWindowsSuccess);
        if (field === 'ttl') briefSuccess(settingsTtlSuccess);
      } catch (err) {
        setMessage(err.message, settingsError);
      }
    }

    function createHistoryEntry(run) {
      const entry = document.createElement('div');
      entry.className = 'history-entry';
      const row = document.createElement('div');
      row.className = 'history-row';

      const created = formatDateTime(run.created_at || run.started_at);
      const finished = formatDateTime(run.finished_at);
      const modeLabel = (run.mode || '').toUpperCase() || '—';
      const finishedLabel = finished !== '-' ? finished : 'W toku / oczekuje';
      const statusBadge = `<span class="badge ${run.status}">${run.status}</span>`;
      const downloadLink = run.status === 'completed'
        ? `<a class="action-btn secondary" href="/api/v1/analysis/${run.id}/download">⬇ Pobierz raport</a>`
        : '';
      const errorChip = run.status === 'failed' ? '<span class="history-error-chip">Błąd</span>' : '';

      row.innerHTML = `
        <div><strong>${created}</strong><small>${finishedLabel}</small></div>
        <div><strong>${run.category_name || 'Kategoria usunięta'}</strong><small>Tryb: ${modeLabel}</small></div>
        <div><small>Strategie:</small> ${renderStrategies(run)}</div>
        <div><small>Postęp:</small> ${run.processed_products}/${run.total_products}</div>
        <div class="history-actions">
          ${statusBadge}
          ${errorChip}
          ${downloadLink ? `<div>${downloadLink}</div>` : ''}
        </div>
      `;

      const actionsEl = row.querySelector('.history-actions');
      if (actionsEl) {
        const previewButton = document.createElement('button');
        previewButton.type = 'button';
        previewButton.className = 'action-btn';
        previewButton.textContent = 'Podgląd';
        previewButton.addEventListener('click', (e) => {
          e.stopPropagation();
          openResultsModal(run.id);
        });
        actionsEl.prepend(previewButton);
      }

      const detail = document.createElement('div');
      detail.className = 'history-detail';
      const detailItems = [
        ['ID:', String(run.id)],
        ['Utworzono:', created],
        ['Zakończono:', finished !== '-' ? finished : '—'],
        ['Postęp:', `${run.processed_products}/${run.total_products}`],
      ];
      detailItems.forEach(([label, value]) => {
        const rowEl = document.createElement('div');
        const strong = document.createElement('strong');
        strong.textContent = label;
        rowEl.appendChild(strong);
        rowEl.append(` ${value}`);
        detail.appendChild(rowEl);
      });
      if (run.status === 'failed') {
        const errorLine = document.createElement('div');
        errorLine.className = 'history-error-line';
        const strong = document.createElement('strong');
        strong.textContent = 'Powód błędu:';
        errorLine.appendChild(strong);
        errorLine.append(` ${run.error_message || 'Brak szczegółów.'}`);
        detail.appendChild(errorLine);
      }

      row.addEventListener('click', (e) => {
        if (e.target.closest && e.target.closest('a, button')) {
          return;
        }
        const expanded = detail.style.display === 'block';
        detail.style.display = expanded ? 'none' : 'block';
      });

      entry.appendChild(row);
      entry.appendChild(detail);
      return entry;
    }

    async function loadHistory() {
      historyList.innerHTML = '';
      historyEmpty.style.display = 'none';
      historyError.style.display = 'none';

      try {
        const res = await fetch('/api/v1/analysis');
        if (!res.ok) throw new Error('Nie udało się pobrać historii.');
        const data = await res.json();
        if (!Array.isArray(data) || !data.length) {
          historyList.style.display = 'none';
          if (historyExpanded) {
            historyEmpty.textContent = 'Brak wcześniejszych analiz.';
            historyEmpty.style.display = 'block';
          }
          return;
        }

        data.forEach(run => {
          historyList.appendChild(createHistoryEntry(run));
        });

        historyList.style.display = historyExpanded ? 'grid' : 'none';
      } catch (err) {
        historyList.innerHTML = '';
        historyList.style.display = 'none';
        if (historyExpanded) {
          historyError.textContent = 'Nie udało się pobrać historii.';
          historyError.style.display = 'block';
        }
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMessage('', errorBox);
      setMessage('', strategyError);
      downloadLink.style.display = 'none';

      if (!validateStrategies()) return;

      const fileInput = document.getElementById('file-input');
      if (!fileInput.files || !fileInput.files.length) {
        setMessage('Wybierz plik do analizy.', errorBox);
        return;
      }

      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      fd.append('category_id', categorySelect.value);
      fd.append('mode', form.querySelector('input[name="mode"]:checked')?.value || 'mixed');

      ['use_api', 'use_cloud_http', 'use_local_scraper'].forEach(name => {
        const input = form.querySelector(`input[name="${name}"]`);
        fd.append(name, input.checked ? 'true' : 'false');
      });

      submitBtn.disabled = true;
      submitBtn.textContent = 'Wysyłanie...';

      try {
        const res = await fetch('/api/v1/analysis/upload', { method: 'POST', body: fd });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setMessage(data.detail || 'Nie udało się uruchomić analizy.', errorBox);
          return;
        }
        panel.style.display = 'block';
        runIdEl.textContent = data.analysis_run_id;
        setStatus({ status: data.status, processed_products: 0, total_products: 0, error_message: '' });
        await pollStatus(data.analysis_run_id);
        await loadHistory();
      } catch (err) {
        setMessage(err.message || 'Wystąpił błąd.', errorBox);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Start analizy';
      }
    });

    document.getElementById('strategy-boxes').addEventListener('change', validateStrategies);

    previewBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const runId = previewBtn.dataset.runId || runIdEl.textContent;
      if (runId) openResultsModal(runId);
    });
    resultsClose.addEventListener('click', closeResultsModal);
    resultsModal.addEventListener('click', (e) => { if (e.target === resultsModal) closeResultsModal(); });
    resultsPrev.addEventListener('click', () => {
      if (!previewState.runId) return;
      const nextOffset = Math.max(0, previewState.offset - previewState.limit);
      loadResults(previewState.runId, nextOffset);
    });
    resultsNext.addEventListener('click', () => {
      if (!previewState.runId) return;
      const nextOffset = previewState.offset + previewState.limit;
      if (nextOffset < (previewState.total || 0)) {
        loadResults(previewState.runId, nextOffset);
      }
    });
    marketSearch.addEventListener('click', () => {
      marketState.offset = 0;
      loadMarketData(0);
    });
    marketReset.addEventListener('click', () => {
      marketCategory.value = '';
      marketEan.value = '';
      marketSource.value = '';
      marketDate.value = '';
      marketState.offset = 0;
      loadMarketData(0);
    });
    marketPrev.addEventListener('click', () => {
      const nextOffset = Math.max(0, marketState.offset - marketState.limit);
      marketState.offset = nextOffset;
      loadMarketData(nextOffset);
    });
    marketNext.addEventListener('click', () => {
      const nextOffset = marketState.offset + marketState.limit;
      if (nextOffset < (marketState.total || 0)) {
        marketState.offset = nextOffset;
        loadMarketData(nextOffset);
      }
    });

    document.getElementById('save-windows-btn').addEventListener('click', async () => {
      if (!localWindowsInput.value) localWindowsInput.value = 1;
      await saveSettings('windows');
    });
    document.getElementById('save-ttl-btn').addEventListener('click', async () => {
      if (!cacheTtlInput.value) cacheTtlInput.value = 30;
      await saveSettings('ttl');
    });
    addCurrencyBtn.addEventListener('click', () => {
      const payload = readCurrencyPayload();
      payload.push({ currency: '', rate_to_pln: 0, is_default: false });
      renderCurrencyRows(payload);
    });
    currencyList.addEventListener('click', (e) => {
      if (e.target.dataset.remove !== undefined) {
        const idx = Number(e.target.dataset.remove);
        const payload = readCurrencyPayload().filter((_, i) => i !== idx);
        renderCurrencyRows(payload);
      }
      if (e.target.dataset.default !== undefined) {
        const idx = Number(e.target.dataset.default);
        const payload = readCurrencyPayload().map((p, i) => ({ ...p, is_default: i === idx }));
        renderCurrencyRows(payload);
      }
    });
    saveCurrenciesBtn.addEventListener('click', saveCurrencyRates);

    function openCategoryModal() {
      categoryModal.style.display = 'flex';
      categoryModalError.textContent = '';
      categoryModalForm.reset();
    }
    addCategoryBtn.addEventListener('click', openCategoryModal);
    document.getElementById('main-add-category').addEventListener('click', openCategoryModal);
    categoryCancel.addEventListener('click', () => {
      categoryModal.style.display = 'none';
    });
    categoryModal.addEventListener('click', (e) => {
      if (e.target === categoryModal) categoryModal.style.display = 'none';
    });
    categoryModalForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMessage('', categoryModalError);
      setMessage('', categorySuccess);
      const payload = {
        name: document.getElementById('modal-cat-name').value,
        profitability_multiplier: Number(document.getElementById('modal-cat-multiplier').value || 0),
        commission_rate: (Number(document.getElementById('modal-cat-commission').value || 0) / 100),
      };
      try {
        const res = await fetch('/api/v1/categories/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setMessage(data.detail || 'Nie udało się dodać kategorii.', categoryModalError);
          return;
        }
        categoryModal.style.display = 'none';
        setMessage('Kategoria dodana.', categorySuccess);
        await loadCategories();
      } catch (err) {
        setMessage(err.message || 'Błąd podczas dodawania kategorii.', categoryModalError);
      }
    });

    async function openCategoryDetail(id) {
      categoryDetailError.textContent = '';
      categoryDetailSuccess.textContent = '';
      categoryDetailId = id;
      try {
        const res = await fetch(`/api/v1/categories/${id}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || 'Nie udało się pobrać kategorii.');
        document.getElementById('detail-cat-name').value = data.name || '';
        document.getElementById('detail-cat-multiplier').value = data.profitability_multiplier ?? '';
        document.getElementById('detail-cat-commission').value = data.commission_rate ? Number(data.commission_rate) * 100 : '';
        categoryDetailModal.style.display = 'flex';
      } catch (err) {
        categoryError.textContent = err.message || 'Błąd pobierania kategorii.';
      }
    }

    categoryDetailCancel.addEventListener('click', () => {
      categoryDetailModal.style.display = 'none';
    });
    categoryDetailModal.addEventListener('click', (e) => {
      if (e.target === categoryDetailModal) categoryDetailModal.style.display = 'none';
    });
    categoryDetailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      categoryDetailError.textContent = '';
      categoryDetailSuccess.textContent = '';
      if (!categoryDetailId) return;
      const payload = {
        name: document.getElementById('detail-cat-name').value,
        profitability_multiplier: Number(document.getElementById('detail-cat-multiplier').value || 0),
        commission_rate: (Number(document.getElementById('detail-cat-commission').value || 0) / 100),
      };
      try {
        const res = await fetch(`/api/v1/categories/${categoryDetailId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.detail || 'Nie udało się zapisać kategorii.');
        categoryDetailSuccess.textContent = 'Zapisano zmiany.';
        await loadCategories();
      } catch (err) {
        categoryDetailError.textContent = err.message || 'Błąd zapisu kategorii.';
      }
    });

    faqBtn.addEventListener('click', () => { faqModal.style.display = 'flex'; });
    faqClose.addEventListener('click', () => { faqModal.style.display = 'none'; });
    faqModal.addEventListener('click', (e) => { if (e.target === faqModal) faqModal.style.display = 'none'; });

    function collapseSidebar() {
      sidebar.classList.add('collapsed');
      layout.classList.add('sidebar-collapsed');
      sidebarRestore.style.display = 'block';
    }
    function expandSidebar() {
      sidebar.classList.remove('collapsed');
      layout.classList.remove('sidebar-collapsed');
      sidebarRestore.style.display = 'none';
    }
    sidebarToggle.addEventListener('click', () => {
      if (sidebar.classList.contains('collapsed')) {
        expandSidebar();
      } else {
        collapseSidebar();
      }
      sidebarToggle.textContent = sidebar.classList.contains('collapsed') ? '»' : '«';
    });
    sidebarRestore.addEventListener('click', () => {
      expandSidebar();
      sidebarToggle.textContent = '«';
    });

    historyToggle.addEventListener('click', () => {
      historyExpanded = !historyExpanded;
      if (historyExpanded) {
        historyCaret.textContent = '▼';
        historyList.style.display = 'grid';
        loadHistory();
      } else {
        historyCaret.textContent = '▲';
        historyList.style.display = 'none';
        historyEmpty.style.display = 'none';
        historyError.style.display = 'none';
      }
    });

    loadCategories();
    loadSettings();
    loadCurrencyRates();
    loadHistory();
    loadMarketData();
  </script>
</body>
</html>
