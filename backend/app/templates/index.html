<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MVP: import i analiza produktow</title>
  <style>
    :root{
      --bg0:#070A12;
      --bg1:#0A1020;
      --card:#0E162C;
      --card2:#0B1224;
      --text:#E7EDF7;
      --muted:#A7B3C7;
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.07);
      --shadow:0 18px 46px rgba(0,0,0,.45);
      --r:18px;
      --r2:14px;
      --pad:20px;
      --pad2:16px;
      --accent:#60A5FA;
      --accent2:#34D399;
      --danger:#FCA5A5;
      --ok:#34D399;
      --warn:#FBBF24;
      --btn:linear-gradient(135deg, #60A5FA, #34D399);
      --btnText:#06101F;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(96,165,250,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 0%, rgba(52,211,153,.14), transparent 55%),
        radial-gradient(1100px 900px at 50% 120%, rgba(96,165,250,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    /* layout */
    .wrap{ max-width:1120px; margin:0 auto; padding:28px 18px 56px; }
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      padding:18px 18px 8px;
    }
    .brand h1{ margin:0; font-size:28px; letter-spacing:-.02em; }
    .brand p{ margin:8px 0 0; color:var(--muted); font-size:14px; line-height:1.45; max-width:72ch; }
    .nav{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background:rgba(255,255,255,.03);
      border:1px solid var(--border2);
      color:var(--text);
      font-size:13px;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
    }
    .dot{ width:10px; height:10px; border-radius:999px; background:var(--warn); box-shadow:0 0 0 4px rgba(251,191,36,.12); }
    .dot.ok{ background:var(--ok); box-shadow:0 0 0 4px rgba(52,211,153,.12); }

    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:16px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
      .top{ padding:16px 10px 8px; }
    }

    /* cards */
    .card{
      background: linear-gradient(180deg, rgba(14,22,44,.92), rgba(10,16,32,.92));
      border:1px solid var(--border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{ padding: var(--pad); }
    .card-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      margin-bottom:14px;
    }
    .eyebrow{
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:rgba(167,179,199,.85);
      margin:0 0 8px;
    }
    .title{ margin:0; font-size:18px; letter-spacing:-.01em; }
    .lead{ margin:8px 0 0; color:var(--muted); font-size:13px; line-height:1.5; }

    /* form controls */
    label{ display:block; font-size:13px; color:rgba(167,179,199,.95); margin:0 0 6px; }
    .control{
      width:100%;
      height:44px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
    }
    .control:focus{
      border-color: rgba(96,165,250,.55);
      box-shadow: 0 0 0 4px rgba(96,165,250,.12);
    }
    select.control{ appearance:none; padding-right:44px; background-image:
      linear-gradient(45deg, transparent 50%, rgba(231,237,247,.6) 50%),
      linear-gradient(135deg, rgba(231,237,247,.6) 50%, transparent 50%);
      background-position: calc(100% - 18px) 19px, calc(100% - 12px) 19px;
      background-size: 6px 6px, 6px 6px;
      background-repeat:no-repeat;
    }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width: 720px){ .row{ grid-template-columns:1fr; } }
    .market-filters{ display:none; }
    .modal-filters-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:center;
    }
    @media(max-width: 720px){
      .modal-filters-grid{ grid-template-columns:1fr; }
    }
    .toggle-pill{
      height:44px;
      padding:0 14px;
      border:1px solid var(--border2);
      border-radius:12px;
      background:rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
      cursor:pointer;
    }
    .toggle-pill input{ width:18px; height:18px; }

    .dz{
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.02);
      border-radius: var(--r2);
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height:120px;
      align-items:center;
      justify-content:center;
      text-align:center;
    }
    .dz:hover{ border-color: rgba(96,165,250,.35); background: rgba(255,255,255,.04); }
    .dz strong{ font-size:14px; }
    .dz .muted{ color:var(--muted); font-size:13px; }
    .dz-row{ display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }

    .file-name{
      max-width:360px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      color:var(--muted);
      font-size:13px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.02);
      border-radius:999px;
      padding:8px 10px;
    }

    /* buttons */
    .btn{
      height:44px;
      padding:0 16px;
      border-radius:12px;
      border:1px solid transparent;
      background: rgba(255,255,255,.04);
      color:var(--text);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      cursor:pointer;
      text-decoration:none;
      user-select:none;
      font-weight:600;
      font-size:13px;
    }
    .btn:hover{ background: rgba(255,255,255,.07); }
    .btn:focus-visible{ outline:3px solid rgba(96,165,250,.35); outline-offset:2px; }

    .btn.primary{
      background: var(--btn);
      color: var(--btnText);
      box-shadow: 0 10px 26px rgba(96,165,250,.16);
    }
    .btn.primary:hover{ filter:brightness(1.04); transform: translateY(-1px); }
    .btn.primary:active{ transform: translateY(0px); filter:brightness(.98); }
    .btn.primary[disabled]{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(231,237,247,.55);
      box-shadow:none;
      cursor:not-allowed;
      filter:none;
      transform:none;
    }

    .btn.ghost{ background: rgba(255,255,255,.02); border:1px solid var(--border2); }
    .btn.small{ height:40px; padding:0 14px; border-radius:12px; font-weight:600; }

    .actions{
      margin-top:18px;
      padding-top:16px;
      border-top:1px solid var(--border2);
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:10px;
    }

    .err{ margin-top:8px; color:var(--danger); font-size:12px; }
    .hint{ color:var(--muted); font-size:12px; margin-top:10px; }

    /* right column status */
    .status-box{
      border:1px solid var(--border2);
      border-radius: var(--r2);
      padding:14px;
      background: rgba(255,255,255,.02);
      color:var(--muted);
      font-size:13px;
    }

    /* full width section */
    .full{ margin-top:16px; }
    .full .card-inner{ padding:22px; }

    /* modal */
    .modal-backdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:2000;
    }
    .modal-backdrop.open{ display:flex; }
    .modal{
      width:min(960px, 96vw);
      max-height:92vh;
      display:flex;
      flex-direction:column;
      border-radius: 18px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(14,22,44,.98), rgba(10,16,32,.98));
      box-shadow: 0 22px 70px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .modal-head{
      padding:18px 20px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      border-bottom:1px solid var(--border2);
      flex-shrink:0;
    }
    .modal-head h3{ margin:0; font-size:15px; }
    .modal-body{
      padding:18px 20px 22px;
      overflow:auto;
      flex:1;
    }
    .modal-grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
    @media (max-width: 1100px){ .modal-grid{ grid-template-columns:1fr; } }
    .modal-col{ display:flex; flex-direction:column; gap:14px; }
    .cache-card .control{ max-width:320px; }
    .cat-list{ margin-top:12px; display:flex; flex-direction:column; gap:8px; }
    .cat-row{
      display:grid;
      grid-template-columns: 2fr 0.9fr 0.9fr auto auto;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--border2);
      border-radius:12px;
      background:rgba(255,255,255,.02);
    }
    .cat-row small{ color:var(--muted); }

    /* hide legacy stuff if present */
    .legacy-hidden{ display:none !important; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>MVP: import i analiza produktow</h1>
        <p>wgraj plik, wybierz kategorie i uruchom analize, ustawienia sa pod ikonka</p>
      </div>
      <div class="nav">
        <div class="pill" id="status-pill" title="status backendu i scrapera">
          <span class="dot" id="status-dot"></span>
          <span id="status-text">sprawdzanie statusu...</span>
        </div>
        <button class="pill" id="terminal-btn" type="button">terminal</button>
        <button class="pill icon" id="open-settings" type="button" title="ustawienia" aria-label="ustawienia"><span style="font-size:18px; line-height:1;">&#9881;</span></button>
        <button class="pill" id="faq-btn" type="button">faq / pomoc</button>
        <a class="pill" id="logout-btn" href="/logout">wyloguj</a>
      </div>
    </div>

    <div class="grid">
      <!-- left: input -->
      <section class="card" id="input-card">
        <div class="card-inner">
          <div class="card-head">
            <div>
              <div class="eyebrow">krok 1</div>
              <h2 class="title">dane wejsciowe</h2>
              <p class="lead">wrzuc plik, wybierz kategorie i start, </p>
            </div>
            
          </div>

          <div class="dz" id="dropzone" role="button" tabindex="0" aria-label="dropzone pliku">
            <strong>wrzuc lub kliknij aby wybrac plik excel</strong>
            <div class="muted">obsługiwane: .xlsx, .xls, .csv</div>
            <div class="file-name" id="fileName" style="margin-top:8px;">nie wybrano pliku</div>
            <input id="file-input" type="file" accept=".csv,.xlsx,.xls" hidden />
          </div>

          <div class="hint">obslugiwane formaty: .xlsx, .xls, .csv</div>
          <div class="err" id="file-error" style="display:none;"></div>

          <div style="height:16px;"></div>

          <div class="row">
            <div>
              <label for="category-select">kategoria</label>
              <select class="control" id="category-select"></select>
              <div class="err" id="category-select-error" style="display:none;"></div>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="start-btn" type="button" disabled>start analizy</button>
          </div>

          <div class="err" id="error" style="display:none;"></div>
        </div>
      </section>

      <!-- right: running -->
      <section class="card">
        <div class="card-inner">
          <div class="card-head">
            <div>
              <div class="eyebrow">biezaca analiza</div>
              <h2 class="title">status i log</h2>
              <p class="lead">status, postep i log zawsze widoczne</p>
            </div>
          </div>

      <div class="status-box" id="active-runs-empty">brak aktywnej analizy</div>
      <div id="active-runs" style="display:none;"></div>
      <div class="err" id="active-runs-error" style="display:none;"></div>

          <div style="height:12px;"></div>

          <div class="actions" style="justify-content:space-between;">
            <button class="btn ghost" id="cancel-run-btn" type="button" style="display:none;">cancel</button>
            <div style="display:flex; gap:10px; margin-left:auto;">
              <a class="btn ghost" id="download-link" href="#" style="display:none;">download</a>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- full width: db analysis -->
    <section class="card full" id="db-card">
      <div class="card-inner">
        <div class="card-head">
          <div>
            <div class="eyebrow">baza allegro</div>
            <h2 class="title">analiza z bazy</h2>
            <p class="lead">uruchom analize na danych zapisanych w bazie (bez pliku), ta sekcja jest zawsze widoczna</p>
          </div>
        </div>

        <div class="row">
          <div>
            <label for="db-source">zrodlo</label>
            <select class="control" id="db-source">
              <option value="allegro">allegro</option>
            </select>
          </div>
          <div>
            <label for="db-limit">limit</label>
            <input class="control" id="db-limit" type="number" min="1" step="1" placeholder="np 500" />
          </div>
        </div>

        <div style="height:14px;"></div>

        <div class="row">
          <div>
            <label for="db-last-days">ostatnie dni</label>
            <input class="control" id="db-last-days" type="number" min="1" step="1" placeholder="np 7" />
          </div>
          <div>
            <label for="db-ean-contains">ean zawiera</label>
            <input class="control" id="db-ean-contains" type="text" placeholder="np 590" />
          </div>
        </div>

        <div class="actions" style="justify-content:space-between;">
          <div class="err" id="db-error" style="display:none;"></div>
          <button class="btn primary" id="db-run-btn" type="button">start analizy z bazy</button>
        </div>
      </div>
    </section>

  </div>

  <!-- settings modal -->
  <div class="modal-backdrop" id="settings-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="modal-head">
        <h3 id="settings-title">ustawienia</h3>
        <button class="btn ghost small" id="close-settings" type="button">zamknij</button>
      </div>
      <div class="modal-body">
        <div class="modal-grid">
          <div class="card cache-card" style="background:rgba(255,255,255,.02); box-shadow:none; border-color:var(--border2);">
            <div class="card-inner" style="padding:16px;">
              <div class="eyebrow">cache</div>
              <label for="cache-ttl-input">ttl cache (dni)</label>
              <input class="control" id="cache-ttl-input" type="number" min="0" step="1" placeholder="np 7" />
              <div class="hint">0 = bez cache (zawsze odswiezaj), 7 = trzymamy dane 7 dni</div>
              <div class="actions" style="justify-content:flex-end;">
                <button class="btn primary" id="save-ttl-btn" type="button">zapisz</button>
              </div>
              <div class="hint" id="cache-ttl">ustawienia cache wplywaja na odczyt z bazy vs odswiezanie</div>
            </div>
          </div>

          <div class="card" style="background:rgba(255,255,255,.02); box-shadow:none; border-color:var(--border2);">
            <div class="card-inner" style="padding:16px;">
              <div class="eyebrow">proxies</div>
              <div class="hint">mozna wgrac plik .txt (1 proxy na linie) przez api /api/v1/proxies, albo ustawic PROXIES w env</div>
              <div class="actions" style="gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-start; margin-top:8px;">
                <input class="control" id="proxy-file" type="file" accept=".txt" style="max-width:260px;" />
                <button class="btn primary" id="upload-proxies-btn" type="button">wgraj</button>
              </div>
              <div class="status-box" id="proxy-status" style="margin-top:10px;">brak danych</div>
              <div class="hint" style="margin-top:6px;">po wgraniu scraper automatycznie korzysta z nowego pliku</div>
              <div class="err" id="proxy-error" style="display:none;"></div>
            </div>
          </div>
        </div>

        <div style="height:14px;"></div>

        <div class="card" style="background:rgba(255,255,255,.02); box-shadow:none; border-color:var(--border2);">
          <div class="card-inner" style="padding:16px;">
            <div class="eyebrow">kategorie</div>
            <div class="hint">kategorie sa wymagane do startu. dodaj nowa, jesli lista jest pusta.</div>
            <div style="display:grid; grid-template-columns: 1.4fr 1fr 1fr; gap:10px; margin-top:10px;">
              <input class="control" id="cat-name" placeholder="nazwa (np perfumy)" />
              <input class="control" id="cat-mult" type="number" step="0.01" placeholder="mnoznik (np 1.25)" />
              <input class="control" id="cat-comm" type="number" step="0.1" placeholder="prowizja % (np 10)" />
            </div>
            <div class="actions" style="justify-content:flex-end; margin-top:10px;">
              <button class="btn primary" id="add-cat-btn" type="button">dodaj kategorie</button>
            </div>
            <div class="cat-list" id="cat-list"></div>
            <div class="err" id="cat-add-error" style="display:none;"></div>
          </div>
        </div>

        <div style="height:14px;"></div>

        <div class="card" style="background:rgba(255,255,255,.02); box-shadow:none; border-color:var(--border2);">
          <div class="card-inner" style="padding:16px;">
            <div class="eyebrow">kursy walut</div>
            <div id="currency-body"></div>
            <div class="actions" style="justify-content:space-between;">
              <button class="btn ghost" id="add-currency-btn" type="button">dodaj walute</button>
              <button class="btn primary" id="save-currency-btn" type="button">zapisz kursy</button>
            </div>
            <div class="err" id="currency-error" style="display:none;"></div>
            <div class="hint" id="currency-helper">pln musi miec kurs 1.0</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- faq modal (simple) -->
  <div class="modal-backdrop" id="faq-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="faq-title">
      <div class="modal-head">
        <h3 id="faq-title">faq / pomoc</h3>
        <button class="btn ghost small" id="faq-close" type="button">zamknij</button>
      </div>
      <div class="modal-body">
        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">jak dziala scraper</div>
          <div>wszystkie zapytania ida przez jeden allegro.pl-scraper-main (TLS client + AnySolver). nie ma wyboru trybu ani providera.</div>
        </div>

        <div style="height:10px;"></div>

        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">proxy / limity</div>
          <div>scraper wymaga listy proxy http(s). ustaw PROXIES albo wgraj plik proxies.txt w ustawieniach. timeouty i poll zobaczysz w sekcji statusu.</div>
        </div>

        <div style="height:10px;"></div>

        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">jak dodac kategorie</div>
          <div>uzyj przycisku \"+\" w sekcji kategorie i wypelnij formularz.</div>
        </div>

        <div style="height:10px;"></div>

        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">pliki</div>
          <div>csv, xls, xlsx. wymagane kolumny: ean, name, purchase_price.</div>
        </div>

        <div style="height:10px;"></div>

        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">gdy analiza konczy sie bledem</div>
          <div>sprawdz komunikat w sekcji statusu. upewnij sie, ze kategoria jest aktywna oraz w ustawieniach wybrales zrodla danych (jesli tryb nie jest \"tylko baza\").</div>
        </div>

        <div style="height:10px;"></div>

        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">pola kategorii</div>
          <div><strong>nazwa</strong> – dowolna etykieta (np. perfumy, chemia, zabawki).<br><strong>mnoznik oplacalnosci</strong> – minimalny ROI vs cena zakupu; 1.5 = min. 50% ROI po prowizji.<br><strong>prowizja allegro (%)</strong> – procent prowizji od sprzedazy; odejmujemy go przed liczeniem marzy.</div>
        </div>

        <div style="height:10px;"></div>

        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">szybki start</div>
          <div>1) dodaj kategorie (ustawienia -> sekcja kategorie), 2) wybierz kategorie, 3) wrzuc plik csv/xlsx, 4) start analizy</div>
        </div>

        <div style="height:10px;"></div>

        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">cache</div>
          <div>ttl cache podajesz w dniach. backend dostaje to jako cache_ttl_seconds (dni * 86400)</div>
        </div>

        <div style="height:10px;"></div>

        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">baza allegro (market)</div>
          <div>na dole strony jest sekcja \"baza allegro\", to podglad danych z /api/v1/market-data (filtry: kategoria, ean, data)</div>
        </div>

        <div style="height:10px;"></div>

        <div class="status-box">
          <div style="color:var(--text); font-weight:800; margin-bottom:8px;">status i bledy</div>
          <div>jesli status pokazuje problemy, sprawdz env: PROXIES, ANYSOLVER_API_KEY. logi w kontenerach backend/worker/scraper</div>
        </div>
      </div>
    </div>
  </div>
  <!-- terminal modal -->
  <div class="modal-backdrop" id="terminal-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="terminal-title">
      <div class="modal-head">
        <h3 id="terminal-title">terminal / logi</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn ghost small" id="terminal-refresh" type="button">odswiez</button>
          <button class="btn ghost small" id="terminal-close" type="button">zamknij</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="status-box" style="max-height:60vh; overflow:auto; background:rgba(0,0,0,.25);" id="terminal-body">
          laduje logi...
        </div>
      </div>
    </div>
  </div>
  <!-- market filters modal -->
  <div class="modal-backdrop" id="market-filters-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="market-filters-title">
      <div class="modal-head">
        <h3 id="market-filters-title">filtry market data</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn ghost small" id="market-filters-reset" type="button">wyczysc</button>
          <button class="btn primary small" id="market-filters-apply" type="button">zastosuj</button>
          <button class="btn ghost small" id="market-filters-close" type="button">zamknij</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="row" style="margin-top:12px;">
          <div>
            <label for="mf-date">zaktualizowane od</label>
            <input class="control" id="mf-date" type="date" />
          </div>
          <div class="modal-filters-grid" style="margin-top:22px;">
            <label class="toggle-pill">
              <input type="checkbox" id="mf-with-data" /> <span>tylko z danymi</span>
            </label>
            <label class="toggle-pill">
              <input type="checkbox" id="mf-profitable" /> <span>tylko oplacalne</span>
            </label>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- preview modal -->
  <div class="modal-backdrop" id="preview-modal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="preview-title">
      <div class="modal-head">
        <h3 id="preview-title">podglad wynikow</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn ghost small" id="preview-refresh" type="button">odswiez</button>
          <button class="btn ghost small" id="preview-close" type="button">zamknij</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="status-box" style="max-height:60vh; overflow:auto; background:rgba(0,0,0,.25);" id="preview-body">
          wybierz run aby zobaczyc wyniki
        </div>
      </div>
    </div>
  </div>
  <!-- baza allegro / market data (full width at bottom) -->
  <section class="card full" id="market-card" style="margin-top:18px;">
    <div class="card-inner">
      <div class="card-head">
        <div>
          <div class="eyebrow">baza allegro</div>
          <h2 style="margin:0;">market data</h2>
          <p class="lead">podglad rekordow zapisanych w bazie (api /api/v1/market-data)</p>
        </div>
        <div class="actions">
          <button class="btn ghost" id="market-filters-btn" type="button">filtry</button>
        </div>
      </div>

      <div class="form">
        <!-- advanced filter values -->
        <input type="hidden" id="market-date-val" />
        <input type="hidden" id="market-with-data-val" />
        <input type="hidden" id="market-profitable-val" />

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="market-category">kategoria</label>
            <select class="control" id="market-category"></select>
          </div>
          <div>
            <label for="market-ean">ean</label>
            <input class="control" id="market-ean" placeholder="np 590" />
          </div>
        </div>

        <div class="actions" style="justify-content:space-between; margin-top:12px; flex-wrap:wrap;">
          <div style="display:flex; flex-direction:column; gap:4px;">
            <div class="hint" id="market-meta">0 rekordow</div>
            <div class="hint" id="market-summary" style="color:var(--muted);">filtry: brak</div>
          </div>
          <div class="actions">
            <button class="btn ghost" id="market-prev" type="button">prev</button>
            <button class="btn ghost" id="market-next" type="button">next</button>
          </div>
        </div>

        <div class="err" id="market-error" style="display:none;"></div>
        <div style="height:10px;"></div>
        <div class="table" id="market-table"></div>
      </div>
    </div>
  </section>


  <script>
    // small helpers
    const $ = (id) => document.getElementById(id);
    const show = (el) => { if(el){ el.style.display = ""; } };
    const hide = (el) => { if(el){ el.style.display = "none"; } };
    const setText = (el, t) => { if(el){ el.textContent = t; } };
    const setHtml = (el, t) => { if(el){ el.innerHTML = t; } };
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const fmtPrice = (v) => {
      if(v === null || v === undefined || v === "") return "-";
      const n = Number(v);
      if(!Number.isFinite(n)) return "-";
      return n.toFixed(2);
    };

    // elements
    const fileInput = $("file-input");
    const dropzone = $("dropzone");
    const fileNameEl = $("fileName");
    const fileErr = $("file-error");
    const catSelect = $("category-select");
    const catErr = $("category-select-error");
    const startBtn = $("start-btn");
    const errBox = $("error");

    const statusDot = $("status-dot");
    const statusText = $("status-text");

    const activeEmpty = $("active-runs-empty");
    const activeRuns = $("active-runs");
    const activeErr = $("active-runs-error");
    const cancelBtn = $("cancel-run-btn");
    const downloadLink = $("download-link");

    const dbRunBtn = $("db-run-btn");
    const dbErr = $("db-error");

    // modals
    const settingsModal = $("settings-modal");
    const openSettings = $("open-settings");
    const closeSettings = $("close-settings");

    const faqBtn = $("faq-btn");
    const faqModal = $("faq-modal");
    const faqClose = $("faq-close");
    const terminalBtn = $("terminal-btn");
    const terminalModal = $("terminal-modal");
    const terminalClose = $("terminal-close");
    const terminalRefresh = $("terminal-refresh");
    const mfModal = $("market-filters-modal");
    const mfOpen = $("market-filters-btn");
    const mfClose = $("market-filters-close");
    const mfApply = $("market-filters-apply");
    const mfReset = $("market-filters-reset");
    const previewModal = $("preview-modal");
    const previewClose = $("preview-close");
    const previewRefresh = $("preview-refresh");

    function openModal(m){ if(!m) return; m.classList.add("open"); m.setAttribute("aria-hidden","false"); }
    function closeModal(m){ if(!m) return; m.classList.remove("open"); m.setAttribute("aria-hidden","true"); }

    // wire modals
    openSettings?.addEventListener("click", () => openModal(settingsModal));
    closeSettings?.addEventListener("click", () => closeModal(settingsModal));
    settingsModal?.addEventListener("click", (e) => { if(e.target === settingsModal) closeModal(settingsModal); });

    faqBtn?.addEventListener("click", () => openModal(faqModal));
    faqClose?.addEventListener("click", () => closeModal(faqModal));
    faqModal?.addEventListener("click", (e) => { if(e.target === faqModal) closeModal(faqModal); });
    terminalBtn?.addEventListener("click", () => { openModal(terminalModal); loadLogs(); });
    terminalClose?.addEventListener("click", () => closeModal(terminalModal));
    terminalModal?.addEventListener("click", (e) => { if(e.target === terminalModal) closeModal(terminalModal); });
    terminalRefresh?.addEventListener("click", () => loadLogs());
    previewClose?.addEventListener("click", () => closeModal(previewModal));
    previewModal?.addEventListener("click", (e) => { if(e.target === previewModal) closeModal(previewModal); });

    // file selection
    function setFileName(name){
      setText(fileNameEl, name || "nie wybrano pliku");
    }
    function validateReady(){
      const ok = !!(fileInput?.files && fileInput.files.length) && !!catSelect?.value;
      if(startBtn) startBtn.disabled = !ok;
      return ok;
    }

    dropzone?.addEventListener("click", () => fileInput?.click());
    dropzone?.addEventListener("dragover", (e)=>{ e.preventDefault(); dropzone.style.borderColor = "rgba(96,165,250,.45)"; });
    dropzone?.addEventListener("dragleave", ()=>{ dropzone.style.borderColor = ""; });
    dropzone?.addEventListener("drop", (e)=>{
      e.preventDefault();
      dropzone.style.borderColor = "";
      const f = e.dataTransfer?.files?.[0];
      if(!f) return;
      const dt = new DataTransfer();
      dt.items.add(f);
      fileInput.files = dt.files;
      setFileName(f.name);
      hide(fileErr);
      validateReady();
    });

    fileInput?.addEventListener("change", ()=>{
      const f = fileInput.files?.[0];
      setFileName(f?.name || "");
      hide(fileErr);
      validateReady();
    });

    catSelect?.addEventListener("change", ()=>{
      hide(catErr);
      validateReady();
    });

    // fetch helpers
    async function apiGet(url){
      const r = await fetch(url, { credentials:"include" });
      if(!r.ok) throw new Error("http " + r.status);
      return await r.json();
    }
    async function apiPost(url, body){
      const r = await fetch(url, {
        method:"POST",
        credentials:"include",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body ?? {})
      });
      if(!r.ok){
        let detail = "";
        try{ detail = await r.text(); }catch(_){}
        throw new Error("http " + r.status + " " + detail);
      }
      const ct = r.headers.get("content-type") || "";
      return ct.includes("application/json") ? await r.json() : await r.text();
    }
    async function apiPatch(url, body){
      const r = await fetch(url, {
        method:"PATCH",
        credentials:"include",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body ?? {})
      });
      if(!r.ok){
        let detail = "";
        try{ detail = await r.text(); }catch(_){}
        throw new Error("http " + r.status + " " + detail);
      }
      const ct = r.headers.get("content-type") || "";
      return ct.includes("application/json") ? await r.json() : await r.text();
    }
    async function apiPut(url, body){
      const r = await fetch(url, {
        method:"PUT",
        credentials:"include",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body ?? {})
      });
      if(!r.ok){
        let detail = "";
        try{ detail = await r.text(); }catch(_){}
        throw new Error("http " + r.status + " " + detail);
      }
      const ct = r.headers.get("content-type") || "";
      return ct.includes("application/json") ? await r.json() : await r.text();
    }

    // logs / terminal
    async function loadLogs(){
      const box = $("terminal-body");
      if(box) box.textContent = "laduje logi (ostatnie 50)...";
      try{
        const data = await apiGet("/api/v1/status/logs");
        const logs = data?.logs || [];
        if(!logs.length){
          if(box) box.textContent = "brak logow";
          return;
        }
        const lines = logs.map((l) => {
          const ts = l.time ? new Date(l.time).toLocaleTimeString() : "";
          const worker = l.workerId || "scraper";
          const type = l.type || "info";
          return `<div style="padding:6px 0; border-bottom:1px solid var(--border2);">
            <span style="color:var(--muted); font-size:12px;">${ts}</span>
            <span style="margin-left:8px; color:${type==="error" ? "var(--danger)" : "var(--text)"};">[${type}]</span>
            <span style="margin-left:8px; color:var(--muted); font-size:12px;">${worker}</span>
            <div style="margin-top:4px; color:var(--text); white-space:pre-wrap;">${(l.message||"").toString()}</div>
          </div>`;
        }).join("");
        if(box) box.innerHTML = lines;
      }catch(e){
        if(box) box.textContent = "nie mozna pobrac logow (sprawdz scraper)";
      }
    }

    // load categories
    async function loadCategories(){
      try{
        const data = await apiGet("/api/v1/categories/?include_inactive=1");
        const cats = data?.items || data || [];
        const activeCats = cats.filter(c => c.is_active !== false);

        // selects
        setHtml(catSelect, "");
        const opt0 = document.createElement("option");
        opt0.value = "";
        opt0.textContent = "wybierz kategorie";
        catSelect.appendChild(opt0);
        for(const c of activeCats){
          const o = document.createElement("option");
          o.value = c.id ?? c.slug ?? c.value ?? c;
          o.textContent = c.name ?? c.label ?? String(c);
          catSelect.appendChild(o);
        }
        const marketSel = $("market-category");
        if(marketSel){
          setHtml(marketSel, "");
          const m0 = document.createElement("option"); m0.value=""; m0.textContent="wszystkie";
          marketSel.appendChild(m0);
          for(const c of activeCats){
            const mo = document.createElement("option");
            mo.value = c.id ?? c.slug ?? c.value ?? c;
            mo.textContent = c.name ?? c.label ?? String(c);
            marketSel.appendChild(mo);
          }
        }

        // settings list
        const listHost = $("cat-list");
        if(listHost){
          listHost.innerHTML = cats.length ? "" : '<div class="status-box">brak kategorii</div>';
          for(const c of cats){
            const row = document.createElement("div");
            row.className = "cat-row";
            row.dataset.catId = c.id || c.slug || "";
            row.innerHTML = `
              <input class="control" data-cat-name value="${c.name || ''}" />
              <input class="control" data-cat-mult type="number" step="0.01" value="${c.profitability_multiplier ?? 1}" />
              <input class="control" data-cat-comm type="number" step="0.1" value="${c.commission_rate ?? 0}" />
              <label style="display:flex; align-items:center; gap:6px; font-size:12px;">
                <input type="checkbox" data-cat-active ${c.is_active ? "checked" : ""}/> aktywna
              </label>
              <button class="btn ghost small" data-cat-save>Zapisz</button>
            `;
            listHost.appendChild(row);
          }
          listHost.querySelectorAll("[data-cat-save]").forEach(btn=>{
            btn.addEventListener("click", async (e)=>{
              const row = e.target.closest(".cat-row");
              if(!row || !row.dataset.catId) return;
              const name = row.querySelector("[data-cat-name]")?.value.trim();
              const mult = Number(row.querySelector("[data-cat-mult]")?.value || 0);
              const comm = Number(row.querySelector("[data-cat-comm]")?.value || 0);
              const active = !!row.querySelector("[data-cat-active]")?.checked;
              try{
                await apiPatch(`/api/v1/categories/${row.dataset.catId}`, {
                  name,
                  profitability_multiplier: mult || 1,
                  commission_rate: comm || 0,
                  is_active: active
                });
                await loadCategories();
              }catch(err){
                if(catErr){ catErr.style.display=""; catErr.textContent="nie mozna zapisac kategorii"; }
              }
            });
          });
        }
      }catch(e){
        if(catErr){ catErr.style.display=""; catErr.textContent="nie mozna zaladowac kategorii"; }
      }
    }

    // status
    async function pollStatus(){
      try{
        const st = await apiGet("/api/v1/status");
        const ok = !!(st?.ok ?? st?.healthy ?? st?.status === "ok");
        statusDot?.classList.toggle("ok", ok);
        setText(statusText, ok ? "status ok" : "problemy");
      }catch(e){
        statusDot?.classList.remove("ok");
        setText(statusText, "brak polaczenia");
      }
    }

    // active analysis
    async function pollActive(){
      try{
        const resp = await apiGet("/api/v1/analysis/active");
        const runs = resp?.runs || resp || [];
        if(!runs.length){
          show(activeEmpty); hide(activeRuns); hide(cancelBtn); hide(downloadLink);
          setText(activeEmpty, "brak aktywnej analizy");
          const t = $("active-table"); if(t) t.innerHTML = "";
          return;
        }
        hide(activeEmpty); show(activeRuns);
        const cards = runs.map(r => {
          const pct = (r.processed_products != null && r.total_products) ? `${r.processed_products}/${r.total_products}` : (r.progress ?? "-");
          const cat = r.category_name || r.category_id || "kategoria ?";
          const status = r.status || "running";
          const created = r.created_at ? new Date(r.created_at).toLocaleString() : "";
          return `
            <div class="status-box" style="margin-top:8px;">
              <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; color:var(--text); font-weight:700;">
                <span>${cat}</span>
                <span style="color:var(--muted); font-weight:600;">id: ${r.id}</span>
              </div>
              <div>status: ${status}</div>
              <div>postep: ${pct}</div>
              ${created ? `<div class="hint">utworzono: ${created}</div>` : ""}
              <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                ${["pending","running"].includes(status)
                  ? `<button class="btn ghost small" data-cancel-run="${r.id}">anuluj</button>`
                  : ""
                }
                <button class="btn ghost small" data-preview-run="${r.id}">podglad</button>
              </div>
            </div>
          `;
        }).join("");
        setHtml(activeRuns, cards);
        // wire cancel buttons
        activeRuns.querySelectorAll("[data-cancel-run]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-cancel-run");
            btn.disabled = true;
            btn.textContent = "anulowanie...";
            try{
              await apiPost(`/api/v1/analysis/${id}/cancel`, {});
            }catch(_){}
            await pollActive();
          });
        });
        activeRuns.querySelectorAll("[data-preview-run]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-preview-run");
            if(!id) return;
            openModal(previewModal);
            await loadPreview(id);
          });
        });
      }catch(e){
        if(activeErr){ activeErr.style.display=""; activeErr.textContent="blad pobierania aktywnej analizy"; }
      }
    }

    async function loadPreview(runId){
      const host = $("preview-body");
      if(host) host.innerHTML = '<div class="hint">ladowanie wynikow...</div>';
      previewRefresh?.setAttribute("data-run-id", runId);
      try{
        const data = await apiGet(`/api/v1/analysis/${runId}/results?limit=50`);
        const rows = data?.items || [];
        if(!rows.length){
          if(host) host.innerHTML = '<div class="hint">brak wynikow (jeszcze trwa?)</div>';
          return;
        }
        const html = `
          <div style="overflow:auto; border:1px solid var(--border2); border-radius:12px; margin-top:6px;">
            <table style="width:100%; border-collapse:collapse; min-width:760px;">
              <thead>
                <tr style="text-align:left; font-size:12px; color:var(--muted);">
                  <th style="padding:8px 10px;">ean</th>
                  <th style="padding:8px 10px;">nazwa</th>
                  <th style="padding:8px 10px;">cena kupna</th>
                  <th style="padding:8px 10px;">cena allegro</th>
                  <th style="padding:8px 10px;">status scrape</th>
                  <th style="padding:8px 10px;">blad</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r => `
                  <tr style="border-bottom:1px solid var(--border2);">
                    <td style="padding:8px 10px; font-family: ui-monospace;">${r.ean || ""}</td>
                    <td style="padding:8px 10px;">${(r.name||"").toString().slice(0,80)}</td>
                    <td style="padding:8px 10px;">${fmtPrice(r.original_purchase_price)}</td>
                    <td style="padding:8px 10px;">${fmtPrice(r.allegro_price_pln)}</td>
                    <td style="padding:8px 10px;">${r.scrape_status || "-"}</td>
                    <td style="padding:8px 10px; color:var(--danger);">${r.scrape_error_message || ""}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `;
        if(host) host.innerHTML = html;
      }catch(e){
        if(host) host.innerHTML = '<div class="err">blad pobierania wynikow</div>';
      }
    }

    // run upload
    startBtn?.addEventListener("click", async ()=>{
      if(!validateReady()) return;
      hide(errBox);
      const f = fileInput.files[0];
      const category = catSelect.value;

      const fd = new FormData();
      fd.append("file", f);
      fd.append("category_id", category);

      startBtn.disabled = true;
      startBtn.textContent = "start...";
      try{
        const r = await fetch("/api/v1/analysis/upload", { method:"POST", credentials:"include", body: fd });
        if(!r.ok) throw new Error("http " + r.status);
        await pollActive();
      }catch(e){
        if(errBox){ errBox.style.display=""; errBox.textContent="nie udalo sie uruchomic analizy"; }
      }finally{
        startBtn.textContent = "start analizy";
        validateReady();
      }
    });

    // run from db
    dbRunBtn?.addEventListener("click", async ()=>{
      hide(dbErr);
      dbRunBtn.disabled = true;
      dbRunBtn.textContent = "start...";
      try{
        const payload = {
          source: $("db-source")?.value || "allegro",
          // limit removed in ui
           
          last_days: Number($("db-last-days")?.value || 0) || null,
          ean_contains: $("db-ean-contains")?.value || ""
        };
        // clean nulls
        for(const k of Object.keys(payload)){
          if(payload[k] === "" || payload[k] === 0 || payload[k] === null) delete payload[k];
        }
        await apiPost("/api/v1/analysis/run_from_db", payload);
        await pollActive();
      }catch(e){
        if(dbErr){ dbErr.style.display=""; dbErr.textContent="nie udalo sie uruchomic analizy z bazy"; }
      }finally{
        dbRunBtn.disabled = false;
        dbRunBtn.textContent = "start analizy z bazy";
      }
    });

    // cancel (best-effort: endpoint may exist in backend)
    cancelBtn?.addEventListener("click", async ()=>{
      cancelBtn.disabled = true;
      cancelBtn.textContent = "cancel...";
      try{
        await apiPost("/api/v1/analysis/cancel", {});
      }catch(e){}
      finally{
        cancelBtn.disabled = false;
        cancelBtn.textContent = "cancel";
        await pollActive();
      }
    });

    // settings: proxies
    async function loadProxyStatus(){
      const box = $("proxy-status");
      try{
        const p = await apiGet("/api/v1/proxies");
        const ts = new Date().toLocaleTimeString();
        const when = p?.updated_at ? new Date(p.updated_at).toLocaleString() : ts;
        const path = p?.path ? ` (${p.path})` : "";
        setText(box, (p?.count != null) ? (`proxies: ${p.count}${path} • ${when}`) : `proxies ok (${ts})`);
        box.style.color = "var(--text)";
        return p;
      }catch(e){
        setText(box, "blad pobierania proxies");
        box.style.color = "var(--danger)";
        throw e;
      }
    }
    $("load-proxies-btn")?.addEventListener("click", loadProxyStatus);
    $("upload-proxies-btn")?.addEventListener("click", async ()=>{
      const err = $("proxy-error"); if(err){ err.style.display="none"; }
      const inp = $("proxy-file");
      if(!inp || !inp.files || !inp.files.length){
        if(err){ err.style.display=""; err.textContent="wybierz plik .txt z proxy"; }
        return;
      }
      const box = $("proxy-status"); if(box){ box.textContent = "wgrywanie..."; box.style.color="var(--text)"; }
      const fd = new FormData();
      fd.append("file", inp.files[0]);
      try{
        const r = await fetch("/api/v1/proxies", { method:"POST", credentials:"include", body: fd });
        if(!r.ok) throw new Error("http " + r.status);
        const meta = await loadProxyStatus();
        if(box){ box.textContent = `wgrano (${meta?.count || "?"} proxy)`; box.style.color="var(--ok)"; }
        if(err){ err.style.display="none"; }
      }catch(e){
        if(err){ err.style.display=""; err.textContent="upload nieudany"; }
        if(box){ box.textContent = "upload nieudany"; box.style.color="var(--danger)"; }
      }
    });
    $("reload-proxies-btn")?.addEventListener("click", async ()=>{
      const err = $("proxy-error"); if(err){ err.style.display="none"; }
      try{
        await apiPost("/api/v1/proxies/reload", {});
      }catch(e){
        if(err){ err.style.display=""; err.textContent="reload nieudany (czy wgrany jest plik proxies.txt?)"; }
      }
      await loadProxyStatus();
    });

    // settings: cache
    async function loadSettings(){
      try{
        const s = await apiGet("/api/v1/settings/");
        const days = Number(s?.cache_ttl_days ?? 0);
        const inp = $("cache-ttl-input");
        if(inp){ inp.value = isNaN(days) ? "" : days; }
        const hint = $("cache-ttl");
        if(hint){
          if(days === 0){ hint.textContent = "cache wylaczony (0 = zawsze odswiezaj)"; }
          else if(!isNaN(days)){ hint.textContent = `cache ttl: ${days} dni`; }
          else{ hint.textContent = "ustawienia cache wplywaja na odczyt z bazy vs odswiezanie"; }
        }
      }catch(e){
        const hint = $("cache-ttl"); if(hint){ hint.textContent = "nie mozna pobrac ustawien (sprawdz login)"; }
      }
    }

    // settings: ttl
    $("save-ttl-btn")?.addEventListener("click", async ()=>{
      const days = Number($("cache-ttl-input")?.value ?? 0);
      const v = Math.max(0, Math.min(365, Math.floor(days)));
      try{
        await apiPut("/api/v1/settings/", { cache_ttl_days: v });
        await loadSettings();
      }catch(e){
        const ce = $("cache-ttl"); if(ce){ ce.textContent = "blad zapisu cache (sprawdz uprawnienia/login)"; }
      }
    });

    // settings: categories
    $("add-cat-btn")?.addEventListener("click", async ()=>{
      const err = $("cat-add-error"); if(err){ err.style.display="none"; }
      const name = ($("cat-name")?.value || "").trim();
      const mult = Number($("cat-mult")?.value || 0);
      const comm = Number($("cat-comm")?.value || 0);
      if(!name){
        if(err){ err.style.display=""; err.textContent="podaj nazwe kategorii"; }
        return;
      }
      try{
        await apiPost("/api/v1/categories/", {
          name,
          profitability_multiplier: mult || 1,
          commission_rate: comm || 0,
          is_active: true
        });
        if(err){ err.style.display="none"; }
        // clear inputs
        if($("cat-name")) $("cat-name").value = "";
        if($("cat-mult")) $("cat-mult").value = "";
        if($("cat-comm")) $("cat-comm").value = "";
        await loadCategories();
      }catch(e){
        if(err){ err.style.display=""; err.textContent="nie udalo sie dodac kategorii (czy nazwa juz istnieje?)"; }
      }
    });

    // settings: currencies
    function renderCurrencies(items){
      const host = $("currency-body");
      if(!host) return;
      const rows = (items || []).map((c, i) => `
        <div style="display:grid;grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
          <input class="control" data-cur-code value="${(c.currency||c.code||"").toUpperCase()}" placeholder="waluta (np EUR)" />
          <input class="control" data-cur-rate value="${c.rate_to_pln ?? c.rate ?? ""}" placeholder="kurs do pln" />
        </div>
      `).join("");
      host.innerHTML = rows || '<div class="status-box">brak walut</div>';
    }
    async function loadCurrencies(){
      try{
        const d = await apiGet("/api/v1/settings/currencies");
        renderCurrencies(d?.rates || []);
      }catch(e){
        const ce = $("currency-error"); if(ce){ ce.style.display=""; ce.textContent="blad pobierania kursow"; }
      }
    }
    $("add-currency-btn")?.addEventListener("click", ()=>{
      const host = $("currency-body");
      if(!host) return;
      host.insertAdjacentHTML("beforeend", `
        <div style="display:grid;grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
          <input class="control" data-cur-code value="" placeholder="waluta (np EUR)" />
          <input class="control" data-cur-rate value="" placeholder="kurs do pln" />
        </div>
      `);
    });
    $("save-currency-btn")?.addEventListener("click", async ()=>{
      const host = $("currency-body"); if(!host) return;
      const codes = [...host.querySelectorAll("[data-cur-code]")].map(x => x.value.trim()).filter(Boolean);
      const rates = [...host.querySelectorAll("[data-cur-rate]")].map(x => x.value.trim()).filter(Boolean);
      const items = [];
      const n = Math.min(codes.length, rates.length);
      for(let i=0;i<n;i++){
        const code = codes[i].toUpperCase();
        items.push({ currency: code, rate_to_pln: Number(rates[i]), is_default: code === "PLN" });
      }
      try{
        await apiPut("/api/v1/settings/currencies", { rates: items });
      }catch(e){
        const ce = $("currency-error"); if(ce){ ce.style.display=""; ce.textContent="blad zapisu kursow"; }
      }
    });


    // market data
    const marketState = { offset: 0, limit: 50, total: 0 };
    async function loadMarket(offset = 0){
      const err = $("market-error"); if(err){ err.style.display="none"; err.textContent=""; }
      const host = $("market-table"); if(host){ host.innerHTML = '<div class="hint">ladowanie...</div>'; }
      const params = new URLSearchParams();
      const mc = $("market-category")?.value || "";
      const me = ($("market-ean")?.value || "").trim();
      const md = $("market-date-val")?.value || "";
      const mddata = $("market-with-data-val")?.value === "1";
      const mdprof = $("market-profitable-val")?.value === "1";
      if(mc) params.append("category_id", mc);
      if(me) params.append("ean", me);
      if(md) params.append("updated_since", md);
      if(mddata) params.append("with_data", "1");
      if(mdprof) params.append("profitable_only", "1");
      params.append("offset", String(offset));
      params.append("limit", String(marketState.limit));
      try{
        const data = await apiGet("/api/v1/market-data?" + params.toString());
        marketState.offset = offset;
        marketState.total = Number(data?.total || 0) || 0;
        const rows = data?.items || data?.rows || data?.results || [];
        const meta = $("market-meta");
        if(meta){ meta.textContent = `rekordy: ${rows.length} / total: ${marketState.total} (offset ${marketState.offset})`; }
        if(!host) return;
        if(!rows.length){ host.innerHTML = '<div class="hint">brak danych dla filtrow</div>'; return; }
        host.innerHTML = `
          <div style="overflow:auto; border:1px solid var(--border2); border-radius:12px;">
            <table style="width:100%; border-collapse:collapse; min-width:960px;">
              <thead>
                <tr style="text-align:left; font-size:12px; color:var(--muted);">
                  <th style="padding:10px 12px; border-bottom:1px solid var(--border2);">ean</th>
                  <th style="padding:10px 12px; border-bottom:1px solid var(--border2);">nazwa</th>
                  <th style="padding:10px 12px; border-bottom:1px solid var(--border2);">koszt zakupu</th>
                  <th style="padding:10px 12px; border-bottom:1px solid var(--border2);">oplacalne</th>
                  <th style="padding:10px 12px; border-bottom:1px solid var(--border2);">cena</th>
                  <th style="padding:10px 12px; border-bottom:1px solid var(--border2);">sprzedanych</th>
                  <th style="padding:10px 12px; border-bottom:1px solid var(--border2);">updated</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r => `
                  <tr style="border-bottom:1px solid rgba(255,255,255,.06);">
                    <td style="padding:10px 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, \"Liberation Mono\", \"Courier New\", monospace;">${r.ean || ""}</td>
                    <td style="padding:10px 12px;">${(r.name || r.title || "").toString().slice(0,120)}</td>
                    <td style="padding:10px 12px;">${fmtPrice(r.purchase_price_pln ?? r.purchase_price)}</td>
                    <td style="padding:10px 12px;">${r.is_profitable === true ? "✔" : (r.is_profitable === false ? "✖" : "-")}</td>
                    <td style="padding:10px 12px;">${fmtPrice(r.allegro_price_pln ?? r.price_pln ?? r.price)}</td>
                    <td style="padding:10px 12px;">${r.sold_count ?? "-"}</td>
                    <td style="padding:10px 12px; color:var(--muted);">${r.last_checked_at ? new Date(r.last_checked_at).toLocaleString() : (r.updated_at ? new Date(r.updated_at).toLocaleString() : "-")}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `;
      }catch(e){
        if(err){ err.style.display=""; err.textContent="blad pobierania market data"; }
        if(host){ host.innerHTML = ""; }
      }
      updateMarketSummary();
    }
    $("market-next")?.addEventListener("click", ()=> loadMarket(marketState.offset + marketState.limit));
    $("market-prev")?.addEventListener("click", ()=> loadMarket(Math.max(0, marketState.offset - marketState.limit)));
    $("market-category")?.addEventListener("change", ()=> loadMarket(0));
    $("market-ean")?.addEventListener("change", ()=> loadMarket(0));
    $("market-ean")?.addEventListener("keydown", (e)=>{ if(e.key === "Enter"){ e.preventDefault(); loadMarket(0); }});

    // market filters modal

    function syncFiltersToModal(){
      if($("mf-date") && $("market-date-val")) $("mf-date").value = $("market-date-val").value || "";
      if($("mf-with-data") && $("market-with-data-val")) $("mf-with-data").checked = $("market-with-data-val").value === "1";
      if($("mf-profitable") && $("market-profitable-val")) $("mf-profitable").checked = $("market-profitable-val").value === "1";
    }
    function applyModalFilters(){
      if($("market-date-val") && $("mf-date")) $("market-date-val").value = $("mf-date").value;
      if($("market-with-data-val") && $("mf-with-data")) $("market-with-data-val").value = $("mf-with-data").checked ? "1" : "";
      if($("market-profitable-val") && $("mf-profitable")) $("market-profitable-val").value = $("mf-profitable").checked ? "1" : "";
    }
    mfOpen?.addEventListener("click", ()=>{ syncFiltersToModal(); openModal(mfModal); });
    mfClose?.addEventListener("click", ()=> closeModal(mfModal));
    mfReset?.addEventListener("click", ()=>{
      if($("mf-date")) $("mf-date").value = "";
      if($("mf-with-data")) $("mf-with-data").checked = false;
      if($("mf-profitable")) $("mf-profitable").checked = false;
    });
    mfApply?.addEventListener("click", async ()=>{
      applyModalFilters();
      closeModal(mfModal);
      await loadMarket(0);
    });

    function updateMarketSummary(){
      const parts = [];
      const catSel = $("market-category");
      const catVal = catSel?.value;
      const catLabel = catSel?.selectedOptions?.[0]?.textContent || "";
      const ean = $("market-ean")?.value;
      const dt = $("market-date-val")?.value;
      const wd = $("market-with-data-val")?.value === "1";
      const pr = $("market-profitable-val")?.value === "1";
      if(catVal) parts.push(`kategoria: ${catLabel || catVal}`);
      if(ean) parts.push(`ean: ${ean}`);
      if(dt) parts.push(`od: ${dt}`);
      if(wd) parts.push("tylko z danymi");
      if(pr) parts.push("tylko oplacalne");
      const summary = $("market-summary");
      if(summary){
        summary.textContent = parts.length ? `filtry: ${parts.join(", ")}` : "filtry: brak";
      }
    }

    // init
    (async function init(){
      await loadCategories();
      await loadSettings();
      await pollStatus();
      await pollActive();
      try{
        const meta = await loadProxyStatus();
        if(!meta || !meta.count){
          try{ await apiPost("/api/v1/proxies/reload", {}); }catch(_){}
          await loadProxyStatus();
        }
      }catch(_){}
      await loadCurrencies();
      await loadMarket(0);
      validateReady();
      // polling
      setInterval(pollStatus, 5000);
      setInterval(pollActive, 3000);
    })();
  </script>
</body>
</html>
