<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MVP: import i analiza produktów | Jolly Jesters</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0c1121;
      --panel: #0f172a;
      --panel-2: #0c172e;
      --accent: #22d3ee;
      --accent-2: #10b981;
      --text: #e7ebf5;
      --muted: #9aa8c3;
      --border: rgba(255,255,255,0.12);
      --border-soft: rgba(255,255,255,0.08);
      --danger: #f87171;
      --success: #34d399;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-7: 28px;
      --space-8: 32px;
      --font-sm: 13px;
      --font-md: 15px;
      --font-lg: 18px;
      --radius-card: 14px;
      --radius-control: 12px;
      --shadow: 0 14px 32px rgba(0,0,0,0.28);
      --page-max: 1240px;
      --page-max-wide: 1400px;
      --page-pad: 28px;
      --card-pad: 26px;
      --section-gap: 22px;
    }
    *, *::before, *::after { box-sizing: border-box; min-width: 0; }
    html {
      max-width: 100%;
      font-size: 16px;
      scroll-behavior: smooth;
      scroll-padding-top: 92px;
    }
    img, video, canvas { max-width: 100%; height: auto; }
    body {
      margin: 0;
      font-family: 'Space Grotesk', 'Segoe UI', system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(circle at 20% 18%, rgba(34, 211, 238, 0.06), transparent 32%),
        radial-gradient(circle at 82% 0%, rgba(16, 185, 129, 0.06), transparent 26%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      line-height: 1.55;
    }
    .page {
      max-width: var(--page-max);
      margin: 0 auto;
      padding: 28px var(--page-pad) 72px;
    }
    .page.is-wide { max-width: var(--page-max-wide); }
    .shell {
      position: relative;
      background: linear-gradient(180deg, rgba(18,27,48,0.94), rgba(10,17,34,0.94));
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-card);
      padding: var(--card-pad);
      box-shadow: var(--shadow);
    }
    @media (max-width: 480px) {
      :root { --page-pad: 16px; --card-pad: 20px; }
      .page { padding: 18px var(--page-pad) 88px; }
    }
    .top {
      display: flex;
      justify-content: space-between;
      gap: var(--space-4);
      align-items: flex-start;
      flex-wrap: wrap;
      padding-bottom: 6px;
    }
    .top > * { min-width: 0; }
    h1 { margin: 0; font-size: 30px; font-weight: 700; letter-spacing: -0.02em; line-height: 1.18; }
    h2 { margin: 0; font-size: 22px; font-weight: 700; line-height: 1.25; }
    p.lead { color: var(--muted); margin: 8px 0 0; font-size: 16px; line-height: 1.55; }
    .ghost-btn {
      background: transparent;
      border: 1px solid var(--border-soft);
      color: var(--text);
      padding: 12px 14px;
      min-height: 44px;
      border-radius: var(--radius-control);
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s, transform 0.2s;
      font-weight: 600;
      font-size: 14px;
    }
    .ghost-btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-1px); }
    .action-btn,
    .primary-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: linear-gradient(120deg, var(--accent-2), var(--accent));
      color: #fff;
      padding: 12px 18px;
      min-height: 44px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 15px;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 12px 30px rgba(34,211,238,0.18);
    }
    .action-btn:hover { transform: translateY(-1px); box-shadow: 0 12px 30px rgba(34,211,238,0.25); }
    .action-btn.secondary,
    .ghost-btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.15);
      color: var(--text);
      padding: 12px 14px;
      min-height: 44px;
      border-radius: 12px;
      font-weight: 600;
      box-shadow: none;
    }
    .action-btn.secondary:hover,
    .ghost-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
    }
    .action-btn:disabled, .primary-btn:disabled, .ghost-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .top-actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 9px 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.01em;
      min-width: 180px;
    }
    .status-pill .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: var(--success);
      box-shadow: 0 0 0 4px rgba(52, 211, 153, 0.15);
    }
    .status-pill.error { border-color: rgba(248,113,113,0.6); color: #fecaca; }
    .status-pill.error .status-dot { background: var(--danger); box-shadow: 0 0 0 4px rgba(248,113,113,0.15); }
    .button-row { display: flex; gap: var(--space-3); align-items: center; flex-wrap: wrap; justify-content: flex-end; }
    .button-row > * { min-width: 0; }
    .layout {
      margin-top: var(--section-gap);
      display: grid;
      gap: var(--section-gap);
      max-width: 100%;
    }
    .wiring-alert {
      display: none;
      margin: 12px 0;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid rgba(248,113,113,0.5);
      background: rgba(248,113,113,0.12);
      color: #fecaca;
      font-weight: 700;
    }
    .wizard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 18px;
      align-items: start;
      width: 100%;
      min-width: 0;
    }
    .wizard-stepper {
      position: sticky;
      top: 20px;
      align-self: start;
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      pointer-events: auto;
      z-index: 5;
    }
    .stepper-desktop { display: block; }
    .stepper-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: grid;
      gap: 6px;
    }
    .stepper-item {
      width: 100%;
      border: 1px solid var(--border);
      background: #0b152b;
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s, transform 0.15s;
    }
    .stepper-item .num {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(34,211,238,0.16);
      border: 1px solid rgba(34,211,238,0.45);
      font-weight: 700;
      color: var(--text);
    }
    .stepper-item.is-active {
      border-color: rgba(34,211,238,0.5);
      color: var(--accent);
      transform: translateX(2px);
      background: rgba(34,211,238,0.08);
    }
    .stepper-mobile { display: none; margin-top: 8px; }
    .stepper-mobile select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #0b152b;
      color: var(--text);
    }
    .stepper-mobile-nav {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .wizard-step {
      display: none;
      background: var(--panel-2);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-card);
      padding: 20px;
      margin-bottom: 12px;
      min-width: 0;
    }
    .wizard-step.is-active { display: block; }
    .wizard-form { display: grid; gap: 12px; min-width: 0; }
    .step-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 12px; flex-wrap: wrap; }
    .step-eyebrow { text-transform: uppercase; letter-spacing: 0.12em; color: var(--muted); font-size: 12px; margin: 0 0 6px; font-weight: 700; }
    .step-lead { color: var(--muted); margin: 4px 0 0; }
    .inline-summary { color: var(--muted); font-size: 13px; text-align: right; min-width: 160px; }
    .summary-panel {
      position: sticky;
      top: 20px;
      align-self: start;
      display: grid;
      gap: 12px;
      min-width: 0;
    }
    .summary-card {
      background: var(--panel-2);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      display: grid;
      gap: 10px;
    }
    .summary-card__header { display: flex; justify-content: space-between; align-items: center; gap: 8px; font-weight: 700; }
    .summary-list { display: grid; gap: 6px; font-size: 14px; }
    .summary-row { display: flex; justify-content: space-between; gap: 8px; color: var(--muted); }
    .summary-row strong { color: var(--text); max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .quick-actions-list { display: grid; gap: 8px; }
    .summary-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .wizard-main { min-width: 0; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    @media (max-width: 1100px) {
      .wizard-grid { grid-template-columns: 1fr; }
      .summary-panel { display: none; }
    }
    @media (max-width: 900px) {
      .top { flex-direction: column; align-items: flex-start; }
      .top-actions { width: 100%; justify-content: flex-start; }
    }
    @media (max-width: 768px) {
      .wizard-grid { grid-template-columns: 1fr; }
      .wizard-stepper { position: static; }
      .stepper-desktop { display: none; }
      .stepper-mobile { display: block; }
      .wizard-step { padding: 16px; }
    }
    @media (max-width: 640px) {
      body { padding: 28px 14px 88px; }
      .shell { padding: 20px 18px; }
    }
    @media (min-width: 1100px) {
      .filters-accordion {
        flex: 0 0 auto;
        padding: 0;
        border: none;
        background: transparent;
      }
      .filters-accordion summary { display: none; }
      .filters-row { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 0; }
    }
    .action-panel, .results-panel, .settings-panel-card {
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-card);
      background: rgba(16,24,44,0.82);
      padding: var(--card-pad);
      box-shadow: var(--shadow);
    }
    .dropzone {
      border: 1px dashed var(--border);
      border-radius: var(--radius-card);
      padding: 18px;
      min-height: 130px;
      max-height: 140px;
      max-width: 760px;
      background: rgba(34,211,238,0.04);
      text-align: center;
      color: var(--muted);
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s, color 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .dropzone:hover {
      border-color: var(--accent);
      color: var(--text);
      background: rgba(34,211,238,0.08);
    }
    .dropzone.is-dragover {
      border-color: var(--accent-2);
      background: rgba(16,185,129,0.12);
    }
    .quick-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 8px;
    }
    .preset-select { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid var(--border); background: #0b152b; color: var(--text); }
    .mini-summary { color: var(--muted); font-size: 13px; margin-top: 6px; }
    .results-panel .status-panel { margin-bottom: 12px; }
    .results-toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin: 12px 0;
    }
    .results-toolbar input {
      flex: 1 1 260px;
      min-width: 220px;
      padding: 12px 14px;
      border-radius: var(--radius-control);
      border: 1px solid var(--border);
      background: #0b152b;
      color: var(--text);
      font-size: 15px;
      min-height: 44px;
    }
    .filters-accordion {
      flex: 1 1 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 10px;
      background: #0b152b;
    }
    .filters-accordion summary {
      cursor: pointer;
      font-weight: 700;
      font-size: 14px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
      list-style: none;
    }
    .filters-accordion summary::-webkit-details-marker { display: none; }
    .filters-row { margin-top: 8px; }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      min-height: 36px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      transition: border-color 0.2s, background 0.2s, color 0.2s;
    }
    .chip.is-active {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(34,211,238,0.12);
    }
    .chip:hover { border-color: var(--accent); color: var(--accent); }
    .backend-alert {
      display: none;
      margin-bottom: 12px;
      border-radius: 12px;
      padding: 12px 14px;
      background: rgba(248,113,113,0.12);
      border: 1px solid rgba(248,113,113,0.4);
      color: #fecaca;
    }
    .results-table table thead th {
      position: sticky;
      top: 0;
      background: #0b152b;
      z-index: 2;
    }
    .results-table__inner { max-height: 480px; overflow: auto; }
    .card {
      background: rgba(18,26,46,0.86);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-card);
      padding: var(--card-pad);
      gap: 20px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.22);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    form { display: grid; gap: 18px; }
    @media (min-width: 980px) {
      .input-form {
        grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
        align-items: start;
      }
      .input-form > .backend-alert,
      .input-form > .dropzone,
      .input-form > .form-grid,
      .input-form > #settings-summary {
        grid-column: 1 / -1;
      }
      .input-form > .input-cta-bar {
        grid-column: 2 / 3;
        justify-content: flex-end;
      }
    }
    .is-hidden { display: none !important; }
    .row-wrap { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .control { min-height: 44px; }
    .btn { min-height: 40px; }
    label {
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.03em;
      color: #cfd7e8;
      text-transform: none;
      word-break: break-word;
      overflow-wrap: anywhere;
      display: inline-block;
      margin-bottom: 6px;
    }
    .step {
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-card);
      padding: 20px;
      background: #0b152b;
      display: grid;
      gap: 16px;
    }
    .step-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .step-header > * { min-width: 0; }
    .step-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 800;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.12em;
      color: var(--muted);
    }
    .step-badge {
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(34,211,238,0.15);
      border: 1px solid rgba(34,211,238,0.4);
      color: var(--text);
      font-weight: 700;
    }
    .step-inner {
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
      display: grid;
      gap: 16px;
    }
    .step-body { display: grid; gap: 12px; }
    .form-grid {
      display: grid;
      gap: 18px;
      align-items: start;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    }
    .form-grid.has-options {
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
    }
    .input-grid {
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
      align-items: start;
    }
    .form-grid.single {
      grid-template-columns: minmax(0, 1fr);
    }
    .form-grid > div { min-width: 0; }
    .minw-0 { min-width: 0; }
    .form-filters,
    .form-options {
      display: grid;
      gap: 14px;
      min-width: 0;
    }
    .mode-box { max-width: 560px; align-self: stretch; display: grid; gap: 12px; }
    .form-grid input,
    .form-grid select,
    .form-grid textarea {
      width: 100%;
      max-width: 100%;
      min-width: 0;
    }
    .form-grid button:not(.icon-btn):not(.ghost-btn):not(.action-btn):not(.primary-btn):not(.tab-btn) {
      width: 100%;
      max-width: 100%;
    }
    .form-grid .button-row { flex-wrap: wrap; }
    .form-cta {
      display: flex;
      justify-content: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .cta-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: auto;
      min-width: 220px;
      max-width: 100%;
      white-space: normal;
      text-align: center;
    }
    .btn--block {
      width: 100%;
    }
    .form-section-title {
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.08em;
      color: var(--muted);
      font-weight: 700;
    }
    .form-footer {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }
    .form-footer button,
    .form-footer a {
      max-width: 100%;
    }
    .form-empty {
      color: var(--muted);
      font-size: 13px;
    }
    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 800;
      font-size: 16px;
      padding: 2px 6px;
      line-height: 1;
      position: relative;
      top: -1px;
      border-radius: 999px;
      cursor: pointer;
      transition: background-color 0.15s ease, color 0.15s ease;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.12); color: var(--text); }
    select, input[type="file"], .checkboxes, input[type="number"], input[type="text"] {
      width: 100%;
      background: #0b152b;
      border: 1px solid var(--border);
      border-radius: var(--radius-control);
      padding: 12px 14px;
      color: var(--text);
      min-height: 44px;
      font-size: 0.95rem;
    }
    input::placeholder { color: rgba(255,255,255,0.45); }
    input[type="datetime-local"] {
      width: 100%;
      background: #0b152b;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--text);
    }
    select {
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position:
        calc(100% - 28px) center,
        calc(100% - 20px) center;
      background-size: 6px 6px,
                      6px 6px;
      background-repeat: no-repeat;
      padding-right: 48px;
    }
    input[type="file"], input[type="number"], input[type="text"] { appearance: auto; background-image: none; padding-right: 14px; }
    .helper {
      color: var(--muted);
      font-size: 13.5px;
      margin-top: 8px;
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere;
      line-height: 1.5;
    }
    #mode-helper { max-width: 520px; }
    .segmented {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-card);
      padding: 8px;
      background: #0f1a32;
    }
    .segmented label {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0 16px;
      font-weight: 700;
      cursor: pointer;
      color: var(--muted);
      transition: color 0.2s, background 0.2s, border-color 0.2s;
      text-transform: none;
      font-size: 15px;
      min-height: 44px;
      border-radius: var(--radius-control);
      flex: 1 1 140px;
      white-space: nowrap;
      border: 1px solid transparent;
      background: rgba(255,255,255,0.02);
    }
    .segmented label span { pointer-events: none; }
    .segmented input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .segmented input:checked + span {
      color: #0b152b;
      background: linear-gradient(120deg, rgba(34,211,238,0.22), rgba(16,185,129,0.22));
      border-radius: var(--radius-control);
      padding: 0 2px;
      border: 1px solid rgba(34,211,238,0.6);
      box-shadow: 0 6px 18px rgba(34,211,238,0.18);
      width: 100%;
      height: 100%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .tabs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      max-width: 100%;
    }
    .tabs.tabs-scroll {
      display: flex;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      gap: 8px;
      padding-bottom: 4px;
      scroll-snap-type: x proximity;
    }
    .tabs.tabs-scroll .tab-btn { flex: 0 0 auto; }
    .tab-panel {
      display: none;
      gap: 12px;
      min-width: 0;
    }
    .tab-panel.is-active { display: grid; }
    .tab-btn {
      background: #0b152b;
      border: 1px solid var(--border);
      color: var(--muted);
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 700;
      text-transform: uppercase;
      font-size: 13px;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s, transform 0.2s;
      scroll-snap-align: start;
      min-height: 40px;
    }
    .tab-btn:hover { border-color: var(--accent); color: var(--accent); transform: translateY(-1px); }
    .tab-btn.is-active {
      background: rgba(34,211,238,0.18);
      color: var(--text);
      border-color: rgba(34,211,238,0.4);
    }
    .source-panel {
      display: grid;
      gap: 10px;
      padding: 12px;
      border: 1px dashed rgba(148,163,184,0.35);
      border-radius: 12px;
      background: rgba(15,23,42,0.45);
    }
    .checkboxes { display: grid; gap: 10px; padding: 12px; }
    .checkboxes label {
      display: flex;
      align-items: center;
      gap: 8px;
      text-transform: none;
      color: var(--text);
      font-size: 15px;
      letter-spacing: 0;
    }
    .toggle-group { display: grid; gap: 10px; }
    .toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      color: var(--text);
    }
    .toggle input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .toggle__track {
      width: 42px;
      height: 24px;
      border-radius: 999px;
      background: #0b152b;
      border: 1px solid var(--border);
      position: relative;
      transition: background 0.2s, border-color 0.2s;
    }
    .toggle__track::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #94a3b8;
      top: 2px;
      left: 3px;
      transition: transform 0.2s, background 0.2s;
    }
    .toggle input:checked + .toggle__track {
      background: rgba(34,211,238,0.2);
      border-color: rgba(34,211,238,0.6);
    }
    .toggle input:checked + .toggle__track::after {
      transform: translateX(18px);
      background: var(--accent);
    }
    .toggle__label { font-weight: 600; }
    .accordion {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(15,23,42,0.6);
      overflow: hidden;
    }
    .accordion__header {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      color: var(--text);
      padding: 10px 12px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .accordion__body {
      padding: 10px 12px 12px;
      border-top: 1px solid var(--border);
      display: grid;
      gap: 8px;
    }
    .active-run {
      display: grid;
      gap: 6px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #0b152b;
    }
    .active-run__top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .active-run__top > * { min-width: 0; }
    .active-run__title { font-weight: 700; font-size: 14px; }
    .active-run__meta { color: var(--muted); font-size: 12px; }
    .active-run__actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .active-run__actions .action-btn,
    .active-run__actions .ghost-btn {
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 8px;
    }
    .currency-table {
      display: grid;
      gap: 8px;
      max-width: 100%;
    }
    .currency-row {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr) minmax(0, 1fr);
      gap: 8px;
      align-items: center;
    }
    .currency-row > * { min-width: 0; }
    .currency-row--head {
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .currency-rows { display: grid; gap: 6px; }
    .currency-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }
    @media (max-width: 720px) {
      .currency-row { grid-template-columns: 1fr 1fr; }
      .currency-actions { grid-column: 1 / -1; }
      .currency-row--head { display: none; }
    }
    @media (max-width: 480px) {
      .currency-row { grid-template-columns: 1fr; }
      .currency-actions { grid-column: auto; }
    }
    .primary-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: auto;
      min-width: 180px;
      max-width: 100%;
      white-space: normal;
      text-align: center;
      font-weight: 700;
    }
    .status-panel {
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-card);
      padding: 18px;
      background: #0b1327;
      display: grid;
      gap: 10px;
      word-break: break-word;
      overflow-wrap: anywhere;
      box-shadow: 0 10px 24px rgba(0,0,0,0.18);
    }
    .status-empty { color: var(--muted); }
    .status-details { display: grid; gap: 6px; }
    .status-row { display: flex; gap: 8px; margin-top: 6px; color: var(--muted); font-size: 14px; align-items: center; }
    .status-row > * { min-width: 0; }
    .status-spinner {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid rgba(148,163,184,0.4);
      border-top-color: var(--accent);
      animation: spin 0.9s linear infinite;
      display: none;
    }
    .status-spinner.is-active { display: inline-block; }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .status-log {
      margin-top: 8px;
      display: none;
      gap: 4px;
      max-height: 320px;
      overflow: auto;
      overflow-x: auto;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0b152b;
      font-size: 13px;
      color: var(--muted);
    }
    .status-card {
      margin-top: 8px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      background: #0b152b;
    }
    .status-config {
      margin: 4px 0 0;
      padding: 8px;
      background: #0d1a30;
      border-radius: 8px;
      border: 1px solid var(--border);
      overflow-x: auto;
      max-height: 160px;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
      color: var(--muted);
    }
    .status-log__item { color: var(--muted); }
    .status-log__item--error { color: var(--danger); }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(34, 211, 238, 0.12);
      border: 1px solid rgba(34, 211, 238, 0.4);
      padding: 8px 12px;
      border-radius: 999px;
      color: var(--text);
      font-weight: 700;
      letter-spacing: 0.01em;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .muted { color: var(--muted); }
    a.download {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 12px;
      color: var(--accent-2);
      text-decoration: none;
      font-weight: 700;
    }
    .error { color: var(--danger); margin-top: 8px; font-weight: 700; }
    .success { color: var(--success); margin-top: 6px; }
    .progress {
      width: 100%;
      background: #0b0f1f;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      height: 12px;
      margin-top: 8px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(120deg, var(--accent-2), var(--accent));
      width: 0%;
      transition: width 0.4s ease;
    }
    .section-title { margin: 0 0 8px; font-size: 18px; display: flex; justify-content: space-between; align-items: center; }
    .sidebar {
      transition: max-width 0.2s ease, width 0.2s ease, opacity 0.2s;
    }
    .layout > * { min-width: 0; }
    .layout > section,
    .layout > details {
      margin: 0;
      padding: 0;
    }
    .sidebar.collapsed {
      display: none;
    }
    .sidebar-toggle {
      cursor: pointer;
      border: 1px solid var(--border);
      background: #0b152b;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .sidebar-restore {
      position: absolute;
      right: 0;
      top: 110px;
      background: #0b152b;
      color: var(--text);
      border: 1px solid var(--border);
      padding: 10px 10px;
      border-radius: 12px 0 0 12px;
      cursor: pointer;
      display: none;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      font-size: 12px;
      letter-spacing: 0.05em;
    }
    .history-card {
      margin-top: 16px;
    }
    .history-card--analysis {
      max-width: none;
      margin-left: 0;
      margin-right: 0;
    }
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }
    .history-header > * { min-width: 0; }
    .history-list {
      margin-top: 10px;
      display: grid;
      gap: 10px;
    }
    .history-entry {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #0b152b;
      overflow: visible;
    }
    .history-row {
      padding: 10px;
      display: grid;
      grid-template-columns:
        minmax(0, 1.4fr)
        minmax(0, 1.1fr)
        minmax(0, 1fr)
        minmax(0, 0.9fr)
        minmax(0, 1fr);
      gap: 10px;
      align-items: center;
      cursor: pointer;
    }
    .history-row > * { min-width: 0; }
    .history-row:hover { background: rgba(255,255,255,0.02); }
    .history-row .history-actions {
      display: grid;
      gap: 8px;
      align-items: center;
      justify-items: end;
    }
    .history-buttons {
      display: grid;
      gap: 6px;
      width: 100%;
      max-width: 180px;
    }
    .history-buttons .action-btn,
    .history-buttons a.action-btn {
      width: 100%;
      justify-content: center;
    }
    @media (max-width: 980px) {
      .form-grid { grid-template-columns: 1fr; }
      .history-row { grid-template-columns: minmax(0, 1fr) minmax(0, 1fr); }
    }
    @media (max-width: 640px) {
      .history-row { grid-template-columns: minmax(0, 1fr); }
      .history-row .history-actions { justify-items: start; }
      .history-buttons { max-width: none; }
    }
    .history-row small { color: var(--muted); display: block; }
    .history-detail {
      display: none;
      padding: 0 12px 12px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 14px;
    }
    .history-detail strong { color: var(--text); }
    .history-error-line { color: var(--danger); margin-top: 6px; }
    .history-ops {
      position: relative;
      display: inline-flex;
      align-items: center;
    }
    .history-ops-menu {
      position: absolute;
      top: 120%;
      right: 0;
      background: #0b152b;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px;
      display: none;
      min-width: 180px;
      z-index: 20;
      box-shadow: 0 12px 30px rgba(0,0,0,0.35);
    }
    .history-ops-menu button {
      width: 100%;
      background: transparent;
      border: none;
      color: var(--text);
      text-align: left;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .history-ops-menu button:hover { background: rgba(255,255,255,0.08); color: var(--accent); }
    .history-ops-menu button.danger { color: #fca5a5; }
    .history-ops-menu button.danger:hover { color: #fecaca; }
    .history-ops.open .history-ops-menu { display: block; }
    .badge {
      padding: 3px 7px;
      border-radius: 999px;
      font-size: 11px;
      color: #fff;
      display: inline-block;
      overflow-wrap: anywhere;
    }
    .badge.pending { background: #f59e0b; }
    .badge.running { background: #22d3ee; }
    .badge.completed { background: #10b981; }
    .badge.failed { background: #ef4444; }
    .badge.canceled { background: #64748b; }
    .ghost-btn--small { padding: 8px 10px; font-size: 13px; }
    .history-row .action-btn {
      padding: 10px 12px;
      font-size: 13px;
      border-radius: 10px;
      min-height: 40px;
    }
    .history-row .ghost-btn {
      padding: 10px 12px;
      font-size: 13px;
      border-radius: 10px;
      min-height: 40px;
    }
    .market-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(0, 1fr));
      gap: 12px;
      align-items: start;
    }
    .market-filters > div { min-width: 0; }
    .market-actions {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
    }
    .market-table .table-scroll {
      max-height: 420px;
      overflow: auto;
    }
    .market-table table {
      min-width: 760px;
      width: 100%;
      table-layout: auto;
      font-size: 13px;
    }
    .market-table table th,
    .market-table table td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .market-table .cell-ean { width: 120px; }
    .market-table table th,
    .market-table table td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    .market-table table thead th {
      position: sticky;
      top: 0;
      background: #0b152b;
      z-index: 1;
    }
    .market-table .cell-num { text-align: right; white-space: nowrap; }
    .market-table .cell-date { white-space: nowrap; width: 160px; }
    .market-table .cell-source {
      white-space: nowrap;
      width: 110px;
      text-transform: uppercase;
      font-size: 12px;
      color: var(--muted);
    }
    .market-table .cell-name { min-width: 220px; max-width: 360px; }
    .market-table.is-compact table { min-width: 680px; }
    .market-table.is-compact th,
    .market-table.is-compact td {
      padding: 6px 8px;
      font-size: 12px;
    }
    .market-table.is-compact [data-col="ean"] {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
    }
    .market-table.is-compact [data-col="name"] {
      max-width: 240px;
      width: 240px;
    }
    @media (max-width: 900px) {
      .market-filters { grid-template-columns: 1fr; }
    }
    @media (max-width: 640px) {
      .market-filters { grid-template-columns: 1fr; }
    }
    .table-wrap {
      width: 100%;
      overflow-x: auto;
      max-width: 100%;
      -webkit-overflow-scrolling: touch;
    }
    [data-col].is-hidden { display: none; }
    .table-wrap > div {
      display: inline-block;
      min-width: 100%;
      vertical-align: top;
    }
    .table-wrap table {
      width: 100%;
      border-collapse: collapse;
    }
    .table-scroll {
      overflow: auto;
      max-height: 60vh;
    }
    .results-modal .table-scroll {
      max-height: none;
      overflow: visible;
    }
    .results-table {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: visible;
    }
    .results-table table { min-width: 720px; width: 100%; border-collapse: collapse; font-size: 14px; }
    .results-table th,
    .results-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      vertical-align: top;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .results-table.is-compact table { min-width: 640px; }
    .results-table.is-compact th,
    .results-table.is-compact td {
      padding: 6px 8px;
      font-size: 12px;
    }
    .results-table.is-compact [data-col="ean"] {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 11px;
    }
    .results-table.is-compact [data-col="name"] {
      max-width: 260px;
      width: 260px;
    }
    .results-table tbody tr:hover { background: rgba(255,255,255,0.02); cursor: pointer; }
    .results-detail { background: #0b152b; color: var(--muted); cursor: default; }
    .results-detail td {
      white-space: normal;
      overflow: visible;
      text-overflow: unset;
    }
    .results-pagination {
      margin-top: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .export-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 12px;
    }
    .results-pagination > * { min-width: 0; }
    .results-meta { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 6px; }
    .status-chip {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      display: inline-block;
      overflow-wrap: anywhere;
      word-break: break-word;
    }
    .status-chip.pending { background: rgba(245,158,11,0.2); color: #fbbf24; }
    .status-chip.in_progress { background: rgba(34,211,238,0.2); color: #67e8f9; }
    .status-chip.ok { background: rgba(16,185,129,0.2); color: #a7f3d0; }
    .status-chip.error { background: rgba(239,68,68,0.15); color: var(--danger); }
    .status-chip.blocked { background: rgba(239,68,68,0.2); color: #fca5a5; }
    .status-chip.network_error { background: rgba(148,163,184,0.2); color: #e2e8f0; }
    .status-chip.not_found { background: rgba(245,158,11,0.15); color: #fbbf24; }
    .source-chip {
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(34,211,238,0.12);
      color: var(--text);
      font-size: 12px;
      border: 1px solid var(--border);
    }
    .detail-grid { display: grid; gap: 8px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); overflow-wrap: anywhere; }
    .detail-grid > * { min-width: 0; }
    @media (max-width: 768px) {
      .detail-grid { grid-template-columns: minmax(0, 1fr); }
    }
    .results-empty { color: var(--muted); margin-top: 12px; }
    .results-banner {
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(100,116,139,0.4);
      background: rgba(100,116,139,0.15);
      color: #e2e8f0;
      font-weight: 600;
    }
    .currency-row input {
      width: 100%;
      background: #0b152b;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      color: var(--text);
    }
    .currency-row input::placeholder { color: var(--muted); }
    .currency-row input.currency-code { max-width: 100%; }
    .currency-row input.currency-rate { max-width: 100%; }
    .categories-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .categories-list .ghost-btn--small {
      padding: 6px 8px;
      font-size: 12px;
    }
    #add-category-btn {
      padding: 6px 10px;
      font-size: 12px;
    }
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55);
      padding: 16px;
      z-index: 1100;
    }
    .modal-content {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      width: min(100vw - 32px, 520px);
      max-height: min(100vh - 32px, 900px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .modal-content.modal-lg { width: min(calc(98vw - 32px), 1400px); }
    @media (max-width: 992px) {
      .modal-content.modal-lg { width: min(calc(100vw - 24px), 980px); }
    }
    .modal-content.modal-md { width: min(100vw - 32px, 720px); }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 20px 20px 0;
      flex-wrap: wrap;
    }
    .modal-header > * { min-width: 0; }
    .modal-body {
      padding: 16px 20px 20px;
      overflow: auto;
      min-height: 0;
      display: grid;
      gap: 12px;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 12px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }
    .modal-header .modal-actions { margin-top: 0; }
    .close-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
    }
    .faq-modal { z-index: 1000; }
    .faq-content h2 { margin-top: 0; }
    .faq-item { margin-top: 12px; }
    .faq-item strong { display: block; margin-bottom: 4px; }
    .settings-block {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      background: #0b152b;
      display: grid;
      gap: 12px;
      margin-top: 16px;
    }
    .settings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .settings-header > * { min-width: 0; }
    .settings-header .ghost-btn--small { margin-top: 8px; }
    .column-picker {
      display: grid;
      gap: 12px;
    }
    .column-picker__actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .settings-panel {
      display: grid;
      gap: 16px;
    }
    .settings-actions {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .results-step { margin-top: 16px; }
    .section-heading {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }
    .section-heading h2 { margin: 0 0 6px; font-size: 1.25rem; font-weight: 700; }
    .section-heading .step-lead { margin: 0 0 14px; }
    .input-card, .status-card, .results-card, .history-card, .advanced-card, .market-card {
      width: 100%;
    }
    .input-card { padding-bottom: 20px; }
    @media (max-width: 900px) {
      .input-card { padding-bottom: calc(40px + env(safe-area-inset-bottom)); }
    }
    .input-form .form-grid { margin-top: 12px; }
    .status-panel { max-width: 100%; }
    .status-row span, .status-row strong, .pill { overflow-wrap: anywhere; word-break: break-word; }
    .status-log { max-height: 240px; }
    .copyable { cursor: pointer; }
    .input-cta-bar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 12px;
      padding: 0;
      border: none;
      border-radius: var(--radius-card);
      background: transparent;
      position: static;
      box-shadow: none;
      pointer-events: auto;
    }
    .input-cta-bar .cta-left { min-width: 0; flex: 1; }
    .input-cta-bar .cta-right { display: flex; align-items: center; gap: 10px; }
    @media (max-width: 900px) {
      .input-cta-bar {
        position: sticky;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 14px 16px;
        padding-bottom: calc(14px + env(safe-area-inset-bottom));
        background: rgba(10, 18, 34, 0.78);
        border: 1px solid rgba(148,163,184,0.28);
        box-shadow: 0 -10px 26px rgba(0,0,0,0.32);
        backdrop-filter: blur(6px);
        justify-content: space-between;
        align-items: center;
        gap: 12px;
      }
      .input-cta-bar .cta-right { width: 100%; }
      #submit-btn { width: 100%; min-width: 0; }
    }
    .start-spinner {
      display: none;
      width: 16px;
      height: 16px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.35);
      border-top-color: #fff;
      animation: spin 0.8s linear infinite;
    }
    .start-spinner.is-active { display: inline-block; }
    @media (max-width: 640px) {
      .input-cta-bar { position: sticky; bottom: 0; left: 0; right: 0; flex-direction: column; align-items: stretch; }
      .input-cta-bar .cta-right { width: 100%; }
      #submit-btn { width: 100%; min-width: 0; }
    }
  </style>
</head>
<body>
  <div class="page" id="page">
  <div class="shell" data-i18n-auto="1" id="shell">
    <button class="sidebar-restore" id="sidebar-restore">Panel</button>
    <div class="top">
      <div>
        <h1 id="page-title" data-i18n="title-main">MVP: import i analiza produktów</h1>
        <p id="page-lead" class="lead" data-i18n="lead-main">Wgraj plik, wybierz kategorię i uruchom analizę. Zaawansowane opcje są w Ustawieniach.</p>
      </div>
      <div class="top-actions">
        <div class="status-pill" id="scraper-status" title="Status backendu i tryb scrapera">
          <span class="status-dot" id="scraper-status-dot"></span>
          <span id="scraper-status-text">Sprawdzanie statusu…</span>
        </div>
        <div class="button-row">
          <button class="ghost-btn" id="faq-btn" data-i18n="faq-button">FAQ / pomoc</button>
          <button class="ghost-btn" id="logout-btn" type="button">Wyloguj</button>
        </div>
      </div>
  </div>

    <div class="wiring-alert" id="wiring-alert"></div>

    <div class="layout" id="layout">
      <section class="card input-card" id="input-card">
        <div class="section-heading">
          <div>
            <p class="step-eyebrow">Dane wejściowe</p>
            <h2>Dane wejściowe</h2>
            <p class="step-lead">Plik + kategoria + tryb. Start od razu, bez kolejnych kroków.</p>
          </div>
          <button type="button" class="ghost-btn" id="advanced-toggle">Ustawienia zaawansowane ⚙</button>
        </div>
        <form id="upload-form" class="wizard-form input-form" novalidate>
          <div class="backend-alert" id="backend-alert">
            Brak połączenia z backendem. Sprawdź sieć lub spróbuj ponownie.
          </div>
          <div class="dropzone" id="dropzone">
            <strong>Upuść plik Excel tutaj</strong><br/>
            <span class="muted">lub kliknij, aby wybrać</span>
          </div>
          <div class="form-grid has-options input-grid">
            <div class="form-filters">
              <div>
                <label for="category-select" style="display:flex; align-items:center; gap:8px;">
                  <span data-i18n="label-category">Kategoria</span>
                  <button type="button" class="icon-btn" id="main-add-category" title="Dodaj nową kategorię">+</button>
                </label>
                <select id="category-select" name="category_id" required></select>
                <div class="helper" id="category-info"></div>
                <div class="error" id="category-select-error"></div>
              </div>
              <div>
                <label for="file-input" data-i18n="label-file">Plik (CSV/XLSX)</label>
                <input id="file-input" type="file" name="file" accept=".xlsx,.xls,.csv" />
                <div class="helper" data-i18n="helper-file">Obsługiwane formaty: .xlsx, .xls, .csv</div>
                <div class="error" id="file-error"></div>
              </div>
            </div>
            <div class="form-options mode-box">
              <label data-i18n="label-mode">Tryb scrapera</label>
              <div class="segmented" role="group" aria-label="Tryb analizy">
                <label>
                  <input type="radio" name="mode" value="online" />
                  <span>Online</span>
                </label>
                <label>
                  <input type="radio" name="mode" value="mixed" checked />
                  <span>Mixed</span>
                </label>
                <label>
                  <input type="radio" name="mode" value="offline" />
                  <span>Offline</span>
                </label>
              </div>
              <div class="helper" id="mode-helper">online: zawsze live · mixed: baza + dogrywka braków online · offline: tylko baza, bez scrapowania</div>
            </div>
          </div>
          <div class="input-cta-bar" id="input-cta-bar">
            <div class="cta-left">
              <div class="error" id="start-hint"></div>
            </div>
            <div class="cta-right">
              <button type="button" id="submit-btn" class="primary-btn cta-btn">
                <span class="start-label">Start analizy</span>
                <span class="start-spinner" aria-hidden="true"></span>
              </button>
            </div>
          </div>
          <div class="helper" id="settings-summary"></div>
        </form>
      </section>

      <section class="card status-card" id="status-section">
        <div class="section-heading">
          <div>
            <p class="step-eyebrow">Bieżąca analiza</p>
            <h2 id="current-analysis-title" tabindex="-1">Bieżąca analiza</h2>
            <p class="step-lead">Status, postęp i log zawsze widoczne.</p>
          </div>
        </div>
        <div class="status-panel" id="status-panel">
          <div class="status-empty" id="status-empty" data-i18n="status-empty">Brak aktywnej analizy.
            <div class="button-row" style="margin-top:8px;">
              <button class="action-btn secondary" type="button" id="status-start-btn">Start</button>
            </div>
          </div>
          <div class="status-details" id="status-details" style="display:none;">
            <div class="pill"><span data-i18n="label-run-id">Run ID:</span> <span id="run-id" class="copyable" title="Kliknij, aby skopiować"></span></div>
            <div class="pill" id="run-stage">Gotowe do startu</div>
            <div class="status-row">
              <strong data-i18n="label-status">Status:</strong>
              <span id="run-status"></span>
              <span class="status-spinner" id="status-spinner" aria-hidden="true"></span>
            </div>
            <div class="status-row"><strong data-i18n="label-progress">Postęp:</strong> <span id="run-progress"></span></div>
            <div class="status-row"><strong>Scraper:</strong> <span id="run-scraper">—</span></div>
            <div class="status-row"><strong data-i18n="label-updated">Ostatnia aktualizacja:</strong> <span id="run-updated">—</span></div>
            <div class="progress"><div class="progress-bar" id="progress-bar"></div></div>
            <div class="status-row"><strong data-i18n="label-error">Błąd:</strong> <span id="run-error" class="error"></span></div>
            <div class="button-row" id="status-actions" style="margin-top:8px; display:none;">
              <button class="action-btn secondary" type="button" id="cancel-run-btn" data-i18n="btn-cancel">Anuluj</button>
              <button class="action-btn" id="status-go-results" type="button">Przejdź do wyników</button>
              <button class="ghost-btn" type="button" id="status-new-run">Nowa analiza</button>
            </div>
            <div id="report-links" style="display:none; margin-top:8px; gap:12px; align-items:center; flex-wrap:wrap;" class="button-row">
              <button class="action-btn" id="preview-link" type="button" data-i18n="btn-preview">Podgląd wyników</button>
              <a class="action-btn secondary" id="download-link" href="#" data-i18n="btn-download">⬇ Pobierz raport</a>
            </div>
            <details class="status-card" id="config-details">
              <summary class="ghost-btn" style="width:max-content;">Pokaż effective config</summary>
              <pre class="status-config" id="effective-config">—</pre>
            </details>
            <details class="status-log" id="status-log-wrapper">
              <summary class="ghost-btn" style="width:max-content;">Pokaż log</summary>
              <div class="status-log" id="status-log" aria-live="polite" style="display:block;"></div>
            </details>
          </div>
        </div>
      </section>

      <section class="card results-card" id="results-section" hidden>
        <div class="section-heading">
          <div>
            <p class="step-eyebrow">Wyniki</p>
            <h2>Wyniki</h2>
            <p class="step-lead">Podgląd i eksport bez zmiany kroku.</p>
          </div>
        </div>
        <div class="tabs" id="results-tabs">
          <button type="button" class="tab-btn is-active" data-tab="preview">Podgląd</button>
          <button type="button" class="tab-btn" data-tab="export">Eksport</button>
        </div>
        <div class="tab-panel is-active" data-tab-panel="preview">
          <div class="results-toolbar">
            <input type="search" id="results-search" placeholder="Szukaj EAN / nazwa" />
            <details class="filters-accordion" open>
              <summary>Filtry</summary>
              <div class="row-wrap filters-row">
                <button class="chip" data-filter="profitable" id="chip-profitable">Tylko opłacalne</button>
                <button class="chip" data-filter="errors" id="chip-errors">Tylko błędy</button>
                <button class="chip" data-filter="missing-price" id="chip-missing">Brak ceny</button>
                <button class="ghost-btn ghost-btn--small" id="copy-failed-btn" type="button">Kopiuj EAN-y nieudane</button>
              </div>
            </details>
          </div>
          <div class="error" id="results-error"></div>
          <div class="results-empty" id="results-empty" style="display:none;">
            Brak wyników do pokazania.
            <div class="button-row" style="margin-top:8px;">
              <button class="ghost-btn" type="button" id="results-back">Wróć do bieżącej analizy</button>
            </div>
          </div>
          <div class="table-wrap">
            <div class="results-table" id="results-table"></div>
          </div>
          <div class="results-pagination">
            <button class="ghost-btn ghost-btn--small" id="results-prev" type="button">◀ Wstecz</button>
            <span class="muted" id="results-page-info"></span>
            <button class="ghost-btn ghost-btn--small" id="results-next" type="button">Dalej ▶</button>
          </div>
        </div>
        <div class="tab-panel" data-tab-panel="export">
          <div class="export-actions">
            <button class="action-btn" id="export-xlsx" type="button" disabled>Pobierz raport XLSX</button>
            <button class="action-btn secondary" id="export-csv" type="button" disabled>Pobierz raport CSV</button>
            <button class="ghost-btn" id="copy-report-link" type="button" disabled>Kopiuj link do raportu</button>
            <div class="helper" id="export-meta"></div>
          </div>
        </div>
      </section>

      <section class="card history-card history-card--analysis" id="history-section" hidden>
        <div class="section-heading">
          <div>
            <p class="step-eyebrow">Historia</p>
            <h2>Historia</h2>
            <p class="step-lead">Ostatnie runy, bez przełączania widoków.</p>
          </div>
        </div>
        <div class="history-list" id="history-list"></div>
        <div class="helper" id="history-empty" style="display:none;">Brak wcześniejszych analiz.</div>
        <div class="helper" id="history-error" style="display:none;">Nie udało się pobrać historii.</div>
      </section>

      <details class="card advanced-card" id="settings-details">
        <summary class="section-heading" style="cursor:pointer;">
          <div>
            <p class="step-eyebrow">Advanced</p>
            <h2>Ustawienia zaawansowane (opcjonalne)</h2>
            <p class="step-lead">Opcje rzadziej używane. Zwijane, by nie mieszać UI.</p>
          </div>
        </summary>
        <div class="settings-block settings-panel-card" id="settings-block">
          <div class="settings-panel" id="settings-panel">
            <div class="helper" id="settings-info"></div>
            <div class="error" id="settings-error"></div>
            <div class="card">
              <h3 class="section-title">Parametry analizy</h3>
              <div class="form-grid has-options">
                <div>
                  <label for="cache-ttl">Maks. wiek danych (dni)</label>
                  <div class="slider-inline">
                    <input type="range" id="cache-ttl" min="1" max="365" value="30" />
                    <input type="number" id="cache-ttl-input" min="1" max="365" value="30" />
                  </div>
                  <div class="helper">Dotyczy online/mixed. Krótszy = więcej dogrywki live.</div>
                  <div class="form-cta" style="margin-top:6px;">
                    <button type="button" class="ghost-btn ghost-btn--small" id="save-ttl-btn">Zapisz TTL</button>
                  </div>
                </div>
                <div>
                  <label for="offer-limit">Limit wyników</label>
                  <input type="number" id="offer-limit" min="0" placeholder="np. 500" />
                  <div class="helper">0 lub puste = bez limitu.</div>
                </div>
              </div>
            </div>
            <div class="tabs tabs-scroll" id="settings-tabs">
              <button type="button" class="tab-btn is-active" data-tab="history" data-i18n="tab-history">Historia i dane</button>
              <button type="button" class="tab-btn" data-tab="display">Widok</button>
              <button type="button" class="tab-btn" data-tab="meta">Meta</button>
            </div>
            <div class="tab-panel is-active" data-tab-panel="history">
              <div class="card">
                <h3 class="section-title">Analiza z bazy</h3>
                <div class="form-grid has-options">
                  <div class="form-filters">
                    <div class="form-section-title">Parametry</div>
                    <div>
                      <label for="db-last-days">Ostatnie dni cache</label>
                      <input type="number" id="db-last-days" min="1" max="365" value="30" />
                      <div class="helper">Zakres danych do analizy (dni wstecz).</div>
                    </div>
                    <div>
                      <label for="db-limit">Limit pozycji</label>
                      <input type="number" id="db-limit" min="1" max="10000" placeholder="np. 200" />
                      <div class="helper">Ogranicza liczbę rekordów do analizy.</div>
                    </div>
                    <div>
                      <label for="db-ean-contains">EAN zawiera</label>
                      <input type="text" id="db-ean-contains" placeholder="np. 590" />
                      <div class="helper">Pozwala zawęzić listę do fragmentu EAN.</div>
                    </div>
                  </div>
                  <div class="form-options">
                    <div class="form-section-title">Opcje</div>
                    <div class="toggle-group">
                      <div>
                        <label class="toggle">
                          <input type="checkbox" id="db-only-success" />
                          <span class="toggle__track"></span>
                          <span class="toggle__label">Tylko produkty z danymi</span>
                        </label>
                        <div class="helper">Pomiń wpisy bez ceny/sprzedaży.</div>
                      </div>
                      <div>
                        <label class="toggle">
                          <input type="checkbox" id="db-all-cached" />
                          <span class="toggle__track"></span>
                          <span class="toggle__label">Wszystkie zapisane produkty</span>
                        </label>
                        <div class="helper">Ignoruje pole „Ostatnie dni cache”.</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="form-footer">
                  <div class="helper" id="db-info">Uruchamia analizę na danych zapisanych w bazie (bez pliku). Używa kategorii wybranej w danych wejściowych.</div>
                  <div class="form-cta">
                    <button type="button" id="start-db-btn" class="action-btn cta-btn" data-i18n="btn-start-db">Start analizy z bazy</button>
                  </div>
                  <div class="error" id="db-error"></div>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h3 class="section-title">Kursy walut</h3>
                  <button type="button" class="ghost-btn ghost-btn--small" id="add-currency-btn">+ Dodaj walutę</button>
                </div>
                <div class="helper">Stawki konwersji do PLN na potrzeby raportów.</div>
                <div class="currency-list" id="currency-list"></div>
                <div class="helper" id="currency-helper"></div>
                <div class="success" id="currency-success"></div>
                <div class="error" id="currency-error"></div>
                <div class="form-cta" style="margin-top:12px;">
                  <button type="button" class="action-btn secondary" id="save-currencies-btn">Zapisz kursy</button>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h3 class="section-title">Kategorie</h3>
                  <button type="button" class="ghost-btn ghost-btn--small" id="add-category-btn">+ Dodaj kategorię</button>
                </div>
                <div class="helper">Zarządzaj kategoriami używanymi przy imporcie.</div>
                <div class="categories-list" id="categories-list"></div>
                <div class="success" id="category-success"></div>
                <div class="error" id="category-error"></div>
              </div>
            </div>
            <div class="tab-panel" data-tab-panel="display">
              <div class="card">
                <h3 class="section-title">Widok tabel</h3>
                <div class="column-picker">
                  <div>
                    <div class="form-section-title">Tryb kompaktowy</div>
                    <label class="toggle">
                      <input type="checkbox" id="compact-table-toggle" />
                      <span class="toggle__track"></span>
                      <span class="toggle__label">Tryb kompaktowy tabel</span>
                    </label>
                    <div class="helper">Zmniejsza padding i szerokości kolumn EAN/Nazwa.</div>
                  </div>
                  <div>
                    <div class="form-section-title">Kolumny - Wyniki analizy</div>
                    <div class="checkboxes" id="results-columns"></div>
                    <div class="column-picker__actions">
                      <button type="button" class="ghost-btn ghost-btn--small" id="results-columns-reset">Przywróć domyślne</button>
                    </div>
                  </div>
                  <div>
                    <div class="form-section-title">Kolumny - Baza Allegro</div>
                    <div class="checkboxes" id="market-columns"></div>
                    <div class="column-picker__actions">
                      <button type="button" class="ghost-btn ghost-btn--small" id="market-columns-reset">Przywróć domyślne</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-panel" data-tab-panel="meta">
              <div class="card">
                <h3 class="section-title">Język UI</h3>
                <div class="form-grid single">
                  <div>
                    <label>Aktualny język</label>
                    <button type="button" class="ghost-btn" id="lang-toggle">Przełącz PL / EN</button>
                    <div class="helper">Ustawienie lokalne (localStorage).</div>
                  </div>
                  <div>
                    <label>Szerokość widoku</label>
                    <button type="button" class="ghost-btn" id="width-toggle">Comfort width</button>
                    <div class="helper">Przełącz między comfort / wide tylko dla Ciebie.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </details>

      <details class="card market-card" id="market-details">
        <summary class="section-heading" style="cursor:pointer;">
          <div>
            <p class="step-eyebrow">Baza Allegro / Market</p>
            <h2>Baza Allegro</h2>
            <p class="step-lead">Schowane, by nie mieszać podstawowego flow.</p>
          </div>
        </summary>
        <div class="form-grid single">
          <div class="form-filters">
            <div class="market-filters">
              <div>
                <label for="market-category">Kategoria</label>
                <select id="market-category">
                  <option value="">Dowolna</option>
                </select>
                <div class="helper">Filtrowanie po wybranej kategorii.</div>
              </div>
              <div>
                <label for="market-ean">EAN</label>
                <input id="market-ean" type="text" placeholder="fragment EAN" />
                <div class="helper">Może być fragmentem kodu.</div>
              </div>
              <div>
                <label for="market-source">Źródło danych</label>
                <select id="market-source">
                  <option value="">Dowolna</option>
                  <option value="local">Local Selenium</option>
                  <option value="scraping">Scraping (inne)</option>
                </select>
                <div class="helper">Skąd pochodziły dane rynkowe.</div>
              </div>
              <div>
                <label for="market-date">Od kiedy</label>
                <input id="market-date" type="datetime-local" />
                <div class="helper">Filtruj po dacie aktualizacji.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-footer">
          <div class="form-cta">
            <button class="action-btn cta-btn" id="market-search" type="button">Szukaj</button>
            <button class="ghost-btn ghost-btn--small" id="market-reset" type="button">Reset</button>
          </div>
        </div>
        <div id="market-error" class="error"></div>
        <div class="table-wrap">
          <div class="results-table market-table" id="market-table"></div>
        </div>
        <div class="results-pagination">
          <button class="ghost-btn ghost-btn--small" id="market-prev" type="button">◀ Wstecz</button>
          <span class="muted" id="market-page-info"></span>
          <button class="ghost-btn ghost-btn--small" id="market-next" type="button">Dalej ▶</button>
        </div>
      </details>

    </div>
  </div>

  </div>
  </div>

  <div class="modal" id="category-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin:0;">Dodaj nową kategorię</h3>
      </div>
      <div class="modal-body">
        <form id="category-modal-form">
          <div class="form-grid single">
            <div class="form-filters">
              <div class="form-section-title">Zakres / filtry danych</div>
              <div>
                <label for="modal-cat-name">Nazwa kategorii</label>
                <input type="text" id="modal-cat-name" name="name" required />
              </div>
              <div>
                <label for="modal-cat-multiplier">Mnożnik opłacalności</label>
                <input type="number" id="modal-cat-multiplier" name="profitability_multiplier" step="0.01" min="0" value="1.5" required />
              </div>
              <div>
                <label for="modal-cat-commission">Prowizja Allegro (%)</label>
                <input type="number" id="modal-cat-commission" name="commission_rate" step="0.01" min="0" value="0" />
              </div>
            </div>
          </div>
          <div class="form-footer">
            <div class="error" id="category-modal-error"></div>
            <div class="modal-actions">
              <button type="button" class="close-btn" id="category-cancel">Anuluj</button>
              <button type="submit" class="primary-btn">Dodaj kategorię</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal" id="category-detail-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 style="margin:0;">Szczegóły kategorii</h3>
      </div>
      <div class="modal-body">
        <form id="category-detail-form">
          <div class="form-grid single">
            <div class="form-filters">
              <div class="form-section-title">Zakres / filtry danych</div>
              <div>
                <label for="detail-cat-name">Nazwa kategorii</label>
                <input type="text" id="detail-cat-name" name="name" required />
              </div>
              <div>
                <label for="detail-cat-multiplier">Mnożnik opłacalności</label>
                <input type="number" id="detail-cat-multiplier" name="profitability_multiplier" step="0.01" min="0" required />
              </div>
              <div>
                <label for="detail-cat-commission">Prowizja Allegro (%)</label>
                <input type="number" id="detail-cat-commission" name="commission_rate" step="0.01" min="0" />
              </div>
            </div>
          </div>
          <div class="form-footer">
            <div class="error" id="category-detail-error"></div>
            <div class="success" id="category-detail-success"></div>
            <div class="modal-actions">
              <button type="button" class="close-btn" id="category-detail-cancel">Anuluj</button>
              <button type="submit" class="action-btn">Zapisz</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal faq-modal" id="faq-modal">
    <div class="modal-content modal-md faq-content">
      <div class="modal-header">
        <h2 style="margin:0;">FAQ - jak korzystać z systemu</h2>
        <div class="modal-actions">
          <button class="close-btn" id="faq-close">Zamknij</button>
        </div>
      </div>
      <div class="modal-body">
        <div class="faq-item">
          <strong>Różnice między trybami Online, Mixed, Offline</strong>
          <div>Online – zawsze live. Mixed – baza + dogrywka braków online. Offline – tylko baza, bez scrapowania.</div>
        </div>
        <div class="faq-item">
          <strong>Źródła danych (Local Selenium)</strong>
          <div>Local Selenium – lokalny scraper z przeglądarką. W trybie Tylko baza scrapowanie jest wyłączone.</div>
        </div>
        <div class="faq-item">
          <strong>Jak dodać nową kategorię</strong>
          <div>Użyj przycisku „+” w sekcji Kategorie i wypełnij formularz.</div>
        </div>
        <div class="faq-item">
          <strong>Jakie pliki są obsługiwane</strong>
          <div>CSV, XLS, XLSX. Wymagane kolumny: EAN, Name, PurchasePrice.</div>
        </div>
        <div class="faq-item">
          <strong>Co zrobić, gdy analiza kończy się błędem</strong>
          <div>Sprawdź komunikat w sekcji statusu. Upewnij się, że kategoria jest aktywna oraz że w Ustawieniach masz wybrane źródła danych (jeśli tryb nie jest „Tylko baza”).</div>
        </div>
        <div class="faq-item">
          <strong>Co oznaczają pola kategorii: nazwa, mnożnik opłacalności i prowizja Allegro?</strong>
          <div>
            <div><em>Nazwa kategorii</em> – dowolna nazwa, która pozwala Ci rozpoznać grupę produktów, np. „Perfumy”, „Chemia gospodarcza”, „Zabawki”.</div>
            <div><em>Mnożnik opłacalności</em> – minimalny docelowy zwrot z inwestycji (marża względem ceny zakupu). Przykład: jeżeli ustawisz mnożnik 1,5, to system oznaczy produkt jako „opłacalny” tylko wtedy, gdy po odjęciu prowizji Allegro zarobek będzie co najmniej 50% ceny zakupu.</div>
            <div><em>Prowizja Allegro (%)</em> – szacowany procent prowizji Allegro w danej kategorii. System odejmuje tę prowizję od ceny sprzedaży i dopiero z tej „netto” ceny liczy marżę.</div>
            <div>Dzięki temu opłacalność jest liczona dla każdej kategorii inaczej – np. jeśli w jednej kategorii prowizja jest wyższa, próg opłacalności jest automatycznie bardziej wymagający. Każda analiza jest powiązana z jedną kategorią, a każda kategoria ma własne parametry, więc możesz osobno ustawić logikę dla „Perfum” vs „Chemii” itp.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const categorySelect = document.getElementById('category-select');
    const categoryInfo = document.getElementById('category-info');
    const categorySelectError = document.getElementById('category-select-error');
    const fileError = document.getElementById('file-error');
    const categoriesList = document.getElementById('categories-list');
    const scraperStatus = document.getElementById('scraper-status');
    const scraperStatusText = document.getElementById('scraper-status-text');
    const scraperStatusDot = document.getElementById('scraper-status-dot');
    const form = document.getElementById('upload-form');
    const errorBox = document.getElementById('error');
    const startHint = document.getElementById('start-hint');
    const strategyError = document.getElementById('strategy-error');
    const strategyOfflineHint = document.getElementById('strategy-offline-hint');
    const submitBtn = document.getElementById('submit-btn');
    const panel = document.getElementById('status-panel');
    const statusEmpty = document.getElementById('status-empty');
    const statusDetails = document.getElementById('status-details');
    const resultsStep = document.getElementById('results-step');
    const fileInput = document.getElementById('file-input');
    const dropzone = document.getElementById('dropzone');
    const modeHelper = document.getElementById('mode-helper');
    const modeRadios = Array.from(document.querySelectorAll('input[name="mode"]'));
    const advancedToggle = document.getElementById('advanced-toggle');
    const settingsPanel = document.getElementById('settings-panel');
    const settingsTabs = document.getElementById('settings-tabs');
    const statusSection = document.getElementById('status-section');
    const resultsSection = document.getElementById('results-section');
    const settingsDetails = document.getElementById('settings-details');
    const marketDetails = document.getElementById('market-details');
    const quickActionsList = document.getElementById('quick-actions-list');
    const quickStartBtn = document.getElementById('quick-start');
    const quickResetBtn = document.getElementById('quick-reset');
    const quickLastRunBtn = document.getElementById('quick-last-run');
    const quickCopyRunBtn = document.getElementById('quick-copy-run');
    const opsBody = document.getElementById('ops-body');
    const currencyBody = document.getElementById('currency-body');
    const widthToggle = document.getElementById('width-toggle');
    const saveTtlBtn = document.getElementById('save-ttl-btn');
    const statusGoResultsBtn = document.getElementById('status-go-results');
    const activeRuns = document.getElementById('active-runs');
    const activeRunsEmpty = document.getElementById('active-runs-empty');
    const activeRunsError = document.getElementById('active-runs-error');
    const runIdEl = document.getElementById('run-id');
    const runStatusEl = document.getElementById('run-status');
    const runProgressEl = document.getElementById('run-progress');
    const runErrorEl = document.getElementById('run-error');
    const progressBar = document.getElementById('progress-bar');
    const statusActions = document.getElementById('status-actions');
    const statusStartBtn = document.getElementById('status-start-btn');
    const statusNewRunBtn = document.getElementById('status-new-run');
    const cancelRunBtn = document.getElementById('cancel-run-btn');
    const downloadLink = document.getElementById('download-link');
    const reportLinks = document.getElementById('report-links');
    const startDbBtn = document.getElementById('start-db-btn');
    const dbLastDaysInput = document.getElementById('db-last-days');
    const dbAllCachedInput = null;
    const dbOnlySuccessInput = null;
    const dbLimitInput = document.getElementById('db-limit');
    const dbSourceInput = document.getElementById('db-source');
    const dbEanContainsInput = document.getElementById('db-ean-contains');
    const dbError = document.getElementById('db-error');
    const cacheTtlRange = document.getElementById('cache-ttl');
    const cacheTtlInput = document.getElementById('cache-ttl-input');
    const settingsInfo = document.getElementById('settings-info');
    const settingsError = document.getElementById('settings-error');
    const settingsWindowsSuccess = document.getElementById('settings-windows-success');
    const settingsTtlSuccess = document.getElementById('settings-ttl-success');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const categoryModal = document.getElementById('category-modal');
    const categoryModalForm = document.getElementById('category-modal-form');
    const categoryModalError = document.getElementById('category-modal-error');
    const categorySuccess = document.getElementById('category-success');
    const categoryError = document.getElementById('category-error');
    const categoryCancel = document.getElementById('category-cancel');
    const logoutBtn = document.getElementById('logout-btn');
    const offerLimitInput = document.getElementById('offer-limit');
    const settingsSummary = document.getElementById('settings-summary');
    const backendAlert = document.getElementById('backend-alert');
    const runStage = document.getElementById('run-stage');
    const resetBtn = document.getElementById('reset-btn');
    const categoryDetailModal = document.getElementById('category-detail-modal');
    const categoryDetailForm = document.getElementById('category-detail-form');
    const categoryDetailError = document.getElementById('category-detail-error');
    const categoryDetailSuccess = document.getElementById('category-detail-success');
    const categoryDetailCancel = document.getElementById('category-detail-cancel');
    const currencyList = document.getElementById('currency-list');
    const addCurrencyBtn = document.getElementById('add-currency-btn');
    const saveCurrenciesBtn = document.getElementById('save-currencies-btn');
    const currencyHelper = document.getElementById('currency-helper');
    const currencyError = document.getElementById('currency-error');
    const currencySuccess = document.getElementById('currency-success');
    const faqModal = document.getElementById('faq-modal');
    const faqBtn = document.getElementById('faq-btn');
    const faqClose = document.getElementById('faq-close');
    const langToggle = document.getElementById('lang-toggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebarRestore = document.getElementById('sidebar-restore');
    const quickActionsList = document.getElementById('quick-actions-list');
    const wizardSteps = Array.from(document.querySelectorAll('.wizard-step'));
    const stepperItems = Array.from(document.querySelectorAll('.stepper-item'));
    const stepperSelect = document.getElementById('stepper-select');
    const stepPrev = document.getElementById('step-prev');
    const stepNext = document.getElementById('step-next');
    const stepperRoot = document.getElementById('stepper');
    const wiringAlert = document.getElementById('wiring-alert');
    const layout = document.getElementById('layout');
    const shell = document.getElementById('shell');
    const page = document.getElementById('page');
    const historyList = document.getElementById('history-list');
    const historyEmpty = document.getElementById('history-empty');
    const historyError = document.getElementById('history-error');
    const historyToggle = document.getElementById('history-toggle');
    const historyCaret = document.getElementById('history-caret');
    const previewBtn = document.getElementById('preview-link');
    const resultsModal = document.getElementById('results-modal');
    const resultsClose = document.getElementById('results-close');
    const resultsTable = document.getElementById('results-table');
    const resultsMeta = document.getElementById('results-meta');
    const resultsBanner = document.getElementById('results-banner');
    const resultsError = document.getElementById('results-error');
    const resultsEmpty = document.getElementById('results-empty');
    const resultsBackBtn = document.getElementById('results-back');
    const resultsPageInfo = document.getElementById('results-page-info');
    const resultsPrev = document.getElementById('results-prev');
    const resultsNext = document.getElementById('results-next');
    const compactTableToggle = document.getElementById('compact-table-toggle');
    const resultsColumnsEl = document.getElementById('results-columns');
    const marketColumnsEl = document.getElementById('market-columns');
    const resultsColumnsReset = document.getElementById('results-columns-reset');
    const resultsSearch = document.getElementById('results-search');
    const chipProfitable = document.getElementById('chip-profitable');
    const chipErrors = document.getElementById('chip-errors');
    const chipMissing = document.getElementById('chip-missing');
    const copyFailedBtn = document.getElementById('copy-failed-btn');
    const exportXlsxBtn = document.getElementById('export-xlsx');
    const exportCsvBtn = document.getElementById('export-csv');
    const copyReportLinkBtn = document.getElementById('copy-report-link');
    const marketColumnsReset = document.getElementById('market-columns-reset');
    const runUpdatedEl = document.getElementById('run-updated');
    const statusSpinner = document.getElementById('status-spinner');
    const statusLog = document.getElementById('status-log');
    const marketCategory = document.getElementById('market-category');
    const marketEan = document.getElementById('market-ean');
    const marketSource = document.getElementById('market-source');
    const marketDate = document.getElementById('market-date');
    const marketTable = document.getElementById('market-table');
    const marketError = document.getElementById('market-error');
    const marketPageInfo = document.getElementById('market-page-info');
    const marketPrev = document.getElementById('market-prev');
    const marketNext = document.getElementById('market-next');
    const marketSearch = document.getElementById('market-search');
    const marketReset = document.getElementById('market-reset');
    let historyExpanded = true;
    const appState = { currentRunId: null, isStarting: false };
    function stopStatusUpdates() {
      stopRunStream();
      stopPolling();
      stopResultsPolling();
    }
    let pollTimer = null;
    let refreshTimer = null;
    let refreshInFlight = false;
    let previewState = { runId: null, offset: 0, limit: 50, total: 0 };
    let runStream = null;
    let runStreamState = { runId: null, since: null, sinceId: null, lastStatus: null };
    let resultsPollTimer = null;
    let categoriesCache = [];
    let categoryDetailId = null;
    let marketState = { offset: 0, limit: 50, total: 0 };
    let startTouched = false;
    let startReady = false;
    let activeStep = 'import';
    const DEFAULT_SETTINGS = {
      use_cloud_http: false,
      use_local_scraper: true,
      cloud_scraper_disabled: true,
      local_scraper_windows: 1,
      cache_ttl_days: 30,
      db_last_days: 30,
      db_only_success: false,
      db_limit: '',
      db_all_cached: false,
      db_source: 'any',
      db_ean_contains: '',
    };
    const RESULTS_COLUMNS = [
      { id: 'ean', label: 'EAN', labelKey: 'col_ean', default: true },
      { id: 'name', label: 'Nazwa', labelKey: 'col_name', default: true },
      { id: 'currency', label: 'Waluta', labelKey: 'col_currency', default: false },
      { id: 'purchase_price', label: 'Cena zakupu', labelKey: 'col_purchase_price', default: true },
      { id: 'allegro_price', label: 'Cena Allegro', labelKey: 'col_allegro_price', default: true },
      { id: 'margin', label: 'Marża', labelKey: 'col_margin', default: true },
      { id: 'margin_percent', label: 'Marża %', labelKey: 'col_margin_percent', default: true },
      { id: 'profitable', label: 'Opłacalny', labelKey: 'col_profitable', default: true },
      { id: 'source', label: 'Źródło', labelKey: 'col_source', default: false },
      { id: 'last_checked_at', label: 'Ostatnio sprawdzono', labelKey: 'col_last_checked', default: false },
      { id: 'scrape_status', label: 'Status scrapingu', labelKey: 'col_scrape_status', default: true },
    ];
    const MARKET_COLUMNS = [
      { id: 'ean', label: 'EAN', labelKey: 'col_ean', default: true },
      { id: 'name', label: 'Nazwa', labelKey: 'col_name', default: true },
      { id: 'category', label: 'Kategoria', labelKey: 'col_category', default: false },
      { id: 'purchase_price', label: 'Cena zakupu (PLN)', labelKey: 'col_purchase_price_pln', default: false },
      { id: 'allegro_price', label: 'Cena Allegro', labelKey: 'col_allegro_price', default: true },
      { id: 'sold_count', label: 'Sprzedanych', labelKey: 'col_sold_count', default: true },
      { id: 'source', label: 'Źródło', labelKey: 'col_source', default: false },
      { id: 'last_checked_at', label: 'Ostatnio sprawdz.', labelKey: 'col_last_checked', default: true },
      { id: 'last_run_at', label: 'Ostatni run', labelKey: 'col_last_run', default: false },
    ];
    const RESULTS_COLUMNS_KEY = 'ui.columns.results';
    const MARKET_COLUMNS_KEY = 'ui.columns.market';
    const COMPACT_TABLE_KEY = 'ui.table.compact';
    let settingsDefaults = { ...DEFAULT_SETTINGS };
    const I18N_STRINGS = {
      pl: {
        'title-main': 'MVP: import i analiza produktów',
        'lead-main': 'Wgraj plik, wybierz kategorię i uruchom analizę. Zaawansowane opcje są w Ustawieniach.',
        'faq-button': 'FAQ / pomoc',
        'step-inputs': 'Dane wejściowe',
        'step-launch': 'Uruchomienie',
        'step-results': 'Wyniki',
        'label-category': 'Kategoria',
        'label-file': 'Plik (CSV/XLSX)',
        'helper-file': 'Obsługiwane formaty: .xlsx, .xls, .csv',
        'label-mode': 'Tryb analizy',
        'mode-standard': 'Mixed',
        'mode-offline': 'Offline',
        'mode-online': 'Online',
        'helper-mode': 'Online: zawsze live · Mixed: baza + dogrywka braków online · Offline: tylko baza, bez scrapowania.',
        'btn-start': 'Start analizy',
        'status-empty': 'Brak aktywnej analizy. Po starcie zobaczysz status, postęp i link do wyników.',
        'label-run-id': 'Run ID:',
        'run-label': 'Run',
        'label-status': 'Status:',
        'label-progress': 'Postęp:',
        'label-updated': 'Ostatnia aktualizacja:',
        'label-error': 'Błąd:',
        'btn-cancel': 'Anuluj',
        'btn-preview': 'Podgląd wyników',
        'btn-download': '⬇ Pobierz raport',
        'settings-title': 'Ustawienia',
        'settings-helper': 'Opcje rzadziej używane. W trybie prostym ukryte.',
        'btn-close-settings': 'Zamknij ustawienia',
        'label-advanced': 'Tryb zaawansowany',
        'label-cloud-override': 'Global override: wyłącz chmurę/BD',
        'helper-cloud-override': 'Gdy włączone, wymusza lokalny scraper i blokuje cloud/BrightData.',
        'btn-reset': 'Przywróć domyślne',
        'settings-sidehint': 'Kursy walut i Kategorie są dostępne w panelu bocznym po prawej.',
        'tab-sources': 'Źródło danych',
        'tab-performance': 'Wydajność',
        'tab-quality': 'Cache i jakość',
        'tab-history': 'Historia i dane',
        'retry-local': 'Retry: lokalnie',
        'history-ops': 'Operacje ▾',
        'strategy-local': 'Local Selenium',
        'strategy-cloud': 'Cloud / BrightData',
        'strategies-none': 'Brak',
        'history-empty-text': 'Brak wcześniejszych analiz.',
        saved: 'Zapisano',
        'strategy-required': 'Włącz lokalny scraper lub wyłącz override chmury dla trybu Mixed/Online.',
        'hint-offline': 'W trybie Offline scrapowanie jest wyłączone.',
        'btn-starting': 'Wysyłanie...',
        'btn-start-db': 'Start analizy z bazy',
        'btn-starting-db': 'Uruchamianie...',
        'loading': 'Ładowanie...',
        'loading-results': 'Ładowanie wyników...',
        'category-removed': 'Kategoria usunięta',
        'category-added': 'Kategoria dodana.',
        'category-saved': 'Zapisano zmiany.',
        'mode_mixed_label': 'Mixed',
        'mode_offline_label': 'Offline',
        'mode_online_label': 'Online',
        'analysis-canceled': 'Analiza została anulowana.',
        'analysis-failed': 'Analiza przerwana.',
        'no-data': 'Brak danych do wyświetlenia.',
        'categories-empty': 'Brak aktywnych kategorii. Dodaj kategorię w sekcji „Kategorie” poniżej.',
        status_pending: 'Oczekuje',
        status_running: 'W toku',
        status_completed: 'Zakończono',
        status_failed: 'Błąd',
        status_canceled: 'Anulowano',
        scrape_pending: 'Oczekuje',
        scrape_in_progress: 'Trwa pobieranie',
        scrape_blocked: 'Zablokowany',
        scrape_network_error: 'Błąd sieci',
        scrape_error: 'Błąd',
        scrape_not_found: 'Brak',
        scrape_ok: 'OK',
        profitable_yes: 'tak',
        profitable_no: 'nie',
        profitable_unknown: '—',
        'network-error': 'Brak połączenia z backendem. Sprawdź czy kontenery działają.',
        'add-category-to-start': 'Dodaj kategorię, aby rozpocząć.',
        'select-category': 'Wybierz kategorię.',
        'select-file': 'Wybierz plik do analizy.',
        'error-fetch-rates': 'Nie udało się pobrać kursów.',
        'error-save-rates': 'Nie udało się zapisać kursów.',
        'error-fetch-rates-network': 'Błąd pobierania kursów.',
        'error-save-rates-network': 'Błąd zapisu kursów.',
        'rates-helper': 'PLN musi mieć kurs 1.0. Dodaj inne waluty, aby były przeliczane na PLN.',
        'rates-saved': 'Zapisano kursy walut.',
        'error-fetch-active': 'Nie udało się pobrać aktywnych analiz.',
        'error-fetch-results': 'Nie udało się pobrać wyników.',
        'error-fetch-results-network': 'Błąd podczas pobierania wyników.',
        'error-fetch-market': 'Nie udało się pobrać danych.',
        'error-fetch-market-network': 'Błąd pobierania danych.',
        'error-fetch-categories': 'Nie udało się pobrać kategorii.',
        'error-fetch-settings': 'Nie udało się pobrać ustawień.',
        'error-fetch-settings-fallback': 'Nie udało się pobrać ustawień. Używane są wartości domyślne.',
        'error-save-settings': 'Nie udało się zapisać ustawień.',
        'error-save-settings-network': 'Błąd zapisu ustawień.',
        'error-fetch-history': 'Nie udało się pobrać historii.',
        'error-fetch-history-network': 'Błąd pobierania historii.',
        'error-refresh-results': 'Błąd odświeżania wyników.',
        'error-analysis': 'Błąd analizy.',
        'error-status': 'Nie udało się pobrać statusu.',
        'analysis-failed-generic': 'Analiza nie powiodła się.',
        'analysis-failed-no-data': 'Analiza przerwana, brak danych do wyświetlenia.',
        'error-run-cancel': 'Nie udało się anulować analizy.',
        'error-run-cancel-network': 'Błąd anulowania.',
        'error-run-db-start': 'Nie udało się uruchomić analizy z bazy.',
        'error-run-start': 'Nie udało się uruchomić analizy.',
        'error-db-select-category': 'Wybierz kategorię do analizy.',
        'error-retry': 'Nie udało się uruchomić retry.',
        'error-retry-network': 'Błąd retry.',
        'error-add-category': 'Nie udało się dodać kategorii.',
        'error-add-category-network': 'Błąd podczas dodawania kategorii.',
        'error-save-category': 'Nie udało się zapisać kategorii.',
        'error-save-category-network': 'Błąd zapisu kategorii.',
        'no-details': 'Brak szczegółów.',
        'error-reason': 'Powód błędu:',
        'cancel-reason': 'Powód anulowania:',
        'summary-progress': 'Postęp:',
        'summary-finished': 'Zakończono:',
        'summary-id': 'ID:',
        'summary-created': 'Utworzono:',
        'summary-canceled-at': 'Anulowano:',
        'summary-pending': 'W toku / oczekuje',
        'summary-mode': 'Tryb:',
        'summary-strategies': 'Strategie:',
        'label-source-colon': 'Źródło:',
        'label-scrape-status-colon': 'Status scrapingu:',
        'label-last-checked-colon': 'Ostatnio sprawdzono:',
        'label-scrape-error-colon': 'Błąd scrapingu:',
        'label-original-currency': 'Oryginalna waluta:',
        'label-original-price': 'Oryginalna cena:',
        'label-sold-count': 'Liczba sprzedanych:',
        'label-sold-count-status': 'Status sprzedaży:',
        'label-data-provider': 'Źródło danych:',
        col_ean: 'EAN',
        col_name: 'Nazwa',
        col_currency: 'Waluta',
        col_purchase_price: 'Cena zakupu',
        col_allegro_price: 'Cena Allegro',
        col_margin: 'Marża',
        col_margin_percent: 'Marża %',
        col_profitable: 'Opłacalny',
        col_source: 'Źródło',
        col_last_checked: 'Ostatnio sprawdzono',
        col_scrape_status: 'Status scrapingu',
        col_category: 'Kategoria',
        col_purchase_price_pln: 'Cena zakupu (PLN)',
        col_sold_count: 'Sprzedanych',
        col_last_run: 'Ostatni run',
      },
      en: {
        'title-main': 'MVP: product import & analysis',
        'lead-main': 'Upload a file, pick a category, and start the analysis. Advanced options live in Settings.',
        'faq-button': 'FAQ / help',
        'step-inputs': 'Input data',
        'step-launch': 'Start',
        'step-results': 'Results',
        'label-category': 'Category',
        'label-file': 'File (CSV/XLSX)',
        'helper-file': 'Supported formats: .xlsx, .xls, .csv',
        'label-mode': 'Analysis mode',
        'mode-standard': 'Mixed',
        'mode-offline': 'Offline',
        'mode-online': 'Online',
        'helper-mode': 'Online: always live · Mixed: cache + online gap fill · Offline: DB only, no scraping.',
        'btn-start': 'Start analysis',
        'status-empty': 'No active analysis. Once started you will see status, progress, and links to results.',
        'label-run-id': 'Run ID:',
        'run-label': 'Run',
        'label-status': 'Status:',
        'label-progress': 'Progress:',
        'label-updated': 'Last update:',
        'label-error': 'Error:',
        'btn-cancel': 'Cancel',
        'btn-preview': 'Preview results',
        'btn-download': '⬇ Download report',
        'settings-title': 'Settings',
        'settings-helper': 'Less common options. Hidden in simple mode.',
        'btn-close-settings': 'Close settings',
        'label-advanced': 'Advanced mode',
        'label-cloud-override': 'Global override: disable cloud/BD',
        'helper-cloud-override': 'When on, forces local scraper and blocks cloud/BrightData.',
        'btn-reset': 'Restore defaults',
        'settings-sidehint': 'Currency rates and Categories are available in the right sidebar.',
        'tab-sources': 'Data source',
        'tab-performance': 'Performance',
        'tab-quality': 'Cache & quality',
        'tab-history': 'History & data',
        'retry-local': 'Retry: local',
        'history-ops': 'Operations ▾',
        'strategy-local': 'Local Selenium',
        'strategy-cloud': 'Cloud / BrightData',
        'strategies-none': 'None',
        'history-empty-text': 'No previous analyses.',
        saved: 'Saved',
        'strategy-required': 'Enable local scraper or disable the cloud override for Standard/Always online.',
        'hint-offline': 'Scraping is disabled in Cache only mode.',
        'btn-starting': 'Sending...',
        'btn-start-db': 'Start DB analysis',
        'btn-starting-db': 'Starting...',
        'loading': 'Loading...',
        'loading-results': 'Loading results...',
        'category-removed': 'Category removed',
        'category-added': 'Category added.',
        'category-saved': 'Changes saved.',
        'mode_mixed_label': 'Standard',
        'mode_offline_label': 'Cache only',
        'mode_online_label': 'Always online',
        'analysis-canceled': 'Analysis was canceled.',
        'analysis-failed': 'Analysis interrupted.',
        'no-data': 'No data to display.',
        'categories-empty': 'No active categories. Add one in the “Categories” section below.',
        status_pending: 'Pending',
        status_running: 'Running',
        status_completed: 'Completed',
        status_failed: 'Failed',
        status_canceled: 'Canceled',
        scrape_pending: 'Pending',
        scrape_in_progress: 'Scraping',
        scrape_blocked: 'Blocked',
        scrape_network_error: 'Network error',
        scrape_error: 'Error',
        scrape_not_found: 'Not found',
        scrape_ok: 'OK',
        profitable_yes: 'yes',
        profitable_no: 'no',
        profitable_unknown: '—',
        'network-error': 'Backend unreachable. Check that containers are running.',
        'add-category-to-start': 'Add a category to start.',
        'select-category': 'Select a category.',
        'select-file': 'Select a file to analyze.',
        'error-fetch-rates': 'Failed to fetch rates.',
        'error-save-rates': 'Failed to save rates.',
        'error-fetch-rates-network': 'Error fetching rates.',
        'error-save-rates-network': 'Error saving rates.',
        'rates-helper': 'PLN must have rate 1.0. Add other currencies to convert to PLN.',
        'rates-saved': 'Currency rates saved.',
        'error-fetch-active': 'Failed to load active analyses.',
        'error-fetch-results': 'Failed to load results.',
        'error-fetch-results-network': 'Error while loading results.',
        'error-fetch-market': 'Failed to load data.',
        'error-fetch-market-network': 'Error loading data.',
        'error-fetch-categories': 'Failed to load categories.',
        'error-fetch-settings': 'Failed to load settings.',
        'error-fetch-settings-fallback': 'Failed to load settings. Using defaults.',
        'error-save-settings': 'Failed to save settings.',
        'error-save-settings-network': 'Error saving settings.',
        'error-fetch-history': 'Failed to load history.',
        'error-fetch-history-network': 'Error loading history.',
        'error-refresh-results': 'Error refreshing results.',
        'error-analysis': 'Analysis error.',
        'error-status': 'Failed to load status.',
        'analysis-failed-generic': 'Analysis failed.',
        'analysis-failed-no-data': 'Analysis interrupted, no data to display.',
        'error-run-cancel': 'Failed to cancel analysis.',
        'error-run-cancel-network': 'Cancel error.',
        'error-run-db-start': 'Failed to start DB analysis.',
        'error-run-start': 'Failed to start analysis.',
        'error-db-select-category': 'Choose a category to analyze.',
        'error-retry': 'Failed to trigger retry.',
        'error-retry-network': 'Retry error.',
        'error-add-category': 'Failed to add category.',
        'error-add-category-network': 'Error while adding category.',
        'error-save-category': 'Failed to save category.',
        'error-save-category-network': 'Category save error.',
        'no-details': 'No details.',
        'error-reason': 'Error reason:',
        'cancel-reason': 'Cancel reason:',
        'summary-progress': 'Progress:',
        'summary-finished': 'Finished:',
        'summary-id': 'ID:',
        'summary-created': 'Created:',
        'summary-canceled-at': 'Canceled:',
        'summary-pending': 'In progress / pending',
        'summary-mode': 'Mode:',
        'summary-strategies': 'Strategies:',
        'label-source-colon': 'Source:',
        'label-scrape-status-colon': 'Scrape status:',
        'label-last-checked-colon': 'Last checked:',
        'label-scrape-error-colon': 'Scrape error:',
        'label-original-currency': 'Original currency:',
        'label-original-price': 'Original price:',
        'label-sold-count': 'Units sold:',
        'label-sold-count-status': 'Sales status:',
        'label-data-provider': 'Data provider:',
        col_ean: 'EAN',
        col_name: 'Name',
        col_currency: 'Currency',
        col_purchase_price: 'Purchase price',
        col_allegro_price: 'Allegro price',
        col_margin: 'Margin',
        col_margin_percent: 'Margin %',
        col_profitable: 'Profitable',
        col_source: 'Source',
        col_last_checked: 'Last checked',
        col_scrape_status: 'Scrape status',
        col_category: 'Category',
        col_purchase_price_pln: 'Purchase price (PLN)',
        col_sold_count: 'Sold',
        col_last_run: 'Last run',
      },
    };

    const I18N_TEXT_MAP = {
      "Zakres / filtry danych": { pl: "Zakres / filtry danych", en: "Scope / data filters" },
      "Opcje zachowania": { pl: "Opcje zachowania", en: "Behavior options" },
      "Selenium lokalnie w kontenerze.": { pl: "Selenium lokalnie w kontenerze.", en: "Local Selenium inside the container." },
      "Jeśli źródło jest wyłączone, analiza korzysta tylko z danych z bazy i cache.": { pl: "Jeśli źródło jest wyłączone, analiza korzysta tylko z danych z bazy i cache.", en: "If the source is disabled, the analysis uses only DB/cache data." },
      "Liczba jednocześnie otwieranych okien lokalnego scrapera": { pl: "Liczba jednocześnie otwieranych okien lokalnego scrapera", en: "Number of simultaneous local scraper windows" },
      "Więcej okien przyspiesza, ale obciąża CPU/RAM.": { pl: "Więcej okien przyspiesza, ale obciąża CPU/RAM.", en: "More windows speed things up but use more CPU/RAM." },
      "Zapisz ustawienia": { pl: "Zapisz ustawienia", en: "Save settings" },
      "TTL cache (dni)": { pl: "TTL cache (dni)", en: "Cache TTL (days)" },
      "Po ilu dniach dane z Allegro uznajemy za przestarzałe.": { pl: "Po ilu dniach dane z Allegro uznajemy za przestarzałe.", en: "After how many days Allegro data becomes stale." },
      "Analiza z bazy": { pl: "Analiza z bazy", en: "Database analysis" },
      "Ostatnie dni cache": { pl: "Ostatnie dni cache", en: "Cache last days" },
      "Zakres danych do analizy (dni wstecz).": { pl: "Zakres danych do analizy (dni wstecz).", en: "Data range to analyze (days back)." },
      "Limit pozycji": { pl: "Limit pozycji", en: "Item limit" },
      "Ogranicza liczbę rekordów do analizy.": { pl: "Ogranicza liczbę rekordów do analizy.", en: "Limits the number of records to analyze." },
      "Źródło danych": { pl: "Źródło danych", en: "Data source" },
      "Dowolne": { pl: "Dowolne", en: "Any" },
      "Filtruj po źródle pozyskanych danych.": { pl: "Filtruj po źródle pozyskanych danych.", en: "Filter by source of scraped data." },
      "EAN zawiera": { pl: "EAN zawiera", en: "EAN contains" },
      "Pozwala zawęzić listę do fragmentu EAN.": { pl: "Pozwala zawęzić listę do fragmentu EAN.", en: "Filter by EAN fragment." },
      "Tylko produkty z danymi": { pl: "Tylko produkty z danymi", en: "Only products with data" },
      "Pomiń wpisy bez ceny/sprzedaży.": { pl: "Pomiń wpisy bez ceny/sprzedaży.", en: "Skip entries without price/sales." },
      "Wszystkie zapisane produkty": { pl: "Wszystkie zapisane produkty", en: "All saved products" },
      "Ignoruje pole „Ostatnie dni cache”.": { pl: "Ignoruje pole „Ostatnie dni cache”.", en: "Ignores the \"Cache last days\" field." },
      "Uruchamia analizę na danych zapisanych w bazie (bez pliku). Używa kategorii wybranej w kroku 1.": { pl: "Uruchamia analizę na danych zapisanych w bazie (bez pliku). Używa kategorii wybranej w kroku 1.", en: "Runs analysis on cached DB data (no file). Uses the category chosen in step 1." },
      "Start analizy z bazy": { pl: "Start analizy z bazy", en: "Start DB analysis" },
      "Widok tabel": { pl: "Widok tabel", en: "Table view" },
      "Tryb kompaktowy": { pl: "Tryb kompaktowy", en: "Compact mode" },
      "Tryb kompaktowy tabel": { pl: "Tryb kompaktowy tabel", en: "Compact tables" },
      "Zmniejsza padding i szerokości kolumn EAN/Nazwa.": { pl: "Zmniejsza padding i szerokości kolumn EAN/Nazwa.", en: "Reduces padding and EAN/Name widths." },
      "Kolumny - Wyniki analizy": { pl: "Kolumny - Wyniki analizy", en: "Columns - Analysis results" },
      "Kolumny - Baza Allegro": { pl: "Kolumny - Baza Allegro", en: "Columns - Allegro DB" },
      "Przywróć domyślne": { pl: "Przywróć domyślne", en: "Restore default" },
      "Historia analiz": { pl: "Historia analiz", en: "Analysis history" },
      "Brak wcześniejszych analiz.": { pl: "Brak wcześniejszych analiz.", en: "No previous analyses." },
      "Nie udało się pobrać historii.": { pl: "Nie udało się pobrać historii.", en: "Failed to load history." },
      "Baza Allegro (ostatnie dane rynkowe)": { pl: "Baza Allegro (ostatnie dane rynkowe)", en: "Allegro DB (latest market data)" },
      "Filtrowanie po wybranej kategorii.": { pl: "Filtrowanie po wybranej kategorii.", en: "Filter by selected category." },
      "Może być fragmentem kodu.": { pl: "Może być fragmentem kodu.", en: "Can be a code fragment." },
      "Skąd pochodziły dane rynkowe.": { pl: "Skąd pochodziły dane rynkowe.", en: "Where the market data came from." },
      "Od kiedy": { pl: "Od kiedy", en: "Updated since" },
      "Filtruj po dacie aktualizacji.": { pl: "Filtruj po dacie aktualizacji.", en: "Filter by update date." },
      "Ładowanie...": { pl: "Ładowanie...", en: "Loading..." },
      "Ładowanie wyników...": { pl: "Ładowanie wyników...", en: "Loading results..." },
      "Szukaj": { pl: "Szukaj", en: "Search" },
      "Reset": { pl: "Reset", en: "Reset" },
      "◀ Wstecz": { pl: "◀ Wstecz", en: "◀ Back" },
      "Dalej ▶": { pl: "Dalej ▶", en: "Next ▶" },
      "Panel": { pl: "Panel", en: "Panel" },
      "Operacje": { pl: "Operacje", en: "Operations" },
      "Kursy walut": { pl: "Kursy walut", en: "Exchange rates" },
      "Kategorie": { pl: "Kategorie", en: "Categories" },
      "Brak aktywnych analiz.": { pl: "Brak aktywnych analiz.", en: "No active analyses." },
      "Dodaj walutę": { pl: "Dodaj walutę", en: "Add currency" },
      "Zapisz kursy": { pl: "Zapisz kursy", en: "Save rates" },
      "Kategoria": { pl: "Kategoria", en: "Category" },
      "Dodaj kategorię": { pl: "Dodaj kategorię", en: "Add category" },
      "Dodaj nową kategorię": { pl: "Dodaj nową kategorię", en: "Add a new category" },
      "Anuluj": { pl: "Anuluj", en: "Cancel" },
      "Zapisz": { pl: "Zapisz", en: "Save" },
      "Nazwa kategorii": { pl: "Nazwa kategorii", en: "Category name" },
      "Mnożnik opłacalności": { pl: "Mnożnik opłacalności", en: "Profitability multiplier" },
      "Prowizja Allegro (%)": { pl: "Prowizja Allegro (%)", en: "Allegro commission (%)" },
      "Anuluj": { pl: "Anuluj", en: "Cancel" },
      "Dodaj kategorię": { pl: "Dodaj kategorię", en: "Add category" },
      "Szczegóły kategorii": { pl: "Szczegóły kategorii", en: "Category details" },
      "Zapisz": { pl: "Zapisz", en: "Save" },
      "FAQ - jak korzystać z systemu": { pl: "FAQ - jak korzystać z systemu", en: "FAQ - how to use the system" },
      "Różnice między trybami Standard, Tylko baza, Zawsze online": { pl: "Różnice między trybami Standard, Tylko baza, Zawsze online", en: "Differences between Standard, Cache only, Always online" },
      "Standard – używa cache, ale odświeża gdy dane są starsze niż TTL. Tylko baza – korzysta wyłącznie z danych z bazy. Zawsze online – ignoruje cache i zawsze pobiera dane live.": { pl: "Standard – używa cache, ale odświeża gdy dane są starsze niż TTL. Tylko baza – korzysta wyłącznie z danych z bazy. Zawsze online – ignoruje cache i zawsze pobiera dane live.", en: "Standard – uses cache but refreshes when data is older than TTL. Cache only – uses DB/cache only. Always online – ignores cache and always fetches live data." },
      "Źródła danych (Local Selenium)": { pl: "Źródła danych (Local Selenium)", en: "Data sources (Local Selenium)" },
      "Local Selenium – lokalny scraper z przeglądarką. W trybie Tylko baza scrapowanie jest wyłączone.": { pl: "Local Selenium – lokalny scraper z przeglądarką. W trybie Tylko baza scrapowanie jest wyłączone.", en: "Local Selenium – local browser scraper. In Cache only mode scraping is disabled." },
      "Jak dodać nową kategorię": { pl: "Jak dodać nową kategorię", en: "How to add a new category" },
      "Użyj przycisku „+” w sekcji Kategorie i wypełnij formularz.": { pl: "Użyj przycisku „+” w sekcji Kategorie i wypełnij formularz.", en: "Use the “+” button in the Categories section and fill out the form." },
      "Jakie pliki są obsługiwane": { pl: "Jakie pliki są obsługiwane", en: "Which files are supported" },
      "CSV, XLS, XLSX. Wymagane kolumny: EAN, Name, PurchasePrice.": { pl: "CSV, XLS, XLSX. Wymagane kolumny: EAN, Name, PurchasePrice.", en: "CSV, XLS, XLSX. Required columns: EAN, Name, PurchasePrice." },
      "Co zrobić, gdy analiza kończy się błędem": { pl: "Co zrobić, gdy analiza kończy się błędem", en: "What to do if the analysis fails" },
      "Sprawdź komunikat w sekcji statusu. Upewnij się, że kategoria jest aktywna oraz że w Ustawieniach masz wybrane źródła danych (jeśli tryb nie jest „Tylko baza”).": { pl: "Sprawdź komunikat w sekcji statusu. Upewnij się, że kategoria jest aktywna oraz że w Ustawieniach masz wybrane źródła danych (jeśli tryb nie jest „Tylko baza”).", en: "Check the message in the status section. Make sure the category is active and that data sources are enabled in Settings (if not in Cache only mode)." },
      "Co oznaczają pola kategorii: nazwa, mnożnik opłacalności i prowizja Allegro?": { pl: "Co oznaczają pola kategorii: nazwa, mnożnik opłacalności i prowizja Allegro?", en: "What do the category fields mean: name, profitability multiplier, Allegro commission?" },
      "Nazwa kategorii": { pl: "Nazwa kategorii", en: "Category name" },
      "Nazwa kategorii – dowolna nazwa, która pozwala Ci rozpoznać grupę produktów, np. „Perfumy”, „Chemia gospodarcza”, „Zabawki”.": { pl: "Nazwa kategorii – dowolna nazwa, która pozwala Ci rozpoznać grupę produktów, np. „Perfumy”, „Chemia gospodarcza”, „Zabawki”.", en: "Category name – any name that helps you recognise the product group, e.g. “Perfumes”, “Household chemicals”, “Toys”." },
      " – dowolna nazwa, która pozwala Ci rozpoznać grupę produktów, np. „Perfumy”, „Chemia gospodarcza”, „Zabawki”.": { pl: " – dowolna nazwa, która pozwala Ci rozpoznać grupę produktów, np. „Perfumy”, „Chemia gospodarcza”, „Zabawki”.", en: " – any name that helps you recognise the product group, e.g. “Perfumes”, “Household chemicals”, “Toys”." },
      "Mnożnik opłacalności": { pl: "Mnożnik opłacalności", en: "Profitability multiplier" },
      "Mnożnik opłacalności – minimalny docelowy zwrot z inwestycji (marża względem ceny zakupu). Przykład: jeżeli ustawisz mnożnik 1,5, to system oznaczy produkt jako „opłacalny” tylko wtedy, gdy po odjęciu prowizji Allegro zarobek będzie co najmniej 50% ceny zakupu.": { pl: "Mnożnik opłacalności – minimalny docelowy zwrot z inwestycji (marża względem ceny zakupu). Przykład: jeżeli ustawisz mnożnik 1,5, to system oznaczy produkt jako „opłacalny” tylko wtedy, gdy po odjęciu prowizji Allegro zarobek będzie co najmniej 50% ceny zakupu.", en: "Profitability multiplier – minimum target ROI (margin vs purchase price). Example: with multiplier 1.5 the product is “profitable” only if, after Allegro commission, the profit is at least 50% of the purchase price." },
      " – minimalny docelowy zwrot z inwestycji (marża względem ceny zakupu). Przykład: jeżeli ustawisz mnożnik 1,5, to system oznaczy produkt jako „opłacalny” tylko wtedy, gdy po odjęciu prowizji Allegro zarobek będzie co najmniej 50% ceny zakupu.": { pl: " – minimalny docelowy zwrot z inwestycji (marża względem ceny zakupu). Przykład: jeżeli ustawisz mnożnik 1,5, to system oznaczy produkt jako „opłacalny” tylko wtedy, gdy po odjęciu prowizji Allegro zarobek będzie co najmniej 50% ceny zakupu.", en: " – minimum target ROI (margin vs purchase price). Example: with multiplier 1.5 the product is “profitable” only if, after Allegro commission, the profit is at least 50% of the purchase price." },
      "Prowizja Allegro (%) – szacowany procent prowizji Allegro w danej kategorii. System odejmuje tę prowizję od ceny sprzedaży i dopiero z tej „netto” ceny liczy marżę.": { pl: "Prowizja Allegro (%) – szacowany procent prowizji Allegro w danej kategorii. System odejmuje tę prowizję od ceny sprzedaży i dopiero z tej „netto” ceny liczy marżę.", en: "Allegro commission (%) – estimated commission rate for the category. The system subtracts it from sale price before calculating margin." },
      " – szacowany procent prowizji Allegro w danej kategorii. System odejmuje tę prowizję od ceny sprzedaży i dopiero z tej „netto” ceny liczy marżę.": { pl: " – szacowany procent prowizji Allegro w danej kategorii. System odejmuje tę prowizję od ceny sprzedaży i dopiero z tej „netto” ceny liczy marżę.", en: " – estimated commission rate for the category. The system subtracts it from sale price before calculating margin." },
      "Dzięki temu opłacalność jest liczona dla każdej kategorii inaczej – np. jeśli w jednej kategorii prowizja jest wyższa, próg opłacalności jest automatycznie bardziej wymagający. Każda analiza jest powiązana z jedną kategorią, a każda kategoria ma własne parametry, więc możesz osobno ustawić logikę dla „Perfum” vs „Chemii” itp.": { pl: "Dzięki temu opłacalność jest liczona dla każdej kategorii inaczej – np. jeśli w jednej kategorii prowizja jest wyższa, próg opłacalności jest automatycznie bardziej wymagający. Każda analiza jest powiązana z jedną kategorią, a każda kategoria ma własne parametry, więc możesz osobno ustawić logikę dla „Perfum” vs „Chemii” itp.", en: "This way profitability is calculated per category – if a category has higher commission, the profitability threshold is automatically stricter. Each analysis is tied to one category with its own parameters, so you can configure logic separately (e.g., Perfumes vs. Household chemicals)." },
      "Podgląd wyników analizy": { pl: "Podgląd wyników analizy", en: "Analysis preview" },
      "Zamknij": { pl: "Zamknij", en: "Close" },
      "Wyniki analizy": { pl: "Wyniki analizy", en: "Analysis results" },
      "Analiza przerwana, brak danych do wyświetlenia.": { pl: "Analiza przerwana, brak danych do wyświetlenia.", en: "Analysis interrupted, no data to display." },
      "Brak danych do wyświetlenia.": { pl: "Brak danych do wyświetlenia.", en: "No data to display." },
      "EAN": { pl: "EAN", en: "EAN" },
      "Nazwa": { pl: "Nazwa", en: "Name" },
      "Waluta": { pl: "Waluta", en: "Currency" },
      "Cena zakupu": { pl: "Cena zakupu", en: "Purchase price" },
      "Cena Allegro": { pl: "Cena Allegro", en: "Allegro price" },
      "Marża": { pl: "Marża", en: "Margin" },
      "Marża %": { pl: "Marża %", en: "Margin %" },
      "Opłacalny": { pl: "Opłacalny", en: "Profitable" },
      "Ostatnio sprawdzono": { pl: "Ostatnio sprawdzono", en: "Last checked" },
      "Status": { pl: "Status", en: "Status" },
      "Cena zakupu (PLN)": { pl: "Cena zakupu (PLN)", en: "Purchase price (PLN)" },
      "Sprzedanych": { pl: "Sprzedanych", en: "Sold" },
      "Ostatnio sprawdz.": { pl: "Ostatnio sprawdz.", en: "Last checked" },
      "Ostatni run": { pl: "Ostatni run", en: "Last run" },
      "Źródło": { pl: "Źródło", en: "Source" },
      "Źródło:": { pl: "Źródło:", en: "Source:" },
      "Strategie:": { pl: "Strategie:", en: "Strategies:" },
      "Tryb:": { pl: "Tryb:", en: "Mode:" },
      "Status scrapingu:": { pl: "Status scrapingu:", en: "Scrape status:" },
      "Ostatnio sprawdzono:": { pl: "Ostatnio sprawdzono:", en: "Last checked:" },
      "Błąd scrapingu:": { pl: "Błąd scrapingu:", en: "Scrape error:" },
      "Oryginalna waluta:": { pl: "Oryginalna waluta:", en: "Original currency:" },
      "Oryginalna cena:": { pl: "Oryginalna cena:", en: "Original price:" },
      "Liczba sprzedanych:": { pl: "Liczba sprzedanych:", en: "Units sold:" },
    };

    const PLACEHOLDER_I18N = {
      'db-limit': { pl: 'np. 200', en: 'e.g. 200' },
      'db-ean-contains': { pl: 'np. 590', en: 'e.g. 590' },
      'market-ean': { pl: 'fragment EAN', en: 'EAN fragment' },
    };

    let currentLang = localStorage.getItem('ui.lang') === 'en' ? 'en' : 'pl';

    function t(key) {
      const dict = I18N_STRINGS[currentLang] || I18N_STRINGS.pl;
      return dict[key] || I18N_STRINGS.pl[key] || key;
    }

    function applyI18nAttributes(lang) {
      const dict = I18N_STRINGS[lang] || I18N_STRINGS.pl;
      document.querySelectorAll('[data-i18n]').forEach((el) => {
        const key = el.dataset.i18n;
        const value = dict[key] || I18N_STRINGS.pl[key];
        if (value) el.textContent = value;
      });
    }

    function applyPlaceholderTranslations(lang) {
      Object.entries(PLACEHOLDER_I18N).forEach(([id, values]) => {
        const el = document.getElementById(id);
        if (el && values[lang]) {
          el.placeholder = values[lang];
        }
      });
    }

    function applyTextMap(lang) {
      const container = document.querySelector('[data-i18n-auto]');
      if (!container) return;
      const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
      while (walker.nextNode()) {
        const node = walker.currentNode;
        if (!node || !node.textContent) continue;
        const raw = node.textContent.trim();
        if (!raw) continue;
        const entry = I18N_TEXT_MAP[raw];
        if (entry && entry[lang] && node.parentElement) {
          node.textContent = entry[lang];
        }
      }
    }

    function applyTranslations() {
      const lang = currentLang;
      document.documentElement.lang = lang;
      applyI18nAttributes(lang);
      applyPlaceholderTranslations(lang);
      applyTextMap(lang);
      applyColumnHeaders();
      renderColumnPicker(resultsColumnsEl, RESULTS_COLUMNS, RESULTS_COLUMNS_KEY, applyResultsColumns);
      renderColumnPicker(marketColumnsEl, MARKET_COLUMNS, MARKET_COLUMNS_KEY, applyMarketColumns);
      if (stepperSelect) stepperSelect.setAttribute('aria-label', lang === 'en' ? 'Choose step' : 'Wybierz krok');
      if (stepPrev) stepPrev.textContent = lang === 'en' ? 'Back' : 'Wstecz';
      if (stepNext) stepNext.textContent = lang === 'en' ? 'Next' : 'Następny';
      if (langToggle) {
        langToggle.textContent = lang === 'pl' ? 'EN' : 'PL';
        langToggle.title = lang === 'pl' ? 'Switch to English' : 'Przełącz na polski';
        langToggle.setAttribute('aria-label', lang === 'pl' ? 'Switch language to English' : 'Przełącz język na polski');
      }
    }

    function setLanguage(lang) {
      currentLang = lang === 'en' ? 'en' : 'pl';
      localStorage.setItem('ui.lang', currentLang);
      applyTranslations();
      applyResultsColumns();
      applyMarketColumns();
      applyCompactMode();
      loadHistory();
      loadActiveRuns();
      if (previewState.runId) {
        loadResults(previewState.runId, previewState.offset || 0);
      }
    }

    function applyWidthMode(mode) {
      const normalized = mode === 'wide' ? 'wide' : 'comfort';
      if (page) page.classList.toggle('is-wide', normalized === 'wide');
      if (widthToggle) widthToggle.textContent = normalized === 'wide' ? 'Comfort width' : 'Wide width';
      localStorage.setItem('ui.width', normalized);
    }

    function normalizeMessage(msg) {
      if (!msg) return '';
      if (typeof msg === 'string') return msg;
      try {
        return JSON.stringify(msg);
      } catch (err) {
        return String(msg);
      }
    }

    const STEPS = ['import','config','run','status','results','history','settings','market'];
    const STEP_LABELS = {
      import: 'Import',
      config: 'Konfiguracja',
      run: 'Uruchomienie',
      status: 'Status',
      results: 'Wyniki',
      history: 'Historia',
      settings: 'Ustawienia',
      market: 'Baza Allegro',
    };
    const REQUIRED_IDS = [
      'file-input',
      'category-select',
      'submit-btn',
      'status-panel',
      'run-id',
      'status-log',
      'results-table',
      'history-list',
      'download-link',
      'preview-link',
      'results-tabs',
      'start-db-btn',
      'market-table',
    ];

    function validateWiring() {
      const missing = REQUIRED_IDS.filter((id) => !document.getElementById(id));
      const panelSteps = new Set(stepperItems.map((btn) => btn.dataset.step));
      const bodySteps = new Set(wizardSteps.map((el) => el.dataset.step));
      const missingPanels = [...bodySteps].filter((s) => !panelSteps.has(s));
      const missingBodies = [...panelSteps].filter((s) => !bodySteps.has(s));
      if (missing.length) {
        const message = `UI wiring error: missing #${missing.join(', #')}`;
        console.error(message);
        if (wiringAlert) {
          wiringAlert.textContent = message;
          wiringAlert.style.display = 'block';
        }
        return;
      }
      if (missingPanels.length || missingBodies.length) {
        const parts = [];
        if (missingPanels.length) parts.push(`brak w stepperze: ${missingPanels.join(', ')}`);
        if (missingBodies.length) parts.push(`brak sekcji: ${missingBodies.join(', ')}`);
        const message = `UI wiring error: ${parts.join(' ; ')}`;
        console.error(message);
        if (wiringAlert) {
          wiringAlert.textContent = message;
          wiringAlert.style.display = 'block';
        }
      } else if (wiringAlert) {
        wiringAlert.style.display = 'none';
        wiringAlert.textContent = '';
      }
    }

    // --- Wizard navigation helpers ---
    function setStep(stepId) {
      if (!stepId) return;
      if (!STEPS.includes(stepId)) return;
      activeStep = stepId;
      wizardSteps.forEach((section) => {
        section.classList.toggle('is-active', section.dataset.step === stepId);
      });
      stepperItems.forEach((btn) => {
        btn.classList.toggle('is-active', btn.dataset.step === stepId);
      });
      if (stepperSelect) stepperSelect.value = stepId;
      const idx = STEPS.indexOf(stepId);
      if (stepPrev) stepPrev.disabled = idx <= 0;
      if (stepNext) stepNext.disabled = idx >= STEPS.length - 1;
      renderQuickActions();
    }

    function stepIndex(stepId) {
      return STEPS.indexOf(stepId);
    }

    function stepByOffset(delta) {
      const idx = stepIndex(activeStep);
      const nextIdx = Math.min(STEPS.length - 1, Math.max(0, idx + delta));
      setStep(STEPS[nextIdx]);
    }

    async function setCurrentRun(runId) {
      if (!runId) return;
      appState.currentRunId = runId;
        if (runIdEl) runIdEl.textContent = runId;
      stopStatusUpdates();
      startRunStream(runId);
      updateCtas();
      await loadResults(runId, 0);
      scrollToStatusSection();
    }

    function setMessage(msg, target) {
      target.textContent = normalizeMessage(msg);
    }

    function formatHttpError(res, data, fallback) {
      const detail = data && (data.detail ?? data.message);
      const detailText = normalizeMessage(detail);
      const suffix = detailText ? `: ${detailText}` : '';
      return `${fallback} (HTTP ${res.status})${suffix}`;
    }

    function formatNetworkError(err, fallback) {
      const message = err && err.message ? err.message : '';
      if (
        message.includes('Failed to fetch') ||
        message.includes('NetworkError') ||
        message.includes('Load failed')
      ) {
        return t('network-error');
      }
      return message || fallback;
    }

    function briefSuccess(target) {
      target.textContent = t('saved');
      setTimeout(() => { target.textContent = ''; }, 2000);
    }

    function scrollToStatusSection() {
      if (statusSection && statusSection.scrollIntoView) {
        statusSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function getStartBlockReason() {
      const mode = form.querySelector('input[name="mode"]:checked')?.value || 'mixed';
      const hasCategory = Boolean(categorySelect.value) && !categorySelect.disabled;
      const hasFile = Boolean(fileInput.files && fileInput.files.length);
      const allowNoFile = mode === 'offline';
      if (appState.isStarting) return 'already-starting';
      if (!hasCategory) return 'missing-category';
      if (!hasFile && !allowNoFile) return 'missing-file';
      return '';
    }

    function updateStartState() {
      const hasCategory = Boolean(categorySelect.value) && !categorySelect.disabled;
      const hasFile = Boolean(fileInput.files && fileInput.files.length);
      const mode = form.querySelector('input[name="mode"]:checked')?.value || 'mixed';
      const allowNoFile = mode === 'offline';
      const blockReason = getStartBlockReason();
      startReady = blockReason === '';
      submitBtn.disabled = appState.isStarting || !startReady;
      if (startDbBtn) startDbBtn.disabled = !hasCategory;
      if (startHint) {
        if (!hasCategory) startHint.textContent = 'Wybierz kategorię.';
        else if (!hasFile && !allowNoFile) startHint.textContent = 'Dodaj plik (CSV/XLSX).';
        else if (!hasFile && allowNoFile) startHint.textContent = 'Offline: plik opcjonalny (używam bazy).';
        else startHint.textContent = '';
      }
      if (!startTouched) {
        categorySelectError.textContent = '';
        fileError.textContent = '';
        renderQuickActions();
        return startReady;
      }
      if (hasCategory) {
        categorySelectError.textContent = '';
      } else if (categorySelect.disabled) {
        categorySelectError.textContent = t('add-category-to-start');
      } else {
        categorySelectError.textContent = t('select-category');
      }
      fileError.textContent = hasFile || allowNoFile ? '' : t('select-file');
      renderQuickActions();
      return startReady;
    }

    function lockInputs(disabled) {
      if (categorySelect) categorySelect.disabled = disabled;
      if (fileInput) fileInput.disabled = disabled;
      modeRadios.forEach((r) => { r.disabled = disabled; });
    }

    function setStartUi(isStarting, note) {
      appState.isStarting = isStarting;
      if (submitBtn) submitBtn.disabled = isStarting || !startReady;
      const spinner = submitBtn?.querySelector('.start-spinner');
      const label = submitBtn?.querySelector('.start-label');
      if (spinner) spinner.classList.toggle('is-active', isStarting);
      if (label) label.textContent = isStarting ? 'Uruchamiam…' : 'Start analizy';
      if (startHint && note) {
        startHint.textContent = note;
      }
      /* single-line hint only */
    }

    function focusStatusHeading() {
      const heading = document.getElementById('current-analysis-title');
      if (heading) heading.focus({ preventScroll: true });
    }

    async function startAnalysis() {
      if (appState.isStarting) return;
      startTouched = true;
      const mode = form.querySelector('input[name="mode"]:checked')?.value || 'mixed';
      const hasFile = Boolean(fileInput.files && fileInput.files.length);
      const hasCategory = Boolean(categorySelect.value);
      const disabledReason = getStartBlockReason();
      console.info('START_CLICK', {
        mode,
        hasFile,
        category: categorySelect.value || null,
        endpoint: mode === 'offline' && !hasFile ? '/api/v1/analysis/run_from_cache' : '/api/v1/analysis/upload',
        disabledReason,
      });
      if (!updateStartState()) {
        console.warn('START_BLOCKED', { reason: disabledReason, hasCategory, hasFile, mode, startReady, isStarting: appState.isStarting });
        return;
      }
      if (!validateStrategies()) {
        console.warn('START_BLOCKED', { reason: 'strategy-validation', hasCategory, hasFile, mode });
        return;
      }

      setStartUi(true, 'Tworzę run…');
      lockInputs(true);
      if (mode === 'offline' && !hasFile) {
        await startFromDb(true);
        setStartUi(false);
        lockInputs(false);
        return;
      }
      if (runStage) runStage.textContent = 'Wysyłanie pliku…';

      const fd = new FormData();
      fd.append('file', fileInput.files[0]);
      fd.append('category_id', categorySelect.value);
      fd.append('mode', mode);
      fd.append('scrape_mode', mode);
      const limitVal = Number(offerLimitInput?.value || 0);
      if (Number.isFinite(limitVal) && limitVal > 0) fd.append('limit', String(limitVal));

      submitBtn.disabled = true;

      try {
        const res = await fetch('/api/v1/analysis/upload', { method: 'POST', body: fd });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = formatHttpError(res, data, t('error-run-start'));
          setMessage(`Błąd uploadu: ${msg}`, errorBox);
          return;
        }
        if (runIdEl) runIdEl.textContent = data.analysis_run_id;
        setStartUi(true, `Run: ${data.analysis_run_id}`);
      setStatus({ id: data.analysis_run_id, status: data.status, processed_products: 0, total_products: 0, error_message: '' });
        scrollToStatusSection();
        focusStatusHeading();
        startRunStream(data.analysis_run_id);
        await loadHistory();
      } catch (err) {
        setMessage(formatNetworkError(err, t('error-analysis')), errorBox);
        if (runStage) runStage.textContent = 'Błąd wysyłania';
      } finally {
        setStartUi(false);
        lockInputs(false);
        updateStartState();
      }
    }

    function initDropzone() {
      if (!dropzone || !fileInput) return;
      dropzone.addEventListener('click', () => fileInput.click());
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('is-dragover');
      });
      ['dragleave', 'dragend', 'drop'].forEach(evt => dropzone.addEventListener(evt, () => dropzone.classList.remove('is-dragover')));
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        if (e.dataTransfer?.files?.length) {
          fileInput.files = e.dataTransfer.files;
          updateStartState();
          if (settingsSummary) settingsSummary.textContent = `${e.dataTransfer.files.length} plik(ów) gotowe`;
        }
      });
      fileInput.addEventListener('change', updateStartState);
    }

    function applyDefaults() {
      if (cacheTtlRange) cacheTtlRange.value = settingsDefaults.cache_ttl_days;
      if (cacheTtlInput) cacheTtlInput.value = settingsDefaults.cache_ttl_days;
      if (offerLimitInput) offerLimitInput.value = '';
      if (dbLastDaysInput) dbLastDaysInput.value = settingsDefaults.db_last_days;
      if (dbOnlySuccessInput) dbOnlySuccessInput.checked = settingsDefaults.db_only_success;
      if (dbLimitInput) dbLimitInput.value = settingsDefaults.db_limit;
      if (dbAllCachedInput) dbAllCachedInput.checked = settingsDefaults.db_all_cached;
      if (dbSourceInput) dbSourceInput.value = settingsDefaults.db_source;
      if (dbEanContainsInput) dbEanContainsInput.value = settingsDefaults.db_ean_contains;
      toggleDbFilters();
      updateStrategiesForMode();
      updateSettingsSummary();
    }

    function updateSettingsSummary() {
      if (!settingsSummary) return;
      const mode = form.querySelector('input[name="mode"]:checked')?.value || 'mixed';
      const cache = cacheTtlInput?.value || '-';
      const limit = offerLimitInput?.value || 'brak';
      settingsSummary.textContent = `Tryb: ${mode} · Cache TTL: ${cache}d · Limit: ${limit}`;
    }

    function applyProfile() {}

    function updateCtas() {
      if (statusGoResultsBtn) statusGoResultsBtn.disabled = !appState.currentRunId;
    }

    function renderQuickActions() {
      const list = quickActionsList;
      if (!list) return;
      list.innerHTML = '';
      const addAction = (label, handler, opts = {}) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = opts.variant === 'ghost' ? 'ghost-btn' : 'action-btn';
        btn.textContent = label;
        if (opts.disabled) btn.disabled = true;
        btn.addEventListener('click', handler);
        list.appendChild(btn);
      };
      if (activeStep === 'import') {
        addAction('Reset', () => {
          form.reset();
          fileInput.value = '';
          updateStartState();
        }, { variant: 'ghost' });
        addAction('Przejdź do uruchomienia', () => setStep('run'), { variant: 'ghost', disabled: !startReady });
      } else if (activeStep === 'config') {
        addAction('Przejdź do uruchomienia', () => setStep('run'), { variant: 'ghost' });
      } else if (activeStep === 'run') {
        addAction('Start analizy', () => (form.requestSubmit ? form.requestSubmit() : submitBtn?.click()), { disabled: submitBtn?.disabled });
        addAction('Reset', () => resetBtn?.click(), { variant: 'ghost' });
      } else if (activeStep === 'status') {
        addAction('Kopiuj Run ID', () => {
          if (appState.currentRunId) navigator.clipboard.writeText(String(appState.currentRunId)).catch(() => {});
        }, { variant: 'ghost', disabled: !appState.currentRunId });
        addAction('Przejdź do wyników', () => setStep('results'), { disabled: !appState.currentRunId });
      } else if (activeStep === 'results') {
        addAction('Pobierz XLSX', () => exportReport('xlsx'), { disabled: !appState.currentRunId });
        addAction('Pobierz CSV', () => exportReport('csv'), { variant: 'ghost', disabled: !appState.currentRunId });
        addAction('Kopiuj link raportu', () => {
          if (!appState.currentRunId) return;
          const url = `${window.location.origin}/api/v1/analysis/${appState.currentRunId}/download`;
          navigator.clipboard.writeText(url).catch(() => {});
        }, { variant: 'ghost', disabled: !appState.currentRunId });
      } else {
        addAction('Do statusu', () => setStep('status'), { variant: 'ghost' });
      }
    }

    function setMode(modeValue) {
      const radio = form.querySelector(`input[name="mode"][value="${modeValue}"]`);
      if (radio) {
        radio.checked = true;
        updateStrategiesForMode();
      }
    }

    function setAdvancedVisible(enabled) {
      if (!settingsDetails) return;
      settingsDetails.open = !!enabled;
      if (advancedToggle) {
        advancedToggle.textContent = enabled ? 'Ukryj zaawansowane ⚙' : 'Ustawienia zaawansowane ⚙';
        advancedToggle.setAttribute('aria-expanded', enabled ? 'true' : 'false');
      }
      localStorage.setItem('ui.advancedPanel', enabled ? '1' : '0');
      if (enabled) settingsDetails.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function setActiveSettingsTab(tabId) {
      if (!settingsTabs || !tabId) return;
      settingsTabs.querySelectorAll('.tab-btn').forEach((btn) => {
        btn.classList.toggle('is-active', btn.dataset.tab === tabId);
      });
      document.querySelectorAll('[data-tab-panel]').forEach((panelEl) => {
        panelEl.classList.toggle('is-active', panelEl.dataset.tabPanel === tabId);
      });
      localStorage.setItem('ui.settingsTab', tabId);
    }

    function initSettingsTabs() {
      if (!settingsTabs) return;
      const stored = localStorage.getItem('ui.settingsTab');
      const initial = stored || settingsTabs.querySelector('.tab-btn')?.dataset.tab;
      if (initial) setActiveSettingsTab(initial);
      settingsTabs.addEventListener('click', (e) => {
        const target = e.target.closest('.tab-btn');
        if (!target) return;
        setActiveSettingsTab(target.dataset.tab);
      });
    }

    // Stepper interactions
    if (stepperRoot) {
      stepperRoot.addEventListener('click', (e) => {
        const btn = e.target.closest('.stepper-item');
        if (!btn) return;
        setStep(btn.dataset.step);
      });
    }
    if (stepperSelect) {
      stepperSelect.innerHTML = STEPS.map((s) => `<option value=\"${s}\">${STEP_LABELS[s] || s}</option>`).join('');
      stepperSelect.addEventListener('change', (e) => setStep(e.target.value));
    }
    if (stepPrev) stepPrev.addEventListener('click', () => stepByOffset(-1));
    if (stepNext) stepNext.addEventListener('click', () => stepByOffset(1));
    if (quickLastRunBtn) quickLastRunBtn.addEventListener('click', () => setStep('history'));
    if (quickCopyRunBtn) quickCopyRunBtn.addEventListener('click', () => {
      const toCopy = appState.currentRunId;
      if (!toCopy) return;
      navigator.clipboard.writeText(String(toCopy)).catch(() => {});
    });
    if (statusGoResultsBtn) statusGoResultsBtn.addEventListener('click', () => {
      resultsSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      focusStatusHeading();
      if (appState.currentRunId) openResultsModal(appState.currentRunId);
    });
    if (exportXlsxBtn) exportXlsxBtn.addEventListener('click', () => exportReport('xlsx'));
    if (exportCsvBtn) exportCsvBtn.addEventListener('click', () => exportReport('csv'));
    if (copyReportLinkBtn) copyReportLinkBtn.addEventListener('click', () => {
      if (!appState.currentRunId) {
        resultsError.textContent = currentLang === 'en' ? 'No active run to copy.' : 'Brak aktywnego runa.';
        return;
      }
      const url = `${window.location.origin}/api/v1/analysis/${appState.currentRunId}/download`;
      navigator.clipboard.writeText(url).catch(() => {});
    });
    const moreHistoryBtn = document.getElementById('more-history-btn');
    if (moreHistoryBtn) {
      moreHistoryBtn.addEventListener('click', () => setStep('history'));
    }

    function formatDateTime(value) {
      if (!value) return '-';
      try {
        return new Date(value).toLocaleString();
      } catch (err) {
        return String(value);
      }
    }

    function formatDateShort(value) {
      if (!value) return '-';
      try {
        const date = new Date(value);
        return date.toLocaleString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
      } catch (err) {
        return String(value);
      }
    }

    function formatMoney(value) {
      if (value === null || value === undefined) return '—';
      const num = Number(value);
      if (Number.isNaN(num)) return '—';
      return `${num.toFixed(2)} zł`;
    }

    function formatMoneyWithCurrency(value, currency) {
      if (value === null || value === undefined) return '—';
      const num = Number(value);
      if (Number.isNaN(num)) return '—';
      const code = (currency || 'PLN').toUpperCase();
      const suffix = code === 'PLN' ? 'zł' : code;
      return `${num.toFixed(2)} ${suffix}`;
    }

    function formatPercent(value) {
      if (value === null || value === undefined) return '—';
      const num = Number(value);
      if (Number.isNaN(num)) return '—';
      return `${num.toFixed(1)}%`;
    }

    function statusLabel(status) {
      const map = {
        pending: t('status_pending'),
        running: t('status_running'),
        completed: t('status_completed'),
        failed: t('status_failed'),
        canceled: t('status_canceled'),
      };
      return map[status] || status || '—';
    }

    function modeLabel(mode) {
      const key = String(mode || '').toLowerCase();
      const map = {
        mixed: t('mode_mixed_label'),
        offline: t('mode_offline_label'),
        online: t('mode_online_label'),
      };
      return map[key] || mode || '—';
    }

    function renderCurrencyRows(rates) {
      if (!currencyList) {
        console.warn('UI wiring: cannot render currencies, #currency-list missing');
        return;
      }
      currencyList.innerHTML = '';
      rates.forEach((r, idx) => {
        const row = document.createElement('div');
        row.className = 'currency-row';
        row.innerHTML = `
          <input class="currency-code" data-idx="${idx}" type="text" value="${r.currency}" />
          <input class="currency-rate" data-idx="${idx}" type="number" step="0.0001" min="0" value="${r.rate_to_pln}" />
          <div class="currency-actions">
            <button type="button" class="ghost-btn ghost-btn--small" data-default="${idx}" title="Ustaw jako domyślną">
              ${r.is_default ? '★' : '☆'}
            </button>
            <button type="button" class="ghost-btn ghost-btn--small" data-remove="${idx}">Usuń</button>
          </div>
        `;
        currencyList.appendChild(row);
      });
    }

    function readCurrencyPayload() {
      if (!currencyList) return [];
      const codes = Array.from(currencyList.querySelectorAll('input.currency-code')).map(el => el.value.trim().toUpperCase());
      const rates = Array.from(currencyList.querySelectorAll('input.currency-rate')).map(el => parseFloat(el.value));
      const defaults = Array.from(currencyList.querySelectorAll('[data-default]')).map((btn) => btn.textContent === '★');
      const payload = [];
      codes.forEach((code, idx) => {
        if (!code) return;
        payload.push({ currency: code, rate_to_pln: rates[idx], is_default: defaults[idx] || false });
      });
      return payload;
    }

    async function loadCurrencyRates() {
      if (!currencyList || !currencyHelper || !currencyError || !currencySuccess) {
        console.warn('UI wiring: currency UI missing, skipping loadCurrencyRates');
        return;
      }
      currencyError.textContent = '';
      currencySuccess.textContent = '';
      try {
        const res = await fetch('/api/v1/settings/currencies');
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(formatHttpError(res, data, t('error-fetch-rates')));
        }
        renderCurrencyRows(data.rates || []);
        currencyHelper.textContent = t('rates-helper');
      } catch (err) {
        currencyError.textContent = formatNetworkError(err, t('error-fetch-rates-network'));
      }
    }

    async function saveCurrencyRates() {
      if (!currencyList || !currencyError || !currencySuccess) {
        console.warn('UI wiring: currency UI missing, skipping saveCurrencyRates');
        return;
      }
      currencyError.textContent = '';
      currencySuccess.textContent = '';
      const payload = { rates: readCurrencyPayload() };
      try {
        const res = await fetch('/api/v1/settings/currencies', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        let data = {};
        const contentType = res.headers.get('content-type') || '';
        if (contentType.includes('application/json')) {
          data = await res.json().catch(() => ({}));
        }
        if (!res.ok) {
          throw new Error(formatHttpError(res, data, t('error-save-rates')));
        }
        renderCurrencyRows(data.rates || []);
        currencySuccess.textContent = t('rates-saved');
        setTimeout(() => { currencySuccess.textContent = ''; }, 2000);
      } catch (err) {
        currencyError.textContent = formatNetworkError(err, t('error-save-rates-network'));
      }
    }

    function renderStrategies(run) {
      const strategies = [];
      if (run.use_local_scraper) strategies.push(t('strategy-local'));
      if (run.use_cloud_http) strategies.push(t('strategy-cloud'));
      return strategies.length ? strategies.join(' · ') : t('strategies-none');
    }

    function renderActiveRuns(runs) {
      if (!activeRuns || !activeRunsError || !activeRunsEmpty) return;
      activeRuns.innerHTML = '';
      activeRunsError.textContent = '';
      if (!runs.length) {
        activeRunsEmpty.style.display = 'block';
        return;
      }
      activeRunsEmpty.style.display = 'none';

      runs.forEach((run) => {
        const card = document.createElement('div');
        card.className = 'active-run';
        card.innerHTML = `
          <div class="active-run__top">
            <span class="badge ${run.status}">${statusLabel(run.status)}</span>
            <span class="muted">#${run.id}</span>
          </div>
          <div class="active-run__title">${run.category_name || t('category-removed')}</div>
          <div class="active-run__meta">${run.processed_products}/${run.total_products} · ${formatDateTime(run.created_at)}</div>
          <div class="active-run__actions"></div>
        `;

        const actions = card.querySelector('.active-run__actions');
        if (actions) {
          const preview = document.createElement('button');
          preview.type = 'button';
          preview.className = 'action-btn secondary';
          preview.textContent = t('btn-preview');
          preview.addEventListener('click', () => setCurrentRun(run.id).then(() => openResultsModal(run.id)));
          actions.appendChild(preview);

          if (run.status === 'pending' || run.status === 'running') {
            const cancel = document.createElement('button');
            cancel.type = 'button';
            cancel.className = 'ghost-btn';
            cancel.textContent = t('btn-cancel');
            cancel.addEventListener('click', () => cancelRun(run.id));
            actions.appendChild(cancel);
          }
        }

        activeRuns.appendChild(card);
      });
    }

    async function loadActiveRuns() {
      if (!activeRuns || !activeRunsEmpty || !activeRunsError) return;
      activeRunsError.textContent = '';
      try {
        const res = await fetch('/api/v1/analysis/active');
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(formatHttpError(res, data, t('error-fetch-active')));
        }
        const runs = Array.isArray(data) ? data : (data.runs || []);
        renderActiveRuns(runs.slice(0, 3));
        const activeRun = runs.find((run) => run.status === 'pending' || run.status === 'running');
        if (activeRun) {
          appState.currentRunId = activeRun.id;
          if (String(runStreamState.runId || '') !== String(activeRun.id)) {
            runIdEl.textContent = activeRun.id;
            setStatus({ ...activeRun, id: activeRun.id, updated_at: new Date().toISOString() });
            startRunStream(activeRun.id);
          }
        } else if (runStreamState.runId) {
          stopRunStream();
        }
      } catch (err) {
        activeRuns.innerHTML = '';
        activeRunsEmpty.style.display = 'none';
        activeRunsError.textContent = formatNetworkError(err, t('error-fetch-active'));
      }
    }

    function renderMarketTable(data) {
      if (!data.items || !data.items.length) {
        marketTable.innerHTML = `<div class="helper">${t('no-data')}</div>`;
      } else {
        const rows = data.items.map((item) => `
          <tr>
            <td class="cell-ean" data-col="ean">${item.ean || '—'}</td>
            <td class="cell-name" data-col="name">${item.name || '—'}</td>
            <td data-col="category">${item.category_name || '—'}</td>
            <td class="cell-num" data-col="purchase_price">${formatMoney(item.purchase_price_pln)}</td>
            <td class="cell-num" data-col="allegro_price">${formatMoney(item.allegro_price_pln)}</td>
            <td class="cell-num" data-col="sold_count">${item.sold_count ?? '—'}</td>
            <td class="cell-source" data-col="source">${item.source || '—'}</td>
            <td class="cell-date" data-col="last_checked_at">${formatDateShort(item.last_checked_at)}</td>
            <td class="cell-date" data-col="last_run_at" title="${item.last_run_id ? `run #${item.last_run_id}` : ''}">${formatDateShort(item.last_run_at)}</td>
          </tr>
        `).join('');
        marketTable.innerHTML = `
          <div class="table-scroll">
            <table>
              <thead>
                <tr>
                  <th class="cell-ean" data-col="ean">EAN</th>
                  <th data-col="name">Nazwa</th>
                  <th data-col="category">Kategoria</th>
                  <th class="cell-num" data-col="purchase_price">Cena zakupu (PLN)</th>
                  <th class="cell-num" data-col="allegro_price">Cena Allegro</th>
                  <th class="cell-num" data-col="sold_count">Sprzedanych</th>
                  <th class="cell-source" data-col="source">Źródło</th>
                  <th class="cell-date" data-col="last_checked_at">Ostatnio sprawdz.</th>
                  <th class="cell-date" data-col="last_run_at">Ostatni run</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
        applyMarketColumns();
        applyColumnHeaders();
      }

      const start = data.total ? Math.min(data.total, marketState.offset + 1) : 0;
      const end = data.total ? Math.min(data.total, marketState.offset + marketState.limit) : (data.items?.length || 0);
      const rangeLabel = currentLang === 'en' ? `${start}-${end} of ${data.total}` : `${start}-${end} z ${data.total}`;
      const rowsLabel = currentLang === 'en' ? `${end} rows` : `${end} wierszy`;
      marketPageInfo.textContent = data.total ? rangeLabel : rowsLabel;
      marketPrev.disabled = marketState.offset <= 0;
      marketNext.disabled = marketState.offset + marketState.limit >= (data.total || 0);
    }

    function scrapeStatusLabel(status) {
      const map = {
        pending: t('scrape_pending'),
        in_progress: t('scrape_in_progress'),
        blocked: t('scrape_blocked'),
        network_error: t('scrape_network_error'),
        error: t('scrape_error'),
        not_found: t('scrape_not_found'),
        not_visible: t('scrape_not_found'),
        no_offers_found: t('scrape_not_found'),
        auctions_only: t('scrape_not_found'),
        ok: t('scrape_ok'),
      };
      return map[status] || t('scrape_ok');
    }

    function buildResultsRowCells(item) {
      const profitableLabel = item.is_profitable === true
        ? t('profitable_yes')
        : item.is_profitable === false
          ? t('profitable_no')
          : t('profitable_unknown');
      const scrapeStatus = item.scrape_status || 'ok';
      const statusLabelText = scrapeStatusLabel(scrapeStatus);
      return `
        <td data-col="ean">${item.ean || '—'}</td>
        <td data-col="name">${item.name || '—'}</td>
        <td data-col="currency">${item.original_currency || 'PLN'}</td>
        <td data-col="purchase_price">${formatMoneyWithCurrency(item.original_purchase_price, item.original_currency)}</td>
        <td data-col="allegro_price">${formatMoney(item.allegro_price_pln)}</td>
        <td data-col="margin">${formatMoney(item.margin_pln)}</td>
        <td data-col="margin_percent">${formatPercent(item.margin_percent)}</td>
        <td data-col="profitable">${profitableLabel}</td>
        <td data-col="source">${item.source ? `<span class="source-chip">${item.source}</span>` : '—'}</td>
        <td data-col="last_checked_at">${formatDateTime(item.last_checked_at)}</td>
        <td data-col="scrape_status"><span class="status-chip ${scrapeStatus}">${statusLabelText}</span></td>
      `;
    }

    function buildResultsDetailCells(item, colspan) {
      const scrapeStatus = item.scrape_status || 'ok';
      const statusLabelText = scrapeStatusLabel(scrapeStatus);
      return `
        <td colspan="${colspan}">
          <div class="detail-grid">
            <div><strong>${t('label-source-colon')}</strong> ${item.source || '—'}</div>
            <div><strong>${t('label-scrape-status-colon')}</strong> ${statusLabelText}</div>
            <div><strong>${t('label-last-checked-colon')}</strong> ${formatDateTime(item.last_checked_at)}</div>
            <div><strong>${t('label-scrape-error-colon')}</strong> ${item.scrape_error_message || '—'}</div>
            <div><strong>${t('label-original-currency')}</strong> ${item.original_currency || 'PLN'}</div>
            <div><strong>${t('label-original-price')}</strong> ${item.original_purchase_price !== null && item.original_purchase_price !== undefined ? item.original_purchase_price + ' ' + (item.original_currency || '') : '—'}</div>
            <div><strong>${t('label-sold-count')}</strong> ${item.sold_count ?? '—'}</div>
            <div><strong>${t('label-sold-count-status')}</strong> ${item.sold_count_status || '—'}</div>
          </div>
        </td>
      `;
    }

    function ensureResultsTableStructure() {
      if (!resultsTable.querySelector('table')) {
        resultsTable.innerHTML = `
          <div class="results-table__inner">
            <table>
              <thead>
                <tr>
                  <th data-col="ean">EAN</th>
                  <th data-col="name">Nazwa</th>
                  <th data-col="currency">Waluta</th>
                  <th data-col="purchase_price">Cena zakupu</th>
                  <th data-col="allegro_price">Cena Allegro</th>
                  <th data-col="margin">Marża</th>
                  <th data-col="margin_percent">Marża %</th>
                  <th data-col="profitable">Opłacalny</th>
                  <th data-col="source">Źródło</th>
                  <th data-col="last_checked_at">Ostatnio sprawdzono</th>
                  <th data-col="scrape_status">Status</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        `;
        resultsTable.querySelectorAll('th').forEach((th) => {
          th.style.cursor = 'pointer';
          th.addEventListener('click', () => toggleResultsSort(th.dataset.col));
        });
      }
      return resultsTable.querySelector('tbody');
    }

    const resultsFilters = {
      search: '',
      profitable: false,
      errors: false,
      missingPrice: false,
      sortCol: null,
      sortDir: 'asc',
    };

    function toggleResultsSort(col) {
      if (!col) return;
      if (resultsFilters.sortCol === col) {
        resultsFilters.sortDir = resultsFilters.sortDir === 'asc' ? 'desc' : 'asc';
      } else {
        resultsFilters.sortCol = col;
        resultsFilters.sortDir = 'asc';
      }
      applyResultsFiltersAndSort();
    }

    function applyResultsFiltersAndSort() {
      if (!resultsTable.querySelector('tbody')) return;
      const tbody = resultsTable.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr[data-id]'));
      const search = (resultsFilters.search || '').toLowerCase();

      rows.forEach((row) => {
        const detail = tbody.querySelector(`tr[data-detail-id="${row.dataset.id}"]`);
        let visible = true;
        if (search) {
          visible =
            (row.dataset.ean || '').toLowerCase().includes(search) ||
            (row.dataset.name || '').toLowerCase().includes(search);
        }
        if (resultsFilters.profitable && row.dataset.profitable !== 'yes') visible = false;
        if (resultsFilters.errors && row.dataset.scrapeStatus === 'ok') visible = false;
        if (resultsFilters.missingPrice && row.dataset.priceMissing !== '1') visible = false;
        row.style.display = visible ? '' : 'none';
        if (detail) detail.style.display = visible ? 'none' : 'none'; // hide details when filtering; reopened on click
      });

      if (resultsFilters.sortCol) {
        const pairs = rows.map((row) => {
          const detail = tbody.querySelector(`tr[data-detail-id="${row.dataset.id}"]`);
          return { row, detail };
        });
        const dir = resultsFilters.sortDir === 'asc' ? 1 : -1;
        pairs.sort((a, b) => {
          const col = resultsFilters.sortCol;
          const av = rowSortValue(a.row, col);
          const bv = rowSortValue(b.row, col);
          if (av < bv) return -1 * dir;
          if (av > bv) return 1 * dir;
          return 0;
        });
        tbody.innerHTML = '';
        pairs.forEach(({ row, detail }) => {
          tbody.appendChild(row);
          if (detail) tbody.appendChild(detail);
        });
      }
    }

    function rowSortValue(row, col) {
      if (!row) return '';
      if (['allegro_price', 'margin', 'margin_percent'].includes(col)) {
        const map = {
          allegro_price: row.dataset.allegroPrice,
          margin: row.dataset.margin,
          margin_percent: row.dataset.marginPercent,
        };
        return Number(map[col] ?? 0);
      }
      return (row.dataset[col] || row.textContent || '').toString().toLowerCase();
    }

    function toggleResultsDetail(id) {
      const detail = resultsTable.querySelector(`tr[data-detail-id="${id}"]`);
      if (!detail) return;
      const isVisible = detail.style.display === 'table-row';
      detail.style.display = isVisible ? 'none' : 'table-row';
    }

    function upsertResultsRow(item) {
      if (!resultsTable || !item || !item.id) return;
      const tbody = ensureResultsTableStructure();
      const rowId = String(item.id);
      const rowNumber = Number(item.row_number || 0);
      const visibleCount = getResultsVisibleCount();

      let row = tbody.querySelector(`tr[data-id="${rowId}"]`);
      let detail = tbody.querySelector(`tr[data-detail-id="${rowId}"]`);
      if (row) {
        row.innerHTML = buildResultsRowCells(item);
      } else {
        row = document.createElement('tr');
        row.dataset.id = rowId;
        if (rowNumber) row.dataset.rowNumber = String(rowNumber);
        row.innerHTML = buildResultsRowCells(item);
        row.addEventListener('click', () => toggleResultsDetail(rowId));
      }
      row.dataset.ean = item.ean || '';
      row.dataset.name = item.name || '';
      row.dataset.profitable = item.is_profitable === true ? 'yes' : item.is_profitable === false ? 'no' : 'unknown';
      row.dataset.scrapeStatus = item.scrape_status || 'ok';
      row.dataset.priceMissing = item.allegro_price_pln === null || item.allegro_price_pln === undefined ? '1' : '0';
      row.dataset.allegroPrice = item.allegro_price_pln !== null && item.allegro_price_pln !== undefined ? Number(item.allegro_price_pln) : '';
      row.dataset.margin = item.margin_pln !== null && item.margin_pln !== undefined ? Number(item.margin_pln) : '';
      row.dataset.marginPercent = item.margin_percent !== null && item.margin_percent !== undefined ? Number(item.margin_percent) : '';

      if (detail) {
        detail.innerHTML = buildResultsDetailCells(item, visibleCount);
      } else {
        detail = document.createElement('tr');
        detail.className = 'results-detail';
        detail.dataset.detailId = rowId;
        detail.style.display = 'none';
        detail.innerHTML = buildResultsDetailCells(item, visibleCount);
      }

      if (!row.parentElement) {
        const rows = Array.from(tbody.querySelectorAll('tr[data-id]'));
        const insertBefore = rows.find((existing) => {
          const existingNumber = Number(existing.dataset.rowNumber || 0);
          return rowNumber && existingNumber && existingNumber > rowNumber;
        });
        if (insertBefore) {
          tbody.insertBefore(row, insertBefore);
          tbody.insertBefore(detail, insertBefore);
        } else {
          tbody.appendChild(row);
          tbody.appendChild(detail);
        }
      }
      applyResultsColumns();
    }

    function renderResultsTable(data) {
      resultsError.textContent = data.error_message || '';
      const runLabel = t('run-label') || 'Run';
      const metaParts = [`${runLabel} #${data.run_id}`, `${t('label-status')} ${statusLabel(data.status)}`];
      if (typeof data.total === 'number') {
        const rowsLabel = currentLang === 'en' ? 'Rows' : 'Wiersze';
        metaParts.push(`${rowsLabel}: ${data.total}`);
      }
      resultsMeta.textContent = metaParts.join(' · ');
      if (data.status === 'canceled') {
        resultsBanner.textContent = data.error_message || t('analysis-canceled');
        resultsBanner.style.display = 'block';
      } else {
        resultsBanner.textContent = '';
        resultsBanner.style.display = 'none';
      }

      if (!data.items || !data.items.length) {
        resultsTable.innerHTML = '';
        resultsEmpty.style.display = 'block';
        if (data.status === 'failed') {
          resultsEmpty.textContent = data.error_message || t('analysis-failed-no-data');
        } else if (data.status === 'canceled') {
          resultsEmpty.textContent = data.error_message || t('analysis-canceled');
        } else {
          resultsEmpty.textContent = data.error_message || t('no-data');
        }
      } else {
        resultsEmpty.style.display = 'none';
        ensureResultsTableStructure();
        const tbody = resultsTable.querySelector('tbody');
        tbody.innerHTML = '';
        data.items.forEach((item) => {
          upsertResultsRow(item);
        });
        applyResultsColumns();
        applyColumnHeaders();
      }
      applyResultsFiltersAndSort();

      const start = previewState.total ? Math.min(previewState.total, previewState.offset + 1) : 0;
      const end = previewState.total ? Math.min(previewState.total, previewState.offset + previewState.limit) : (data.items?.length || 0);
      const rangeLabel = currentLang === 'en' ? `${start}-${end} of ${previewState.total}` : `${start}-${end} z ${previewState.total}`;
      const rowsLabel = currentLang === 'en' ? `${end} rows` : `${end} wierszy`;
      resultsPageInfo.textContent = previewState.total ? rangeLabel : rowsLabel;
      resultsPrev.disabled = previewState.offset <= 0;
      resultsNext.disabled = previewState.offset + previewState.limit >= (previewState.total || 0);
    }

    async function loadResults(runId, offset = 0) {
      if (!runId) return;
      resultsError.textContent = '';
      resultsEmpty.style.display = 'none';
      resultsBanner.textContent = '';
      resultsBanner.style.display = 'none';
      resultsTable.innerHTML = `<div class="helper">${t('loading-results')}</div>`;
      try {
        const res = await fetch(`/api/v1/analysis/${runId}/results?offset=${offset}&limit=${previewState.limit}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          resultsError.textContent = formatHttpError(res, data, t('error-fetch-results'));
          resultsTable.innerHTML = '';
          resultsPageInfo.textContent = '';
          resultsPrev.disabled = true;
          resultsNext.disabled = true;
          return;
        }
        previewState.runId = runId;
        previewState.offset = offset;
        previewState.total = data.total || 0;
        renderResultsTable(data);
      } catch (err) {
        resultsError.textContent = formatNetworkError(err, t('error-fetch-results-network'));
        resultsTable.innerHTML = '';
      }
    }

    function openResultsModal(runId) {
      if (!runId) return;
      resultsModal.style.display = 'flex';
      previewState.runId = runId;
      loadResults(runId, 0);
    }

    function closeResultsModal() {
      resultsModal.style.display = 'none';
    }

    function populateMarketCategories() {
      const current = marketCategory.value;
      const anyLabel = currentLang === 'en' ? 'Any' : 'Dowolna';
      marketCategory.innerHTML = `<option value="">${anyLabel}</option>`;
      categoriesCache.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = cat.name;
        if (cat.id === current) opt.selected = true;
        marketCategory.appendChild(opt);
      });
    }

    async function loadMarketData(offset = 0, silent = false) {
      marketError.textContent = '';
      if (!silent) {
        marketTable.innerHTML = `<div class="helper">${t('loading')}</div>`;
      }
      const params = new URLSearchParams();
      if (marketCategory.value) params.append('category_id', marketCategory.value);
      if (marketEan.value) params.append('ean', marketEan.value);
      if (marketSource.value) params.append('source', marketSource.value);
      if (marketDate.value) params.append('updated_since', marketDate.value);
      params.append('offset', String(offset));
      params.append('limit', String(marketState.limit));
      try {
        const res = await fetch(`/api/v1/market-data?${params.toString()}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(formatHttpError(res, data, t('error-fetch-market')));
        }
        marketState.offset = offset;
        marketState.total = data.total || 0;
        renderMarketTable(data);
      } catch (err) {
        marketError.textContent = formatNetworkError(err, t('error-fetch-market-network'));
        marketTable.innerHTML = '';
      }
    }

    function renderCategoriesList() {
      if (!categoriesCache.length) {
        categoriesList.textContent = '';
        return;
      }
      categoriesList.innerHTML = '';
      categoriesCache.forEach(cat => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'ghost-btn ghost-btn--small';
        btn.textContent = cat.name;
        btn.addEventListener('click', () => openCategoryDetail(cat.id));
        categoriesList.appendChild(btn);
      });
    }

    async function loadCategories() {
      try {
        const res = await fetch('/api/v1/categories/');
        const data = await res.json().catch(() => ([]));
        if (!res.ok) {
          throw new Error(formatHttpError(res, data, t('error-fetch-categories')));
        }
        categoriesCache = data;
        if (!data.length) {
          categorySelect.innerHTML = '';
          categorySelect.disabled = true;
          categoryInfo.textContent = t('categories-empty');
          categoriesList.textContent = '';
          updateStartState();
          return;
        }
        categorySelect.innerHTML = data.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        categorySelect.disabled = false;
        categoryInfo.textContent = '';
        renderCategoriesList();
        populateMarketCategories();
        updateStartState();
      } catch (err) {
        categoryInfo.textContent = formatNetworkError(err, t('error-fetch-categories'));
        submitBtn.disabled = true;
        updateStartState();
      }
    }

    function validateStrategies() {
      const mode = form.querySelector('input[name="mode"]:checked')?.value || 'mixed';
      if (strategyOfflineHint) {
        if (mode === 'offline') {
          strategyOfflineHint.textContent = t('hint-offline');
        } else {
          strategyOfflineHint.textContent = '';
        }
      }
      if (strategyError) setMessage('', strategyError);
      return true;
    }

    function updateStrategiesForMode() {
      validateStrategies();
      const mode = form.querySelector('input[name="mode"]:checked')?.value || 'mixed';
      const ttlDisabled = mode === 'offline';
      if (cacheTtlInput) cacheTtlInput.disabled = ttlDisabled;
      if (cacheTtlRange) cacheTtlRange.disabled = ttlDisabled;
      if (modeHelper) {
        const helperMap = {
          offline: 'Offline: tylko baza, brak zapytań online (plik opcjonalny).',
          mixed: 'Mixed: baza + dogrywka braków online.',
          online: 'Online: zawsze świeże dane, może być wolniej/drożej.',
        };
        modeHelper.textContent = helperMap[mode] || '';
      }
    }

    function setAccordionState(toggle, body, open, storageKey) {
      body.classList.toggle('is-hidden', !open);
      toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      const icon = toggle.querySelector('span');
      if (icon) icon.textContent = open ? '▾' : '▸';
      if (storageKey) localStorage.setItem(storageKey, open ? '1' : '0');
    }

    function initAccordion(toggle, body, storageKey, defaultOpen = false) {
      if (!toggle || !body) return;
      const stored = storageKey ? localStorage.getItem(storageKey) : null;
      const open = stored === null ? defaultOpen : stored === '1';
      setAccordionState(toggle, body, open, storageKey);
      toggle.addEventListener('click', () => {
        const isOpen = toggle.getAttribute('aria-expanded') === 'true';
        setAccordionState(toggle, body, !isOpen, storageKey);
      });
    }

    function toggleDbFilters() {
      const allCached = false;
      dbLastDaysInput.disabled = false;
    }

    function defaultColumnSet(columns) {
      return new Set(columns.filter(col => col.default).map(col => col.id));
    }

    function loadColumnSet(key, columns) {
      const raw = localStorage.getItem(key);
      if (!raw) return defaultColumnSet(columns);
      try {
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return defaultColumnSet(columns);
        const allowed = new Set(columns.map(col => col.id));
        const filtered = parsed.filter((id) => allowed.has(id));
        if (!filtered.length) return defaultColumnSet(columns);
        return new Set(filtered);
      } catch (err) {
        return defaultColumnSet(columns);
      }
    }

    function saveColumnSet(key, set) {
      localStorage.setItem(key, JSON.stringify(Array.from(set)));
    }

    function collectColumnSelection(container) {
      return new Set(
        Array.from(container.querySelectorAll('input[type="checkbox"]'))
          .filter((input) => input.checked)
          .map((input) => input.value),
      );
    }

    function columnLabel(col) {
      if (col && col.labelKey) {
        return t(col.labelKey);
      }
      return col?.label || col?.id || '';
    }

    function renderColumnPicker(container, columns, key, onApply) {
      if (!container) return;
      const enabled = loadColumnSet(key, columns);
      container.innerHTML = '';
      columns.forEach((col) => {
        const label = document.createElement('label');
        label.innerHTML = `
          <input type="checkbox" value="${col.id}" ${enabled.has(col.id) ? 'checked' : ''} />
          <span>${columnLabel(col)}</span>
        `;
        container.appendChild(label);
      });
      container.querySelectorAll('input[type="checkbox"]').forEach((input) => {
        input.addEventListener('change', () => {
          let nextSet = collectColumnSelection(container);
          if (!nextSet.size) {
            nextSet = defaultColumnSet(columns);
            saveColumnSet(key, nextSet);
            renderColumnPicker(container, columns, key, onApply);
            onApply();
            return;
          }
          saveColumnSet(key, nextSet);
          onApply();
        });
      });
    }

    function applyColumnVisibility(rootEl, columns, enabledSet) {
      if (!rootEl) return;
      columns.forEach((col) => {
        rootEl.querySelectorAll(`[data-col="${col.id}"]`).forEach((el) => {
          el.classList.toggle('is-hidden', !enabledSet.has(col.id));
        });
      });
    }

    function applyColumnHeaders() {
      if (resultsTable) {
        RESULTS_COLUMNS.forEach((col) => {
          resultsTable.querySelectorAll(`th[data-col="${col.id}"]`).forEach((el) => {
            el.textContent = columnLabel(col);
          });
        });
      }
      if (marketTable) {
        MARKET_COLUMNS.forEach((col) => {
          marketTable.querySelectorAll(`th[data-col="${col.id}"]`).forEach((el) => {
            el.textContent = columnLabel(col);
          });
        });
      }
    }

    function getResultsVisibleCount() {
      const enabled = loadColumnSet(RESULTS_COLUMNS_KEY, RESULTS_COLUMNS);
      return Math.max(1, enabled.size);
    }

    function applyResultsColumns() {
      if (!resultsTable) return;
      const enabled = loadColumnSet(RESULTS_COLUMNS_KEY, RESULTS_COLUMNS);
      applyColumnVisibility(resultsTable, RESULTS_COLUMNS, enabled);
      resultsTable.querySelectorAll('.results-detail td').forEach((cell) => {
        cell.colSpan = Math.max(1, enabled.size);
      });
    }

    function applyMarketColumns() {
      if (!marketTable) return;
      const enabled = loadColumnSet(MARKET_COLUMNS_KEY, MARKET_COLUMNS);
      applyColumnVisibility(marketTable, MARKET_COLUMNS, enabled);
    }

    function applyCompactMode() {
      const enabled = localStorage.getItem(COMPACT_TABLE_KEY) === '1';
      if (resultsTable) resultsTable.classList.toggle('is-compact', enabled);
      if (marketTable) marketTable.classList.toggle('is-compact', enabled);
      if (compactTableToggle) compactTableToggle.checked = enabled;
    }

    function exportReport(format) {
      if (!resultsError) return;
      resultsError.textContent = '';
      if (!appState.currentRunId) {
        resultsError.textContent = currentLang === 'en' ? 'No active run to export.' : 'Brak aktywnego runa do eksportu.';
        return;
      }
      const suffix = format ? `?format=${format}` : '';
      const url = `/api/v1/analysis/${appState.currentRunId}/download${suffix}`;
      fetch(url, { method: 'HEAD' })
        .then((res) => {
          if (!res.ok) {
            resultsError.textContent = currentLang === 'en' ? 'Endpoint eksportu nie działa jeszcze.' : 'Endpoint eksportu nie działa jeszcze.';
            return;
          }
          window.open(url, '_blank');
        })
        .catch(() => {
          resultsError.textContent = currentLang === 'en' ? 'Endpoint eksportu nie działa jeszcze.' : 'Endpoint eksportu nie działa jeszcze.';
        });
    }

    function initTablePreferences() {
      renderColumnPicker(resultsColumnsEl, RESULTS_COLUMNS, RESULTS_COLUMNS_KEY, () => {
        applyResultsColumns();
      });
      renderColumnPicker(marketColumnsEl, MARKET_COLUMNS, MARKET_COLUMNS_KEY, () => {
        applyMarketColumns();
      });
      if (resultsColumnsReset) {
        resultsColumnsReset.addEventListener('click', () => {
          const defaults = defaultColumnSet(RESULTS_COLUMNS);
          saveColumnSet(RESULTS_COLUMNS_KEY, defaults);
          renderColumnPicker(resultsColumnsEl, RESULTS_COLUMNS, RESULTS_COLUMNS_KEY, applyResultsColumns);
          applyResultsColumns();
        });
      }
      if (marketColumnsReset) {
        marketColumnsReset.addEventListener('click', () => {
          const defaults = defaultColumnSet(MARKET_COLUMNS);
          saveColumnSet(MARKET_COLUMNS_KEY, defaults);
          renderColumnPicker(marketColumnsEl, MARKET_COLUMNS, MARKET_COLUMNS_KEY, applyMarketColumns);
          applyMarketColumns();
        });
      }
      if (compactTableToggle) {
        compactTableToggle.addEventListener('change', () => {
          localStorage.setItem(COMPACT_TABLE_KEY, compactTableToggle.checked ? '1' : '0');
          applyCompactMode();
        });
      }
      applyCompactMode();
      applyResultsColumns();
      applyMarketColumns();
    }

    function setLastUpdated(value) {
      if (!runUpdatedEl) return;
      if (!value) {
        runUpdatedEl.textContent = '—';
        return;
      }
      runUpdatedEl.textContent = formatDateTime(value);
    }

    function setSpinner(status) {
      if (!statusSpinner) return;
      const active = status === 'pending' || status === 'running';
      statusSpinner.classList.toggle('is-active', active);
    }

    function appendStatusLog(message, level = 'info') {
      if (!statusLog || !message) return;
      const entry = document.createElement('div');
      entry.className = `status-log__item${level === 'error' ? ' status-log__item--error' : ''}`;
      entry.textContent = message;
      statusLog.appendChild(entry);
      const maxEntries = 200;
      while (statusLog.children.length > maxEntries) {
        statusLog.removeChild(statusLog.firstChild);
      }
      statusLog.style.display = 'grid';
      statusLog.scrollTop = statusLog.scrollHeight;
    }

    function clearStatusLog() {
      if (!statusLog) return;
      statusLog.innerHTML = '';
      statusLog.style.display = 'none';
    }

    function setStatus(data) {
      if (statusEmpty) statusEmpty.style.display = 'none';
      if (statusDetails) statusDetails.style.display = 'grid';
      runStatusEl.textContent = statusLabel(data.status);
      if (window.runScraperEl === undefined) {
        window.runScraperEl = document.getElementById('run-scraper');
      }
      if (data.id) {
        appState.currentRunId = data.id;
        if (runIdEl) runIdEl.textContent = data.id;
      }
      if (runScraperEl) {
        const sm = data.scraper_mode || (data.mode === 'online' ? 'brightdata' : (data.mode === 'offline' ? 'cache' : 'decodo'));
        runScraperEl.textContent = sm || '—';
      }
      const processed = data.processed_products ?? 0;
      const total = data.total_products ?? 0;
      runProgressEl.textContent = `${processed}/${total}`;
      const pct = total > 0 ? Math.min(100, Math.round((processed / total) * 100)) : (data.status === 'completed' ? 100 : 0);
      progressBar.style.width = `${pct}%`;
      const errorFallback = data.status === 'canceled' ? t('analysis-canceled') : '';
      runErrorEl.textContent = data.error_message || errorFallback;
      if (runStage) {
        if (data.status === 'pending') runStage.textContent = 'Wysyłanie pliku…';
        else if (data.status === 'running') runStage.textContent = `Scraping… (${processed}/${total || '?'})`;
        else if (data.status === 'completed') runStage.textContent = 'Gotowe';
        else if (data.status === 'failed') runStage.textContent = 'Błąd analizy';
        else if (data.status === 'canceled') runStage.textContent = 'Anulowano';
      }
      setLastUpdated(data.updated_at || new Date().toISOString());
      setSpinner(data.status);
      const showDownload = data.status === 'completed';
      const showPreview = Boolean(data.id) && (data.status === 'completed' || data.status === 'failed' || data.status === 'canceled' || processed > 0);
      if (showDownload) {
        const href = `/api/v1/analysis/${data.id}/download`;
        downloadLink.href = href;
      }
      downloadLink.style.display = showDownload ? 'inline-flex' : 'none';
      if (previewBtn) {
        previewBtn.dataset.runId = data.id || '';
        previewBtn.style.display = showPreview ? 'inline-flex' : 'none';
      }
      const effectiveConfigEl = document.getElementById('effective-config');
      if (effectiveConfigEl) {
        const effective = data.effective_config || data.config || { runtime: data.runtime_summary || 'n/a' };
        const text = typeof effective === 'object' ? JSON.stringify(effective, null, 2) : String(effective);
        effectiveConfigEl.textContent = text || '—';
      }
      reportLinks.style.display = showDownload || showPreview ? 'flex' : 'none';
      const canCancel = data.status === 'pending' || data.status === 'running';
      statusActions.style.display = canCancel ? 'flex' : 'none';
      if (cancelRunBtn) cancelRunBtn.dataset.runId = data.id || '';
      if (statusGoResultsBtn) {
        statusGoResultsBtn.disabled = !(data.id && data.status === 'completed');
      }
      window.location.hash = `#step=${activeStep}`;
      // quick summary pill updates
      const fileLabel = fileInput?.files?.[0]?.name || '—';
      const categoryLabel = categorySelect?.selectedOptions?.[0]?.textContent || '—';
      const effectiveMode = data.scrape_mode || data.mode || form.querySelector('input[name="mode"]:checked')?.value;
      const modeLabelText = modeLabel(effectiveMode);
      const summaryCategoryEl = document.getElementById('summary-category');
      const summaryFileEl = document.getElementById('summary-file');
      const summaryModePillEl = document.getElementById('summary-mode-pill');
      if (summaryCategoryEl) summaryCategoryEl.innerText = categoryLabel;
      if (summaryFileEl) summaryFileEl.innerText = fileLabel;
      if (summaryModePillEl) summaryModePillEl.innerText = modeLabelText;
      updateCtas();
      updateStatusState(data);
    }

    function updateStatusState(payload) {
      const status = (payload?.status || '').toLowerCase();
      const hasRun = Boolean(payload?.id);
      const done = status === 'completed';
      const finished = status === 'completed' || status === 'failed' || status === 'canceled';
      const running = status === 'pending' || status === 'running';
      if (statusEmpty) statusEmpty.style.display = hasRun ? 'none' : 'block';
      if (statusDetails) statusDetails.style.display = hasRun ? 'grid' : 'none';
      if (statusActions) statusActions.style.display = hasRun ? 'flex' : 'none';
      if (cancelRunBtn) cancelRunBtn.style.display = running ? 'inline-flex' : 'none';
      if (statusGoResultsBtn) statusGoResultsBtn.style.display = hasRun ? 'inline-flex' : 'none';
      if (statusNewRunBtn) statusNewRunBtn.style.display = finished ? 'inline-flex' : 'none';
      if (statusGoResultsBtn) statusGoResultsBtn.disabled = !(payload?.id && done);
      if (exportXlsxBtn) exportXlsxBtn.disabled = !(payload?.id && done);
      if (exportCsvBtn) exportCsvBtn.disabled = !(payload?.id && done);
      if (copyReportLinkBtn) copyReportLinkBtn.disabled = !(payload?.id && done);
      if (resultsSection) resultsSection.hidden = !hasRun;
      if (historySection) historySection.hidden = !hasRun;
    }

    function stopPolling() {
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = null;
    }

    function stopResultsPolling() {
      if (resultsPollTimer) clearInterval(resultsPollTimer);
      resultsPollTimer = null;
    }

    function stopRunStream() {
      if (runStream) {
        runStream.close();
      }
      runStream = null;
      runStreamState = { runId: null, since: null, sinceId: null, lastStatus: null };
      appState.isStarting = false;
    }

    function stopAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = null;
    }

    function isEditingMarketFilters() {
      const active = document.activeElement;
      if (!active || !active.closest) return false;
      return Boolean(active.closest('.market-filters'));
    }

    async function runAutoRefresh() {
      if (refreshInFlight) return;
      refreshInFlight = true;
      const tasks = [];
      if (historyExpanded) tasks.push(loadHistory());
      if (opsBody && !opsBody.classList.contains('is-hidden')) tasks.push(loadActiveRuns());
      if (currencyBody && !currencyBody.classList.contains('is-hidden')) tasks.push(loadCurrencyRates());
      if (!isEditingMarketFilters()) tasks.push(loadMarketData(marketState.offset, true));
      await Promise.allSettled(tasks);
      refreshInFlight = false;
    }

    function startAutoRefresh(intervalMs = 5000) {
      stopAutoRefresh();
      refreshTimer = setInterval(runAutoRefresh, intervalMs);
    }

    async function refreshScraperStatus() {
      if (!scraperStatus || !scraperStatusText) return;
      try {
        const res = await fetch('/api/v1/status');
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const mode = (data.scraper_mode || data?.brightdata?.mode || 'unknown').toLowerCase();
        const metrics = data?.brightdata?.metrics || {};
        const successPct = metrics.success_rate ? Math.round(metrics.success_rate * 1000) / 10 : 0;
        const captchaPct = metrics.captcha_rate ? Math.round(metrics.captcha_rate * 1000) / 10 : 0;
        scraperStatus.classList.remove('error');
        scraperStatusText.textContent = `Mode: ${mode} · success ${successPct}% · captcha ${captchaPct}%`;
        backendAlert.style.display = 'none';
      } catch (err) {
        scraperStatus.classList.add('error');
        scraperStatusText.textContent = currentLang === 'en' ? 'Backend unreachable' : 'Backend niedostępny';
        if (backendAlert) backendAlert.style.display = 'block';
      }
    }

    function updateResultsMetaFromStatus(payload) {
      if (!previewState.runId || !resultsMeta) return;
      if (String(previewState.runId) !== String(payload.id)) return;
      previewState.total = payload.total_products ?? previewState.total;
      const metaParts = [`Run #${payload.id}`, `${t('label-status')} ${statusLabel(payload.status)}`];
      if (typeof previewState.total === 'number') {
        const rowsLabel = currentLang === 'en' ? 'Rows' : 'Wiersze';
        metaParts.push(`${rowsLabel}: ${previewState.total}`);
      }
      resultsMeta.textContent = metaParts.join(' · ');
      if (resultsPageInfo && typeof previewState.total === 'number') {
        const start = previewState.total ? Math.min(previewState.total, previewState.offset + 1) : 0;
        const end = previewState.total ? Math.min(previewState.total, previewState.offset + previewState.limit) : 0;
        if (previewState.total) {
          resultsPageInfo.textContent = currentLang === 'en'
            ? `${start}-${end} of ${previewState.total}`
            : `${start}-${end} z ${previewState.total}`;
        } else {
          resultsPageInfo.textContent = '';
        }
      }
      if (payload.status === 'canceled') {
        resultsBanner.textContent = payload.error_message || t('analysis-canceled');
        resultsBanner.style.display = 'block';
      } else if (payload.status === 'failed') {
        resultsBanner.textContent = payload.error_message || t('analysis-failed');
        resultsBanner.style.display = 'block';
      } else {
        resultsBanner.textContent = '';
        resultsBanner.style.display = 'none';
      }
    }

    function handleStreamRow(item) {
      if (!item || !item.id) return;
      const showInTable = resultsModal.style.display === 'flex'
        && String(previewState.runId || '') === String(runStreamState.runId || '');

      if (showInTable) {
        const rowNumber = Number(item.row_number || 0);
        const start = previewState.offset + 1;
        const end = previewState.offset + previewState.limit;
        if (rowNumber && (rowNumber < start || rowNumber > end)) {
          return;
        }
        resultsEmpty.style.display = 'none';
        upsertResultsRow(item);
      }

      if (
        item.scrape_status === 'error'
        || item.scrape_status === 'network_error'
        || item.scrape_status === 'blocked'
        || item.scrape_error_message
      ) {
        const message = item.scrape_error_message
          ? `EAN ${item.ean}: ${item.scrape_error_message}`
          : `EAN ${item.ean}: ${scrapeStatusLabel(item.scrape_status)}`;
        appendStatusLog(message, 'error');
      }
    }

    async function fetchResultsUpdates(runId) {
      if (!runId) return;
      const params = new URLSearchParams();
      if (runStreamState.since) params.set('since', runStreamState.since);
      if (runStreamState.sinceId) params.set('since_id', runStreamState.sinceId);
      try {
        const res = await fetch(`/api/v1/analysis/${runId}/results/updates?${params.toString()}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(formatHttpError(res, data, t('error-fetch-results')));
        }
        if (data.next_since) {
          runStreamState.since = data.next_since;
        } else if (!runStreamState.since) {
          runStreamState.since = new Date().toISOString();
        }
        if (data.next_since_id) {
          runStreamState.sinceId = data.next_since_id;
        } else if (!runStreamState.sinceId && runStreamState.since) {
          runStreamState.sinceId = 0;
        }
        (data.items || []).forEach(handleStreamRow);
      } catch (err) {
        appendStatusLog(formatNetworkError(err, t('error-refresh-results')), 'error');
      }
    }

    function startResultsPolling(runId) {
      stopResultsPolling();
      resultsPollTimer = setInterval(() => {
        fetchResultsUpdates(runId);
      }, 3000);
    }

    function startFallbackPolling(runId) {
      stopRunStream();
      runStreamState = { runId, since: null, sinceId: null, lastStatus: null };
      pollStatus(runId);
      startResultsPolling(runId);
    }

    function startRunStream(runId) {
      if (!runId) return;
      stopStatusUpdates();
      clearStatusLog();
      runStreamState = { runId, since: null, sinceId: null, lastStatus: null };

      if (!window.EventSource) {
        startFallbackPolling(runId);
        return;
      }

      runStream = new EventSource(`/api/v1/analysis/${runId}/stream`);
      runStream.addEventListener('status', (event) => {
        const data = JSON.parse(event.data);
        setStatus(data);
        updateResultsMetaFromStatus(data);
        if (data.error_message) appendStatusLog(data.error_message, 'error');
        if (runStreamState.lastStatus !== data.status) {
          appendStatusLog(`Status: ${statusLabel(data.status)}`);
          runStreamState.lastStatus = data.status;
        }
      });
      runStream.addEventListener('progress', (event) => {
        const data = JSON.parse(event.data);
        setStatus(data);
        updateResultsMetaFromStatus(data);
      });
      runStream.addEventListener('row', (event) => {
        const data = JSON.parse(event.data);
        handleStreamRow(data);
      });
      runStream.addEventListener('error', (event) => {
        if (!event.data) return;
        try {
          const payload = JSON.parse(event.data);
          appendStatusLog(payload.message || t('error-analysis'), 'error');
        } catch (err) {
          appendStatusLog(t('error-analysis'), 'error');
        }
      });
      runStream.addEventListener('done', async (event) => {
        const data = JSON.parse(event.data);
        setStatus(data);
        updateResultsMetaFromStatus(data);
        stopRunStream();
        stopResultsPolling();
        await loadHistory();
        await loadActiveRuns();
      });
      runStream.onerror = () => {
        if (runStream && runStream.readyState === EventSource.CLOSED) {
          startFallbackPolling(runId);
        }
      };
    }

    async function pollStatus(runId) {
      stopPolling();
      const fetchStatus = async () => {
        try {
          const res = await fetch(`/api/v1/analysis/${runId}`);
          if (!res.ok) throw new Error(t('error-status'));
          const data = await res.json();
          setStatus(data);
          updateResultsMetaFromStatus(data);
          if (runStreamState.lastStatus !== data.status) {
            appendStatusLog(`${t('label-status')} ${statusLabel(data.status)}`);
            runStreamState.lastStatus = data.status;
          }

          if (data.status === 'completed' || data.status === 'failed' || data.status === 'canceled') {
            if (data.status === 'failed') {
              runErrorEl.textContent = data.error_message || t('analysis-failed-generic');
            }
            if (data.status === 'canceled') {
              runErrorEl.textContent = data.error_message || t('analysis-canceled');
            }
            stopPolling();
            stopResultsPolling();
            await loadHistory();
            await loadActiveRuns();
          }
        } catch (err) {
          setMessage(formatNetworkError(err, t('error-status')), errorBox);
        }
      };
      await fetchStatus();
      pollTimer = setInterval(fetchStatus, 3000);
    }

    async function loadSettings() {
      try {
        const res = await fetch('/api/v1/settings/');
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(formatHttpError(res, data, t('error-fetch-settings')));
        }
        settingsDefaults = {
          ...DEFAULT_SETTINGS,
          cache_ttl_days: data.cache_ttl_days ?? DEFAULT_SETTINGS.cache_ttl_days,
        };
        if (cacheTtlInput) cacheTtlInput.value = settingsDefaults.cache_ttl_days;
        if (cacheTtlRange) cacheTtlRange.value = settingsDefaults.cache_ttl_days;
        setMessage('', settingsInfo);
        applyDefaults();
      } catch (err) {
        if (cacheTtlInput) cacheTtlInput.value = cacheTtlInput.value || DEFAULT_SETTINGS.cache_ttl_days;
        if (cacheTtlRange && cacheTtlInput) cacheTtlRange.value = cacheTtlInput.value;
        settingsDefaults = {
          ...DEFAULT_SETTINGS,
          cache_ttl_days: Number(cacheTtlInput?.value) || DEFAULT_SETTINGS.cache_ttl_days,
        };
        setMessage(
          formatNetworkError(err, t('error-fetch-settings-fallback')),
          settingsInfo,
        );
        applyDefaults();
      }
    }

    async function saveSettings(field) {
      setMessage('', settingsError);
      const payload = {
        cache_ttl_days: Number(cacheTtlInput.value) || settingsDefaults.cache_ttl_days,
      };
      try {
        const res = await fetch('/api/v1/settings/', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setMessage(formatHttpError(res, data, t('error-save-settings')), settingsError);
          return;
        }
        cacheTtlInput.value = data.cache_ttl_days;
        settingsDefaults.cache_ttl_days = data.cache_ttl_days;
        if (field === 'ttl') briefSuccess(settingsInfo);
      } catch (err) {
        setMessage(formatNetworkError(err, t('error-save-settings-network')), settingsError);
      }
    }

    function createHistoryEntry(run) {
      const entry = document.createElement('div');
      entry.className = 'history-entry';
      const row = document.createElement('div');
      row.className = 'history-row';

      const created = formatDateTime(run.created_at || run.started_at);
      const finished = formatDateTime(run.finished_at);
      const modeText = modeLabel(run.mode);
      const finishedLabel = finished !== '-' ? finished : t('summary-pending');
      const statusBadge = `<span class="badge ${run.status}">${statusLabel(run.status)}</span>`;
      const downloadLink = run.status === 'completed'
        ? `/api/v1/analysis/${run.id}/download`
        : '';

      row.innerHTML = `
        <div><strong>${created}</strong><small>${finishedLabel}</small></div>
        <div><strong>${run.category_name || t('category-removed')}</strong><small>${t('summary-mode')} ${modeText}</small></div>
        <div><small>${t('summary-strategies')}</small> ${renderStrategies(run)}</div>
        <div><small>${t('summary-progress')}</small> ${run.processed_products}/${run.total_products}</div>
        <div class="history-actions">
          ${statusBadge}
          <div class="history-buttons"></div>
          <div class="history-ops"></div>
        </div>
      `;

      const actionsEl = row.querySelector('.history-actions');
      if (actionsEl) {
        const buttonsEl = actionsEl.querySelector('.history-buttons');
        const previewButton = document.createElement('button');
        previewButton.type = 'button';
        previewButton.className = 'action-btn';
        previewButton.textContent = t('btn-preview');
        previewButton.addEventListener('click', (e) => {
          e.stopPropagation();
          setCurrentRun(run.id).then(() => openResultsModal(run.id));
        });
        if (buttonsEl) {
          buttonsEl.appendChild(previewButton);
          if (downloadLink) {
            const downloadBtn = document.createElement('a');
            downloadBtn.className = 'action-btn secondary';
            downloadBtn.href = downloadLink;
            downloadBtn.textContent = t('btn-download');
            buttonsEl.appendChild(downloadBtn);
          }
        }

        const ops = actionsEl.querySelector('.history-ops');
        const menuItems = [];
        if (run.status !== 'canceled') {
          menuItems.push(`<button type="button" data-op="retry-local">${t('retry-local')}</button>`);
        }
        if (run.status === 'pending' || run.status === 'running') {
          menuItems.push(`<button type="button" data-op="cancel" class="danger">${t('btn-cancel')}</button>`);
        }
        if (ops && menuItems.length) {
          ops.innerHTML = `
            <button type="button" class="ghost-btn ghost-btn--small">${t('history-ops')}</button>
            <div class="history-ops-menu">${menuItems.join('')}</div>
          `;

          const opsButton = ops.querySelector('button');
          const menu = ops.querySelector('.history-ops-menu');
          opsButton.addEventListener('click', (e) => {
            e.stopPropagation();
            ops.classList.toggle('open');
          });
          menu.addEventListener('click', (e) => {
            e.stopPropagation();
            const action = e.target.getAttribute('data-op');
            if (action === 'cancel') {
              if (run.status === 'pending' || run.status === 'running') {
                cancelRun(run.id);
              }
            }
            if (action === 'retry-local') {
              if (run.status !== 'canceled') retryFailed(run.id, 'local');
            }
            ops.classList.remove('open');
          });
        } else if (ops) {
          ops.remove();
        }
      }

      const detail = document.createElement('div');
      detail.className = 'history-detail';
      const detailItems = [
        [t('summary-id'), String(run.id)],
        [t('summary-created'), created],
        [t('summary-finished'), finished !== '-' ? finished : '—'],
        [t('summary-progress'), `${run.processed_products}/${run.total_products}`],
      ];
      if (run.canceled_at) {
        detailItems.push([t('summary-canceled-at'), formatDateTime(run.canceled_at)]);
      }
      detailItems.forEach(([label, value]) => {
        const rowEl = document.createElement('div');
        const strong = document.createElement('strong');
        strong.textContent = label;
        rowEl.appendChild(strong);
        rowEl.append(` ${value}`);
        detail.appendChild(rowEl);
      });
      if (run.status === 'failed') {
        const errorLine = document.createElement('div');
        errorLine.className = 'history-error-line';
        const strong = document.createElement('strong');
        strong.textContent = t('error-reason');
        errorLine.appendChild(strong);
        errorLine.append(` ${run.error_message || t('no-details')}`);
        detail.appendChild(errorLine);
      }
      if (run.status === 'canceled') {
        const cancelLine = document.createElement('div');
        cancelLine.className = 'history-error-line';
        const strong = document.createElement('strong');
        strong.textContent = t('cancel-reason');
        cancelLine.appendChild(strong);
        cancelLine.append(` ${run.error_message || t('no-details')}`);
        detail.appendChild(cancelLine);
      }

      row.addEventListener('click', (e) => {
        if (e.target.closest && e.target.closest('a, button')) {
          return;
        }
        setCurrentRun(run.id);
        const expanded = detail.style.display === 'block';
        detail.style.display = expanded ? 'none' : 'block';
      });

      entry.appendChild(row);
      entry.appendChild(detail);
      return entry;
    }

    async function loadHistory() {
      historyList.innerHTML = '';
      historyEmpty.style.display = 'none';
      historyError.style.display = 'none';

      try {
        const res = await fetch('/api/v1/analysis');
        const data = await res.json().catch(() => ([]));
        if (!res.ok) {
          throw new Error(formatHttpError(res, data, t('error-fetch-history')));
        }
        if (!Array.isArray(data) || !data.length) {
          historyList.style.display = 'none';
          if (historyExpanded) {
            historyEmpty.textContent = t('history-empty-text');
            historyEmpty.style.display = 'block';
          }
          return;
        }

        data.forEach(run => {
          historyList.appendChild(createHistoryEntry(run));
        });

        historyList.style.display = historyExpanded ? 'grid' : 'none';
      } catch (err) {
        historyList.innerHTML = '';
        historyList.style.display = 'none';
        if (historyExpanded) {
          historyError.textContent = formatNetworkError(err, t('error-fetch-history-network'));
          historyError.style.display = 'block';
        }
      }
    }

    function getStrategyFlags() { return {}; }

    async function startFromDb(fromMain = false) {
      setMessage('', errorBox);
      setMessage('', dbError);
      setMessage('', strategyError);
      downloadLink.style.display = 'none';

      if (!validateStrategies()) {
        if (fromMain) setStartUi(false);
        return;
      }
      if (!categorySelect.value) {
        setMessage(t('error-db-select-category'), dbError);
        if (fromMain) setStartUi(false);
        return;
      }

      const mode = form.querySelector('input[name="mode"]:checked')?.value || 'mixed';
      const cacheDays = Number(dbLastDaysInput.value) || settingsDefaults.db_last_days;
      const limitValue = Number(dbLimitInput.value);
      const limit = Number.isFinite(limitValue) && limitValue > 0 ? limitValue : null;
      const payload = {
        category_id: categorySelect.value,
        mode,
        scrape_mode: mode,
        cache_days: cacheDays,
        limit,
        source: dbSourceInput?.value || 'any',
        ean_contains: (dbEanContainsInput?.value || '').trim() || null,
      };

      if (startDbBtn && !fromMain) {
        startDbBtn.disabled = true;
        startDbBtn.textContent = t('btn-starting-db');
      }
      submitBtn.disabled = true;
      lockInputs(true);
      if (fromMain) setStartUi(true, 'Tworzę run (offline)…');

      try {
        const res = await fetch('/api/v1/analysis/run_from_cache', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const msg = formatHttpError(res, data, t('error-run-db-start'));
          const catName = categorySelect?.selectedOptions?.[0]?.textContent || categorySelect.value || '';
          const noData = res.status === 404 || String(msg).toLowerCase().includes('no data') || String(msg).toLowerCase().includes('brak');
          const friendly = noData ? `Brak danych w bazie dla kategorii ${catName || ''}`.trim() : msg;
          setMessage(friendly, dbError);
          if (noData) {
            dbError.innerHTML += ' <button class="ghost-btn" id="db-back-btn" type="button">Wróć do danych wejściowych</button>';
            const backBtn = document.getElementById('db-back-btn');
            if (backBtn) backBtn.addEventListener('click', () => document.getElementById('input-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' }));
          }
          return;
        }
        if (runIdEl) runIdEl.textContent = data.analysis_run_id;
        if (fromMain) setStartUi(true, `Run: ${data.analysis_run_id}`);
        setStatus({ id: data.analysis_run_id, status: data.status, processed_products: 0, total_products: 0, error_message: '' });
        scrollToStatusSection();
        focusStatusHeading();
        startRunStream(data.analysis_run_id);
        await loadHistory();
        await loadActiveRuns();
      } catch (err) {
        setMessage(formatNetworkError(err, t('error-analysis')), dbError);
      } finally {
        if (startDbBtn && !fromMain) {
          startDbBtn.disabled = false;
          startDbBtn.textContent = t('btn-start-db');
        }
        if (fromMain) setStartUi(false);
        lockInputs(false);
        updateStartState();
      }
    }

    async function cancelRun(runId) {
      if (!runId) return;
      cancelRunBtn.disabled = true;
      if (runStage) runStage.textContent = 'Anulowanie…';
      setSpinner('running');
      try {
        const res = await fetch(`/api/v1/analysis/${runId}/cancel`, { method: 'POST' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setMessage(formatHttpError(res, data, t('error-run-cancel')), errorBox);
          cancelRunBtn.disabled = false;
          if (runStage) runStage.textContent = 'Bieżąca analiza';
          return;
        }
        const isCurrent = String(runId) === String(appState.currentRunId);
        if (isCurrent) {
          setStatus(data);
          stopPolling();
          stopResultsPolling();
          stopRunStream();
        }
        await loadHistory();
        await loadActiveRuns();
      } catch (err) {
        setMessage(formatNetworkError(err, t('error-run-cancel-network')), errorBox);
        cancelRunBtn.disabled = false;
        if (runStage) runStage.textContent = 'Bieżąca analiza';
      } finally {
        setSpinner(null);
      }
    }

    async function retryFailed(runId, strategy) {
      if (!runId) return;
      historyError.textContent = '';
      try {
        const res = await fetch(`/api/v1/analysis/${runId}/retry_failed?strategy=${strategy}`, { method: 'POST' });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          historyError.textContent = formatHttpError(res, data, t('error-retry'));
          return;
        }
        await loadHistory();
        if (Number(runId) === Number(appState.currentRunId)) {
          startRunStream(runId);
        }
      } catch (err) {
        historyError.textContent = formatNetworkError(err, t('error-retry-network'));
      }
    }

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      startAnalysis();
    });
    if (submitBtn) {
      submitBtn.addEventListener('click', (e) => {
        e.preventDefault();
        startAnalysis();
      });
    }

    const strategyBoxes = document.getElementById('strategy-boxes');
    if (strategyBoxes) strategyBoxes.addEventListener('change', validateStrategies);
    form.querySelectorAll('input[name="mode"]').forEach((input) => {
      input.addEventListener('change', () => {
        updateStrategiesForMode();
        updateStartState();
      });
    });
    fileInput.addEventListener('change', updateStartState);
    categorySelect.addEventListener('change', updateStartState);
    if (advancedToggle) {
      advancedToggle.addEventListener('click', () => {
        const willShow = settingsDetails ? !settingsDetails.open : true;
        setAdvancedVisible(willShow);
      });
      const stored = localStorage.getItem('ui.advancedPanel');
      setAdvancedVisible(stored === '1');
    }
    form.addEventListener('change', updateSettingsSummary);
    if (cacheTtlInput) cacheTtlInput.addEventListener('input', () => {
      if (cacheTtlRange) cacheTtlRange.value = cacheTtlInput.value;
      updateSettingsSummary();
    });
    if (cacheTtlRange) cacheTtlRange.addEventListener('input', (e) => {
      if (cacheTtlInput) cacheTtlInput.value = e.target.value;
      updateSettingsSummary();
    });
    if (saveTtlBtn) {
      saveTtlBtn.addEventListener('click', async () => {
        if (!cacheTtlInput.value) cacheTtlInput.value = settingsDefaults.cache_ttl_days;
        await saveSettings('ttl');
      });
    }
    if (offerLimitInput) offerLimitInput.addEventListener('input', updateSettingsSummary);
      if (resetBtn) {
        resetBtn.addEventListener('click', () => {
          form.reset();
          applyDefaults();
          updateStartState();
          if (settingsSummary) settingsSummary.textContent = '';
        });
      }
    initSettingsTabs();
    initTablePreferences();
    if (startDbBtn) startDbBtn.addEventListener('click', startFromDb);
    cancelRunBtn.addEventListener('click', () => {
      const runId = appState.currentRunId;
      if (runId) cancelRun(runId);
    });
    const goToInput = () => {
      stopStatusUpdates();
      appState.currentRunId = null;
      clearStatusLog();
      updateStatusState(null);
      document.getElementById('input-card')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      categorySelect?.focus({ preventScroll: true });
    };
    if (statusStartBtn) statusStartBtn.addEventListener('click', goToInput);
    if (statusNewRunBtn) statusNewRunBtn.addEventListener('click', goToInput);
    if (runIdEl) {
      runIdEl.addEventListener('click', () => {
        const text = appState.currentRunId ? String(appState.currentRunId) : (runIdEl.textContent || '').trim();
        if (text) navigator.clipboard.writeText(text).catch(() => {});
      });
    }
    updateStrategiesForMode();
    updateStartState();

    if (previewBtn) {
      previewBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const runId = appState.currentRunId;
        if (runId) openResultsModal(runId);
      });
    }
    if (resultsClose) resultsClose.addEventListener('click', closeResultsModal);
    if (resultsModal) resultsModal.addEventListener('click', (e) => { if (e.target === resultsModal) closeResultsModal(); });
    if (resultsPrev) resultsPrev.addEventListener('click', () => {
      if (!previewState.runId) return;
      const nextOffset = Math.max(0, previewState.offset - previewState.limit);
      loadResults(previewState.runId, nextOffset);
    });
    if (resultsNext) resultsNext.addEventListener('click', () => {
      if (!previewState.runId) return;
      const nextOffset = previewState.offset + previewState.limit;
      if (nextOffset < (previewState.total || 0)) {
        loadResults(previewState.runId, nextOffset);
      }
    });
    if (resultsBackBtn) {
      resultsBackBtn.addEventListener('click', () => {
        scrollToStatusSection();
        focusStatusHeading();
      });
    }

    if (resultsSearch) {
      resultsSearch.addEventListener('input', (e) => {
        resultsFilters.search = e.target.value;
        applyResultsFiltersAndSort();
      });
    }
    function toggleChip(chip, key) {
      chip.classList.toggle('is-active');
      resultsFilters[key] = chip.classList.contains('is-active');
      applyResultsFiltersAndSort();
    }
    if (chipProfitable) chipProfitable.addEventListener('click', () => toggleChip(chipProfitable, 'profitable'));
    if (chipErrors) chipErrors.addEventListener('click', () => toggleChip(chipErrors, 'errors'));
    if (chipMissing) chipMissing.addEventListener('click', () => toggleChip(chipMissing, 'missingPrice'));
    if (copyFailedBtn) copyFailedBtn.addEventListener('click', () => {
      const tbody = resultsTable.querySelector('tbody');
      if (!tbody) return;
      const failed = Array.from(tbody.querySelectorAll('tr[data-id]')).filter((row) => row.dataset.scrapeStatus !== 'ok');
      const eans = failed.map((row) => row.dataset.ean).filter(Boolean);
      if (!eans.length) {
        alert('Brak nieudanych EANów.');
        return;
      }
      navigator.clipboard.writeText(eans.join('\n'));
      copyFailedBtn.textContent = 'Skopiowano';
      setTimeout(() => (copyFailedBtn.textContent = 'Kopiuj EAN-y nieudane'), 1200);
    });
    marketSearch.addEventListener('click', () => {
      marketState.offset = 0;
      loadMarketData(0);
    });
    marketReset.addEventListener('click', () => {
      marketCategory.value = '';
      marketEan.value = '';
      marketSource.value = '';
      marketDate.value = '';
      marketState.offset = 0;
      loadMarketData(0);
    });
    marketPrev.addEventListener('click', () => {
      const nextOffset = Math.max(0, marketState.offset - marketState.limit);
      marketState.offset = nextOffset;
      loadMarketData(nextOffset);
    });
    marketNext.addEventListener('click', () => {
      const nextOffset = marketState.offset + marketState.limit;
      if (nextOffset < (marketState.total || 0)) {
        marketState.offset = nextOffset;
        loadMarketData(nextOffset);
      }
    });

    document.addEventListener('click', (e) => {
      document.querySelectorAll('.history-ops.open').forEach((menu) => {
        if (!menu.contains(e.target)) {
          menu.classList.remove('open');
        }
      });
    });

    if (addCurrencyBtn) {
      addCurrencyBtn.addEventListener('click', () => {
        const payload = readCurrencyPayload();
        payload.push({ currency: '', rate_to_pln: 0, is_default: false });
        renderCurrencyRows(payload);
      });
    }
    if (currencyList) {
      currencyList.addEventListener('click', (e) => {
        if (e.target.dataset.remove !== undefined) {
          const idx = Number(e.target.dataset.remove);
          const payload = readCurrencyPayload().filter((_, i) => i !== idx);
          renderCurrencyRows(payload);
        }
        if (e.target.dataset.default !== undefined) {
          const idx = Number(e.target.dataset.default);
          const payload = readCurrencyPayload().map((p, i) => ({ ...p, is_default: i === idx }));
          renderCurrencyRows(payload);
        }
      });
    } else {
      console.warn('UI wiring: missing #currency-list');
    }
    if (saveCurrenciesBtn) {
      saveCurrenciesBtn.addEventListener('click', saveCurrencyRates);
    }

    const hasCategoryModal = categoryModal && categoryModalForm && categoryModalError && categorySuccess && categoryCancel;
    if (hasCategoryModal) {
      function openCategoryModal() {
        categoryModal.style.display = 'flex';
        categoryModalError.textContent = '';
        categoryModalForm.reset();
      }
      if (addCategoryBtn) addCategoryBtn.addEventListener('click', openCategoryModal);
      const mainAddCategory = document.getElementById('main-add-category');
      if (mainAddCategory) mainAddCategory.addEventListener('click', openCategoryModal);
      categoryCancel.addEventListener('click', () => {
        categoryModal.style.display = 'none';
      });
      categoryModal.addEventListener('click', (e) => {
        if (e.target === categoryModal) categoryModal.style.display = 'none';
      });
      categoryModalForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        setMessage('', categoryModalError);
        setMessage('', categorySuccess);
        const payload = {
          name: document.getElementById('modal-cat-name').value,
          profitability_multiplier: Number(document.getElementById('modal-cat-multiplier').value || 0),
          commission_rate: (Number(document.getElementById('modal-cat-commission').value || 0) / 100),
        };
        try {
          const res = await fetch('/api/v1/categories/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            setMessage(formatHttpError(res, data, t('error-add-category')), categoryModalError);
            return;
          }
          categoryModal.style.display = 'none';
          setMessage(t('category-added'), categorySuccess);
          await loadCategories();
        } catch (err) {
          setMessage(formatNetworkError(err, t('error-add-category-network')), categoryModalError);
        }
      });
    } else {
      console.warn('UI wiring: category modal bindings skipped');
    }

    const hasCategoryDetail = categoryDetailModal && categoryDetailForm && categoryDetailError && categoryDetailSuccess && categoryDetailCancel;

    async function openCategoryDetail(id) {
      if (!hasCategoryDetail) {
        console.warn('UI wiring: category detail unavailable');
        return;
      }
      categoryDetailError.textContent = '';
      categoryDetailSuccess.textContent = '';
      categoryDetailId = id;
      try {
        const res = await fetch(`/api/v1/categories/${id}`);
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(formatHttpError(res, data, t('error-fetch-categories')));
        document.getElementById('detail-cat-name').value = data.name || '';
        document.getElementById('detail-cat-multiplier').value = data.profitability_multiplier ?? '';
        document.getElementById('detail-cat-commission').value = data.commission_rate ? Number(data.commission_rate) * 100 : '';
        categoryDetailModal.style.display = 'flex';
      } catch (err) {
        categoryError.textContent = formatNetworkError(err, t('error-fetch-categories'));
      }
    }

    if (hasCategoryDetail) {
      categoryDetailCancel.addEventListener('click', () => {
        categoryDetailModal.style.display = 'none';
      });
      categoryDetailModal.addEventListener('click', (e) => {
        if (e.target === categoryDetailModal) categoryDetailModal.style.display = 'none';
      });
      categoryDetailForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        categoryDetailError.textContent = '';
        categoryDetailSuccess.textContent = '';
        if (!categoryDetailId) return;
        const payload = {
          name: document.getElementById('detail-cat-name').value,
          profitability_multiplier: Number(document.getElementById('detail-cat-multiplier').value || 0),
          commission_rate: (Number(document.getElementById('detail-cat-commission').value || 0) / 100),
        };
        try {
          const res = await fetch(`/api/v1/categories/${categoryDetailId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(formatHttpError(res, data, t('error-save-category')));
          categoryDetailSuccess.textContent = t('category-saved');
          await loadCategories();
        } catch (err) {
          categoryDetailError.textContent = formatNetworkError(err, t('error-save-category-network'));
        }
      });
    } else {
      console.warn('UI wiring: category detail bindings skipped');
    }

    if (langToggle) {
      langToggle.addEventListener('click', () => {
        setLanguage(currentLang === 'pl' ? 'en' : 'pl');
      });
    }
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        fetch('/logout').then(() => window.location.href = '/login');
      });
    }

    if (faqBtn && faqModal && faqClose) {
      faqBtn.addEventListener('click', () => { faqModal.style.display = 'flex'; });
      faqClose.addEventListener('click', () => { faqModal.style.display = 'none'; });
      faqModal.addEventListener('click', (e) => { if (e.target === faqModal) faqModal.style.display = 'none'; });
    }
    if (sidebar && sidebarToggle && sidebarRestore) {
      function collapseSidebar() {
        sidebar.classList.add('collapsed');
        layout.classList.add('sidebar-collapsed');
        sidebarRestore.style.display = 'block';
      }
      function expandSidebar() {
        sidebar.classList.remove('collapsed');
        layout.classList.remove('sidebar-collapsed');
        sidebarRestore.style.display = 'none';
      }
      sidebarToggle.addEventListener('click', () => {
        if (sidebar.classList.contains('collapsed')) {
          expandSidebar();
        } else {
          collapseSidebar();
        }
        sidebarToggle.textContent = sidebar.classList.contains('collapsed') ? '»' : '«';
      });
      sidebarRestore.addEventListener('click', () => {
        expandSidebar();
        sidebarToggle.textContent = '«';
      });
    }

    if (historyToggle && historyCaret && historyList && historyEmpty && historyError) {
      historyToggle.addEventListener('click', () => {
        historyExpanded = !historyExpanded;
        if (historyExpanded) {
          historyCaret.textContent = '▼';
          historyList.style.display = 'grid';
          loadHistory();
        } else {
          historyCaret.textContent = '▲';
          historyList.style.display = 'none';
          historyEmpty.style.display = 'none';
          historyError.style.display = 'none';
        }
      });
    }

    initDropzone();
    setLanguage(currentLang);
    const storedWidth = localStorage.getItem('ui.width') || 'comfort';
    applyWidthMode(storedWidth);
    if (widthToggle) {
      widthToggle.addEventListener('click', () => {
        const current = localStorage.getItem('ui.width') || 'comfort';
        applyWidthMode(current === 'wide' ? 'comfort' : 'wide');
      });
    }
    // start step from hash if provided
    const hashStep = window.location.hash.startsWith('#step=') ? window.location.hash.replace('#step=','') : null;
    setStep(STEPS.includes(hashStep) ? hashStep : 'import');
    validateWiring();
    updateCtas();
    updateStatusState(null);
    refreshScraperStatus();
    setInterval(refreshScraperStatus, 30000);
    loadCategories();
    loadSettings().then(updateSettingsSummary);
    loadCurrencyRates();
    startAutoRefresh(5000);
    loadMarketData();
  </script>
</body>
</html>
